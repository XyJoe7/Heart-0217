<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>XyJoe7 æ§åˆ¶å°</title>
  <link rel="stylesheet" href="/assets/style.css" />
  <link rel="stylesheet" href="/assets/pages.css" />
  <style>
    body{margin:0;display:flex;flex-direction:column;min-height:100vh}
    .admin-layout{display:flex;flex:1;overflow:hidden}
    .admin-sidebar{width:220px;background:rgba(255,255,255,.92);border-right:1px solid rgba(0,0,0,.08);overflow-y:auto;flex-shrink:0}
    .admin-main{flex:1;overflow-y:auto;background:linear-gradient(135deg,var(--bg1),var(--bg2))}
    .wrap{max-width:1180px;margin:0 auto;padding:24px 16px}
    .login-center{display:flex;justify-content:center;margin:8px 0 14px}
    .login-card{width:min(560px,100%);text-align:center}
    .grid{display:grid;grid-template-columns:1fr;gap:14px;max-width:1080px;margin:0 auto}
    @media (max-width:900px){.grid{grid-template-columns:1fr}}
    .card{border-radius:18px;border:1px solid rgba(0,0,0,.08);background:rgba(255,255,255,.88);padding:14px;margin-bottom:14px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    input,select{border-radius:12px;border:1px solid rgba(0,0,0,.12);padding:10px 12px;font-size:14px;outline:none;background:#fff}
    .form-select{width:100%}
    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid rgba(0,0,0,.08);padding:10px 8px;text-align:left;font-size:13px}
    th{font-size:12px;color:var(--muted);font-weight:800}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:999px;border:1px solid rgba(0,0,0,.10);font-size:12px;background:rgba(255,255,255,.8)}
    .danger{color:#b00020}
    .small{color:var(--muted)}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
    .disabled-area{opacity:.58;position:relative;pointer-events:none}
    .disabled-area::after{content:"ç™»å½•åå¯æ“ä½œ";position:absolute;right:12px;top:10px;font-size:12px;color:#7a2f56;background:#fff;border:1px solid rgba(0,0,0,.08);padding:3px 8px;border-radius:999px}
    
    /* Sidebar Menu Styles */
    .menu-category{padding:20px 16px 8px;font-size:11px;font-weight:800;color:var(--muted);text-transform:uppercase;letter-spacing:.5px}
    .menu-item{display:flex;align-items:center;gap:10px;padding:10px 16px;cursor:pointer;transition:.18s ease;text-decoration:none;color:var(--text);border-left:3px solid transparent}
    .menu-item:hover{background:rgba(124,131,253,.08)}
    .menu-item.active{background:linear-gradient(to right,rgba(124,131,253,.12),transparent);border-left-color:var(--primary);font-weight:700}
    .menu-item svg{width:18px;height:18px;flex-shrink:0}
    .menu-separator{height:1px;background:rgba(0,0,0,.06);margin:8px 16px}
    
    /* Content Sections */
    .content-section{display:none}
    .content-section.active{display:block}
    
    @media (max-width:768px){
      .admin-layout{flex-direction:column}
      .admin-sidebar{width:100%;border-right:0;border-bottom:1px solid rgba(0,0,0,.08);max-height:200px}
      .menu-category{padding:12px 16px 6px}
      .menu-item{padding:8px 16px}
    }
  </style>
</head>
<body>
  <header class="topbar">
    <div class="topbar-inner">
      <a class="brand" href="/"><span class="logo">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
          <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
        </svg>
      </span><span>ç®¡ç†æ§åˆ¶å°</span></a>
      <div class="topbar-actions">
        <button class="btn btn-ghost" id="logoutBtn" style="display:none">é€€å‡º</button>
      </div>
    </div>
  </header>

  <div id="authTip" class="card" style="margin:12px auto;max-width:1180px">
    <b>å®‰å…¨æç¤ºï¼š</b>ä½ å·²ç™»å½•ï¼Œå¯åœ¨ä¸‹æ–¹ç®¡ç†æ¿€æ´»ç ã€ç«™ç‚¹å±•ç¤ºå­—æ®µä¸ç»Ÿè®¡ä»£ç ã€‚
  </div>

  <div class="admin-layout" id="adminLayout" style="display:none">
    <!-- Left Sidebar Menu -->
    <aside class="admin-sidebar">
      <div class="menu-category">ä»ªè¡¨ç›˜</div>
      <a class="menu-item active" data-section="dashboard">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="3" y="3" width="7" height="7"></rect>
          <rect x="14" y="3" width="7" height="7"></rect>
          <rect x="14" y="14" width="7" height="7"></rect>
          <rect x="3" y="14" width="7" height="7"></rect>
        </svg>
        <span>æ•°æ®æ¦‚è§ˆ</span>
      </a>
      
      <div class="menu-separator"></div>
      <div class="menu-category">æ¿€æ´»ç ç®¡ç†</div>
      <a class="menu-item" data-section="codes">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
          <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
        </svg>
        <span>æ¿€æ´»ç åˆ—è¡¨</span>
      </a>
      
      <div class="menu-separator"></div>
      <div class="menu-category">å†…å®¹ç®¡ç†</div>
      <a class="menu-item" data-section="carousel">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="2" y="7" width="20" height="14" rx="2" ry="2"></rect>
          <path d="M16 3h2a2 2 0 0 1 2 2v2M8 3H6a2 2 0 0 0-2 2v2"></path>
        </svg>
        <span>è½®æ’­å›¾ç®¡ç†</span>
      </a>
      <a class="menu-item" data-section="featured">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon>
        </svg>
        <span>ç²¾é€‰å†…å®¹</span>
      </a>
      <a class="menu-item" data-section="tests">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
          <polyline points="14 2 14 8 20 8"></polyline>
          <line x1="16" y1="13" x2="8" y2="13"></line>
          <line x1="16" y1="17" x2="8" y2="17"></line>
          <polyline points="10 9 9 9 8 9"></polyline>
        </svg>
        <span>é‡è¡¨ç®¡ç†</span>
      </a>
      <a class="menu-item" data-section="categories">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="3" y="3" width="7" height="7"></rect>
          <rect x="14" y="3" width="7" height="7"></rect>
          <rect x="14" y="14" width="7" height="7"></rect>
          <rect x="3" y="14" width="7" height="7"></rect>
        </svg>
        <span>åˆ†ç±»ç®¡ç†</span>
      </a>
      
      <div class="menu-separator"></div>
      <div class="menu-category">ç³»ç»Ÿè®¾ç½®</div>
      <a class="menu-item" data-section="site">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="10"></circle>
          <line x1="2" y1="12" x2="22" y2="12"></line>
          <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path>
        </svg>
        <span>ç«™ç‚¹ä¿¡æ¯</span>
      </a>
      <a class="menu-item" data-section="seo">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="11" cy="11" r="8"></circle>
          <path d="m21 21-4.35-4.35"></path>
        </svg>
        <span>SEOè®¾ç½®</span>
      </a>
      
      <div class="menu-separator"></div>
      <div class="menu-category">è¿è¥åˆ†æ</div>
      <a class="menu-item" data-section="analytics">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="12" y1="20" x2="12" y2="10"></line>
          <line x1="18" y1="20" x2="18" y2="4"></line>
          <line x1="6" y1="20" x2="6" y2="16"></line>
        </svg>
        <span>æ•°æ®åˆ†æ</span>
      </a>
      <a class="menu-item" data-section="source">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
          <circle cx="12" cy="10" r="3"></circle>
        </svg>
        <span>æ¥æºè¿½è¸ª</span>
      </a>
      <a class="menu-item" data-section="referral">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
          <circle cx="9" cy="7" r="4"></circle>
          <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
          <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
        </svg>
        <span>åˆ†é”€ç®¡ç†</span>
      </a>
    </aside>

    <!-- Main Content Area -->
    <main class="admin-main">
      <div class="wrap">
        
        <!-- Dashboard Overview Section -->
        <div class="content-section active" id="section-dashboard">
          <section class="card">
            <h3 style="margin:0 0 10px">ğŸ“Š æ•°æ®æ¦‚è§ˆ</h3>
            <div class="small" id="stats"></div>
          </section>
        </div>

        <!-- Activation Codes Section -->
        <div class="content-section" id="section-codes">
          <section class="card" id="dashboardCard">
            <div class="row" style="justify-content:space-between">
              <div>
                <h3 style="margin:0 0 6px">æ¿€æ´»ç åˆ—è¡¨</h3>
              </div>
              <div class="row">
                <input id="q" placeholder="æœç´¢ code..." />
                <button class="btn btn-ghost" id="refreshBtn">åˆ·æ–°</button>
              </div>
            </div>

            <div style="overflow:auto;margin-top:10px">
              <table>
                <thead>
                  <tr>
                    <th>Code</th>
                    <th>çŠ¶æ€</th>
                    <th>ä½¿ç”¨</th>
                    <th>è¿‡æœŸ</th>
                    <th>æ¿€æ´»æœ‰æ•ˆæœŸ</th>
                    <th>å¤‡æ³¨</th>
                    <th>æ“ä½œ</th>
                  </tr>
                </thead>
                <tbody id="tbody"></tbody>
              </table>
            </div>
          </section>
          
          <section class="card" id="manageBox" style="margin-top:14px">
            <h3 style="margin:0 0 10px">æ‰¹é‡ç”Ÿæˆæ¿€æ´»ç </h3>
            <div class="row" style="gap:14px 10px">
              <label class="small" style="flex:1 1 120px">æ•°é‡<br/><input id="count" type="number" min="1" max="500" value="20" style="width:100%"/></label>
              <label class="small" style="flex:1 1 120px">å‰ç¼€<br/><input id="prefix" value="H" style="width:100%"/></label>
              <label class="small" style="flex:1 1 140px">æ¯ç å¯ç”¨æ¬¡æ•°<br/><input id="maxUses" type="number" min="1" value="1" style="width:100%"/></label>
              <label class="small" style="flex:1 1 140px">æ¿€æ´»åæœ‰æ•ˆå¤©æ•°<br/><input id="grantDays" type="number" min="1" value="3" style="width:100%"/></label>
            </div>
            <div class="row" style="gap:14px 10px;margin-top:10px">
              <label class="small" style="flex:1 1 220px">å¤‡æ³¨ï¼ˆå¯é€‰ï¼‰<br/><input id="note" style="width:100%" placeholder="å¦‚ï¼š2æœˆæ´»åŠ¨æ‰¹æ¬¡"/></label>
              <label class="small" style="flex:1 1 220px">ç æœ¬èº«è¿‡æœŸæ—¶é—´ï¼ˆå¯é€‰ï¼‰<br/><input id="expiresAt" type="datetime-local" style="width:100%"/></label>
            </div>
            <div class="row" style="margin-top:10px">
              <button class="btn btn-primary" id="createBtn">ç”Ÿæˆæ¿€æ´»ç </button>
              <button class="btn btn-ghost" id="destroyExpiredBtn">æ¸…ç†å·²è¿‡æœŸæ¿€æ´»ç </button>
            </div>
            <div id="createdBox" class="small" style="margin-top:10px"></div>
          </section>
        </div>

        <!-- Carousel Management Section -->
        <div class="content-section" id="section-carousel">
          <section class="card">
            <div class="row" style="justify-content:space-between">
              <h3 style="margin:0">ğŸï¸ è½®æ’­å›¾ç®¡ç†</h3>
              <div class="row">
                <button class="btn btn-primary" id="addCarouselBtn">æ·»åŠ è½®æ’­</button>
                <button class="btn btn-ghost" id="refreshCarouselBtn">åˆ·æ–°</button>
              </div>
            </div>
            <div id="carouselList" style="margin-top:14px"></div>
          </section>
        </div>

        <!-- Featured Content Section -->
        <div class="content-section" id="section-featured">
          <section class="card">
            <div class="row" style="justify-content:space-between">
              <h3 style="margin:0">â­ ç²¾é€‰å†…å®¹ç®¡ç†</h3>
              <button class="btn btn-ghost" id="refreshFeaturedBtn">åˆ·æ–°</button>
            </div>
            <div id="featuredContentList" style="margin-top:14px"></div>
          </section>
        </div>

        <!-- Tests Management Section -->
        <div class="content-section" id="section-tests">
          <section class="card">
            <div class="row" style="justify-content:space-between">
              <h3 style="margin:0">ğŸ“ é‡è¡¨ç®¡ç†</h3>
              <div class="row">
                <button class="btn btn-primary" id="addTestBtn">æ–°å¢é‡è¡¨</button>
                <button class="btn btn-ghost" id="importTestBtn">å¯¼å…¥é‡è¡¨</button>
                <button class="btn btn-ghost" id="refreshTestsBtn">åˆ·æ–°</button>
              </div>
            </div>
            <div style="overflow:auto;margin-top:10px">
              <table>
                <thead><tr><th>ID</th><th>æ ‡é¢˜</th><th>åˆ†ç±»</th><th>é¢˜æ•°</th><th>é¢„è®¡æ—¶é—´</th><th>æ“ä½œ</th></tr></thead>
                <tbody id="testsTbody"></tbody>
              </table>
            </div>
          </section>
        </div>

        <!-- Categories Management Section -->
        <div class="content-section" id="section-categories">
          <section class="card">
            <div class="row" style="justify-content:space-between">
              <h3 style="margin:0">ğŸ“ åˆ†ç±»ç®¡ç†</h3>
              <div class="row">
                <button class="btn btn-primary" id="addCategoryBtn">æ–°å¢åˆ†ç±»</button>
                <button class="btn btn-ghost" id="refreshCategoriesBtn">åˆ·æ–°</button>
              </div>
            </div>
            <div id="categoriesList" style="margin-top:14px"></div>
          </section>
        </div>

        <!-- Site Settings Section -->
        <div class="content-section" id="section-site">
          <section class="card">
            <h3 style="margin:0 0 10px">ğŸŒ ç«™ç‚¹ä¿¡æ¯è®¾ç½®</h3>
            <div class="row" style="gap:14px 10px">
              <label class="small" style="flex:1 1 220px">ç«™ç‚¹åç§°<br/><input id="siteName" style="width:100%"/></label>
              <label class="small" style="flex:1 1 220px">å‰¯æ ‡é¢˜<br/><input id="siteSub" style="width:100%"/></label>
            </div>
            <div class="row" style="gap:14px 10px;margin-top:10px">
              <label class="small" style="flex:1 1 220px">ICPå¤‡æ¡ˆå·<br/><input id="siteIcp" style="width:100%"/></label>
              <label class="small" style="flex:1 1 220px">ç»Ÿè®¡ä»£ç ï¼ˆå¯é€‰ï¼Œæ”¯æŒ script æˆ–çº¯æ–‡æœ¬ï¼‰<br/><textarea id="siteAnalytics" style="width:100%;min-height:88px;border-radius:12px;border:1px solid rgba(0,0,0,.12);padding:10px"></textarea></label>
            </div>
            <div class="row" style="margin-top:10px">
              <button class="btn btn-primary" id="saveSiteBtn">ä¿å­˜ç«™ç‚¹ä¿¡æ¯</button>
            </div>
          </section>
        </div>

        <!-- SEO Settings Section -->
        <div class="content-section" id="section-seo">
          <section class="card">
            <h3 style="margin:0 0 10px">ğŸ” SEO ä¼˜åŒ–è®¾ç½®</h3>
            <div class="row" style="gap:14px 10px">
              <label class="small" style="flex:1 1 220px">å…¨å±€æ ‡é¢˜ï¼ˆtitleï¼‰<br/><input id="seoTitle" style="width:100%"/></label>
              <label class="small" style="flex:1 1 220px">å…¨å±€æè¿°ï¼ˆdescriptionï¼‰<br/><textarea id="seoDesc" style="width:100%;min-height:60px;border-radius:12px;border:1px solid rgba(0,0,0,.12);padding:10px"></textarea></label>
            </div>
            <div class="row" style="gap:14px 10px;margin-top:10px">
              <label class="small" style="flex:1 1 220px">å…¨å±€å…³é”®è¯ï¼ˆkeywordsï¼‰<br/><input id="seoKeywords" style="width:100%"/></label>
              <label class="small" style="flex:1 1 220px">OG å›¾ç‰‡ URL<br/><input id="seoOgImage" style="width:100%"/></label>
            </div>
            <div class="row" style="gap:14px 10px;margin-top:10px">
              <label class="small" style="flex:1 1 220px">ç½‘ç«™åŸŸåï¼ˆå« https://ï¼‰<br/><input id="seoCanonical" style="width:100%" placeholder="https://example.com"/></label>
              <label class="small" style="flex:1 1 140px">Sitemap æ›´æ–°é¢‘ç‡<br/>
                <select id="seoFreq" style="width:100%;border-radius:12px;border:1px solid rgba(0,0,0,.12);padding:10px">
                  <option value="daily">æ¯å¤©</option>
                  <option value="weekly" selected>æ¯å‘¨</option>
                  <option value="monthly">æ¯æœˆ</option>
                </select>
              </label>
              <label class="small" style="flex:1 1 160px;display:flex;align-items:center;gap:8px;margin-top:18px">
                <input type="checkbox" id="seoAutoSitemap" checked/> è‡ªåŠ¨ç”Ÿæˆ sitemap.xml
              </label>
            </div>
            <div class="row" style="gap:14px 10px;margin-top:10px">
              <label class="small" style="flex:1">robots.txt é¢å¤–è§„åˆ™ï¼ˆå¯é€‰ï¼‰<br/><textarea id="seoRobotsExtra" style="width:100%;min-height:80px;border-radius:12px;border:1px solid rgba(0,0,0,.12);padding:10px;font-family:monospace" placeholder="ä¾‹ï¼š&#10;Disallow: /private/"></textarea></label>
            </div>
            <div class="row" style="margin-top:10px">
              <button class="btn btn-primary" id="saveSeoBtn">ä¿å­˜ SEO è®¾ç½®</button>
            </div>
          </section>
        </div>

        <!-- Analytics Section -->
        <div class="content-section" id="section-analytics">
          <section class="card">
            <h3 style="margin:0 0 10px">ğŸ“Š å®æ—¶è¿è¥æ•°æ®</h3>
            <div id="analyticsBody" class="small">åŠ è½½ä¸­â€¦</div>
          </section>
        </div>

        <!-- Source Tracking Section -->
        <div class="content-section" id="section-source">
          <section class="card">
            <h3 style="margin:0 0 10px">ğŸ“ ç”¨æˆ·æ¥æºè¿½è¸ª</h3>
            <div id="sourceBody" class="small">åŠ è½½ä¸­â€¦</div>
          </section>
        </div>

        <!-- Referral Management Section -->
        <div class="content-section" id="section-referral">
          <section class="card">
            <div class="row" style="justify-content:space-between">
              <h3 style="margin:0">ğŸ”— åˆ†é”€ç®¡ç†</h3>
              <button class="btn btn-ghost" id="refreshRefBtn">åˆ·æ–°</button>
            </div>
            <div class="row" style="gap:10px;margin-top:10px">
              <label class="small" style="flex:1">åˆ†é”€å‘˜åç§°<br/><input id="refName" style="width:100%" placeholder="ä¾‹: å¼ ä¸‰"/></label>
              <label class="small" style="flex:1">ä½£é‡‘æ¯”ä¾‹ (%)<br/><input id="refCommission" type="number" min="0" max="100" value="10" style="width:100%"/></label>
              <label class="small" style="flex:1">å¤‡æ³¨<br/><input id="refNote" style="width:100%"/></label>
              <div style="align-self:flex-end"><button class="btn btn-primary" id="createRefBtn">åˆ›å»ºåˆ†é”€ç </button></div>
            </div>
            <div id="refCreatedBox" class="small" style="margin-top:8px"></div>
            <div style="overflow:auto;margin-top:10px">
              <table>
                <thead><tr><th>åˆ†é”€ç </th><th>åç§°</th><th>ä½£é‡‘</th><th>è®¢å•æ•°</th><th>çŠ¶æ€</th><th>æ“ä½œ</th></tr></thead>
                <tbody id="refTbody"></tbody>
              </table>
            </div>
          </section>
        </div>

      </div>
    </main>
  </div>

  <!-- Test Editor Overlay (Global) -->
  <div id="testEditorOverlay" style="display:none;position:fixed;inset:0;z-index:9000;background:rgba(0,0,0,.45);overflow-y:auto">
    <div style="max-width:900px;margin:40px auto;padding:20px;background:#fff;border-radius:18px;box-shadow:0 20px 60px rgba(0,0,0,.2)">
      <div class="row" style="justify-content:space-between">
        <h3 style="margin:0" id="editorTitle">ç¼–è¾‘é‡è¡¨</h3>
        <button class="btn btn-ghost" id="closeEditorBtn">å…³é—­</button>
      </div>
      <div style="margin-top:14px">
        <div class="row" style="gap:10px">
          <label class="small" style="flex:1">IDï¼ˆå°å†™å­—æ¯/æ•°å­—/æ¨ªçº¿ï¼‰<br/><input id="testId" style="width:100%" placeholder="ä¾‹: gad7"/></label>
          <label class="small" style="flex:2">æ ‡é¢˜<br/><input id="testTitle" style="width:100%" placeholder="ä¾‹: GAD-7 å¹¿æ³›æ€§ç„¦è™‘è¯„ä¼°"/></label>
        </div>
        <div class="row" style="gap:10px;margin-top:10px">
          <label class="small" style="flex:1">åˆ†ç±»<br/>
            <select id="testCategory" class="form-select">
              <option value="">è¯·é€‰æ‹©åˆ†ç±»</option>
            </select>
          </label>
          <label class="small" style="flex:1">æ ‡ç­¾ï¼ˆé€—å·åˆ†éš”ï¼‰<br/><input id="testTags" style="width:100%" placeholder="ä¾‹: ç„¦è™‘,æƒ…ç»ª"/></label>
          <label class="small" style="flex:1">é¢„è®¡æ—¶é—´ï¼ˆåˆ†é’Ÿï¼‰<br/><input id="testEstimated" type="number" style="width:100%" value="10"/></label>
        </div>
        <label class="small" style="display:block;margin-top:10px">ç®€ä»‹<br/><textarea id="testIntro" style="width:100%;min-height:60px;border-radius:12px;border:1px solid rgba(0,0,0,.12);padding:10px"></textarea></label>
        
        <div style="margin-top:14px">
          <div class="row" style="justify-content:space-between">
            <h4 style="margin:0">è¯„åˆ†è§„åˆ™</h4>
            <button class="btn btn-ghost" id="toggleRuleJsonBtn" type="button" style="padding:4px 8px">åˆ‡æ¢åˆ° JSON</button>
          </div>
          
          <div id="ruleEditorForm" style="margin-top:10px">
            <div class="row" style="gap:10px">
              <label class="small" style="flex:1">è¯„åˆ†æ¨¡å¼<br/>
                <select id="ruleMode" style="width:100%;border-radius:12px;border:1px solid rgba(0,0,0,.12);padding:10px">
                  <option value="scl90">SCL-90ï¼ˆé‡è¡¨æ±‚å’Œï¼‰</option>
                  <option value="mbti">MBTIï¼ˆç»´åº¦è®¡åˆ†ï¼‰</option>
                  <option value="simple">ç®€å•æ±‚å’Œ</option>
                </select>
              </label>
            </div>
            
            <div style="margin-top:10px">
              <label class="small">é‡è¡¨åˆ†å€¼ï¼ˆé€—å·åˆ†éš”ï¼‰<br/><input id="ruleScale" style="width:100%" placeholder="ä¾‹: 0,1,2,3,4"/></label>
            </div>
            
            <div style="margin-top:10px">
              <label class="small">é€‰é¡¹æ ‡ç­¾ï¼ˆé€—å·åˆ†éš”ï¼‰<br/><input id="ruleLabels" style="width:100%" placeholder="ä¾‹: æ²¡æœ‰,è½»å¾®,ä¸­ç­‰,æ˜æ˜¾,ä¸¥é‡"/></label>
            </div>
            
            <div style="margin-top:10px">
              <h5 style="margin:0 0 8px">è¯„åˆ†åŒºé—´</h5>
              <div id="ruleBandsContainer"></div>
              <button class="btn btn-ghost" id="addBandBtn" type="button" style="margin-top:8px;padding:4px 8px">+ æ·»åŠ åŒºé—´</button>
            </div>
          </div>
          
          <div id="ruleEditorJson" style="display:none;margin-top:10px">
            <textarea id="testRule" style="width:100%;min-height:120px;border-radius:12px;border:1px solid rgba(0,0,0,.12);padding:10px;font-family:monospace;font-size:12px"></textarea>
          </div>
        </div>
        
        <div style="margin-top:14px">
          <div class="row" style="justify-content:space-between">
            <h4 style="margin:0">é¢˜ç›®åˆ—è¡¨</h4>
            <button class="btn btn-ghost" id="addQuestionBtn">+ æ·»åŠ é¢˜ç›®</button>
          </div>
          <div id="questionsContainer" style="margin-top:10px;max-height:400px;overflow-y:auto"></div>
        </div>
        <div class="row" style="margin-top:14px">
          <button class="btn btn-primary" id="saveTestBtn">ä¿å­˜é‡è¡¨</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    const API = "/api/admin.php";
    const stKey = "adminToken";
    const $ = (s) => document.querySelector(s);
    const fmt = (ts) => {
      if(!ts) return "-";
      const d = new Date(ts*1000);
      const p = (n)=> String(n).padStart(2,"0");
      return `${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())} ${p(d.getHours())}:${p(d.getMinutes())}`;
    };

    // Global HTML escaping utility
    function escapeHtml(str){
      const div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }

    function getToken(){ return localStorage.getItem(stKey) || ""; }
    function setAuthedUI(ok){
      const layout = document.getElementById("adminLayout");
      const tip = document.getElementById("authTip");
      if(layout) layout.style.display = ok ? "flex" : "none";
      if(tip) tip.style.display = "none";
      const logout = document.getElementById("logoutBtn");
      if(logout) logout.style.display = ok ? "" : "none";
    }
    function setToken(t){ if(t) localStorage.setItem(stKey,t); else localStorage.removeItem(stKey); }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // Sidebar Navigation
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function initSidebarNavigation(){
      document.querySelectorAll(".menu-item").forEach(item => {
        item.addEventListener("click", (e) => {
          e.preventDefault();
          const section = item.dataset.section;
          if(!section) return;
          
          // Hide all sections
          document.querySelectorAll(".content-section").forEach(s => s.classList.remove("active"));
          
          // Show selected section
          const targetSection = document.getElementById(`section-${section}`);
          if(targetSection) targetSection.classList.add("active");
          
          // Update menu active state
          document.querySelectorAll(".menu-item").forEach(m => m.classList.remove("active"));
          item.classList.add("active");
          
          // Load section data if needed
          if(section === "carousel") loadCarousel();
          if(section === "featured") loadFeaturedContent();
        });
      });
    }

    async function call(action, payload={}){
      const body = { action, ...payload };
      if(action !== "login") body.adminToken = getToken();
      const r = await fetch(API, { method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(body) });
      const j = await r.json().catch(()=>({ok:false,error:"bad_json"}));
      if(!j.ok) throw j;
      return j;
    }
    async function createCodes(){
      const count = Number($("#count").value||20);
      const prefix = $("#prefix").value.trim() || "H";
      const maxUses = Number($("#maxUses").value||1);
      const grantDays = Number($("#grantDays").value||3);
      const note = $("#note").value.trim();
      let expiresAt = 0;
      const dt = $("#expiresAt").value;
      if(dt){
        expiresAt = Math.floor(new Date(dt).getTime()/1000);
      }
      const j = await call("createCodes", { count, prefix, maxUses, grantDays, note, expiresAt });
      $("#createdBox").innerHTML = `<div class="pill">å·²ç”Ÿæˆ ${j.created.length} ä¸ª</div>
        <div style="margin-top:8px" class="mono">${j.created.join("<br/>")}</div>`;
      await refreshAll();
    }

    async function refreshAll(){
      if(!getToken()){ location.href="/XyJoe7/"; return; }
      try{
        const s = await call("stats");
        $("#stats").textContent = `æ€»æ•° ${s.stats.total} Â· å·²åœç”¨ ${s.stats.disabled} Â· å·²è¿‡æœŸ ${s.stats.expired} Â· ç”¨å°½ ${s.stats.usedUp} Â· æ´»è·ƒä¼šè¯ ${s.stats.activeSessions}`;
      }catch(e){
        $("#stats").textContent = "æœªç™»å½•æˆ–é…ç½®æœªå®Œæˆ";
      }
      await listCodes();
      await loadSiteSettings();
      await loadAnalytics();
      await loadSourceReport();
      await loadTests();
      await loadReferrers();
      await loadSeoSettings();
      await loadCarousel();
      await loadFeaturedContent();
      await loadCategories();
    }

    function statusBadge(c){
      const t = Math.floor(Date.now()/1000);
      const exp = Number(c.expiresAt||0);
      const uses = Number(c.uses||0);
      const max = Number(c.maxUses||1);
      if(c.disabled) return `<span class="pill danger">åœç”¨</span>`;
      if(exp && exp < t) return `<span class="pill danger">è¿‡æœŸ</span>`;
      if(uses >= max) return `<span class="pill">ç”¨å°½</span>`;
      return `<span class="pill">å¯ç”¨</span>`;
    }

    async function listCodes(){
      const q = $("#q").value.trim();
      const j = await call("listCodes", { q });
      const rows = j.codes.map(c => {
        const exp = c.expiresAt ? fmt(c.expiresAt) : "æ°¸ä¸è¿‡æœŸ";
        const note = (c.meta && c.meta.note) ? c.meta.note : "-";
        return `
          <tr>
            <td class="mono">${c.code}</td>
            <td>${statusBadge(c)}</td>
            <td>${c.uses||0}/${c.maxUses||1}</td>
            <td>${exp}</td>
            <td>${c.grantDays||3} å¤©</td>
            <td>${note}</td>
            <td class="row">
              <button class="btn btn-ghost" data-toggle="${c.code}" data-disabled="${c.disabled?0:1}">${c.disabled?"å¯ç”¨":"åœç”¨"}</button>
              <button class="btn btn-ghost" data-del="${c.code}" style="border-color:rgba(176,0,32,.25)">åˆ é™¤</button>
            </td>
          </tr>
        `;
      }).join("");
      $("#tbody").innerHTML = rows || `<tr><td colspan="7" class="small">æš‚æ— æ•°æ®</td></tr>`;

      document.querySelectorAll("[data-toggle]").forEach(btn=>{
        btn.addEventListener("click", async ()=>{
          const code = btn.getAttribute("data-toggle");
          const disabled = Number(btn.getAttribute("data-disabled")) === 1;
          await call("toggleCode", { code, disabled });
          await refreshAll();
        });
      });
      document.querySelectorAll("[data-del]").forEach(btn=>{
        btn.addEventListener("click", async ()=>{
          const code = btn.getAttribute("data-del");
          if(!confirm(`ç¡®å®šåˆ é™¤å¹¶é”€æ¯ä¼šè¯ï¼Ÿ\n${code}`)) return;
          await call("deleteCode", { code });
          await refreshAll();
        });
      });
    }

    async function loadSiteSettings(){
      const j = await call("getSiteSettings");
      $("#siteName").value = j.settings.siteName || "";
      $("#siteSub").value = j.settings.siteSub || "";
      $("#siteIcp").value = j.settings.icp || "";
      $("#siteAnalytics").value = j.settings.analyticsCode || "";
    }

    async function saveSiteSettings(){
      await call("updateSiteSettings", {
        siteName: $("#siteName").value,
        siteSub: $("#siteSub").value,
        icp: $("#siteIcp").value,
        analyticsCode: $("#siteAnalytics").value
      });
      toast("ç«™ç‚¹ä¿¡æ¯å·²ä¿å­˜");
    }

async function destroyExpired(){
      const j = await call("destroyExpired");
      toast(`å·²é”€æ¯ ${j.removed} ä¸ªè¿‡æœŸç `);
      await refreshAll();
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // è¿è¥æ•°æ®æ±‡æ€»
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    async function loadAnalytics(){
      try{
        const j = await call("getAnalytics");
        const a = j.analytics;
        const c = a.codes;
        const s = a.sessions;
        const r = a.referrals;
        const tc = a.testCompletions;
        const popular = Object.entries(a.popularTests||{}).map(([k,v])=>`<span class="pill">${k}: ${v}æ¬¡</span>`).join(" ");
        $("#analyticsBody").innerHTML = `
          <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:10px;margin-bottom:12px">
            <div class="pill" style="padding:10px;text-align:center"><b>${c.total}</b><br/>æ¿€æ´»ç æ€»æ•°</div>
            <div class="pill" style="padding:10px;text-align:center"><b>${c.active}</b><br/>å¯ç”¨ç </div>
            <div class="pill" style="padding:10px;text-align:center"><b>${c.totalUses}</b><br/>æ€»ä½¿ç”¨æ¬¡æ•°</div>
            <div class="pill" style="padding:10px;text-align:center"><b>${s.today}</b><br/>ä»Šæ—¥æ–°ä¼šè¯</div>
            <div class="pill" style="padding:10px;text-align:center"><b>${s.week}</b><br/>è¿‘7å¤©ä¼šè¯</div>
            <div class="pill" style="padding:10px;text-align:center"><b>${s.month}</b><br/>è¿‘30å¤©ä¼šè¯</div>
            <div class="pill" style="padding:10px;text-align:center"><b>${s.active}</b><br/>æ´»è·ƒä¼šè¯</div>
            <div class="pill" style="padding:10px;text-align:center"><b>${r.total}</b><br/>åˆ†é”€è®¢å•</div>
            <div class="pill" style="padding:10px;text-align:center"><b>${tc.total}</b><br/>æµ‹è¯„å®Œæˆæ•°</div>
            <div class="pill" style="padding:10px;text-align:center"><b>${tc.today}</b><br/>ä»Šæ—¥å®Œæˆ</div>
          </div>
          ${popular ? `<div><b>çƒ­é—¨æµ‹è¯„ï¼š</b>${popular}</div>` : ""}
        `;
      }catch(e){ $("#analyticsBody").textContent = "åŠ è½½å¤±è´¥"; }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // æ¥æºè¿½è¸ª
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    async function loadSourceReport(){
      try{
        const j = await call("getSourceReport");
        const r = j.sourceReport;
        const srcRows = Object.entries(r.bySource||{}).map(([k,v])=>`<tr><td>${k}</td><td>${v}</td></tr>`).join("");
        const refRows = Object.entries(r.byReferral||{}).map(([k,v])=>`<tr><td class="mono">${k}</td><td>${v}</td></tr>`).join("");
        const utmRows = Object.entries(r.byCampaign||{}).map(([k,v])=>`<tr><td>${k}</td><td>${v}</td></tr>`).join("");
        $("#sourceBody").innerHTML = `
          <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:14px">
            <div>
              <b>æŒ‰æ¥æºæ¸ é“</b>
              <table><thead><tr><th>æ¸ é“</th><th>ä¼šè¯æ•°</th></tr></thead><tbody>${srcRows || '<tr><td colspan="2">æš‚æ— æ•°æ®</td></tr>'}</tbody></table>
            </div>
            <div>
              <b>æŒ‰åˆ†é”€ç </b>
              <table><thead><tr><th>åˆ†é”€ç </th><th>ä¼šè¯æ•°</th></tr></thead><tbody>${refRows || '<tr><td colspan="2">æš‚æ— æ•°æ®</td></tr>'}</tbody></table>
            </div>
            <div>
              <b>æŒ‰ UTM Campaign</b>
              <table><thead><tr><th>Campaign</th><th>ä¼šè¯æ•°</th></tr></thead><tbody>${utmRows || '<tr><td colspan="2">æš‚æ— æ•°æ®</td></tr>'}</tbody></table>
            </div>
          </div>
          <div class="small" style="margin-top:8px">æ€»ä¼šè¯æ•°ï¼š${r.totalSessions}</div>
        `;
      }catch(e){ $("#sourceBody").textContent = "åŠ è½½å¤±è´¥"; }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // é‡è¡¨ç®¡ç†
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    let _editingTestId = null;

    async function loadTests(){
      try{
        const j = await call("listTests");
        const rows = j.tests.map(t => `
          <tr>
            <td class="mono">${t.id}</td>
            <td>${t.title}</td>
            <td>${t.category}</td>
            <td>${t.questionCount}</td>
            <td>${t.estimated||"-"} åˆ†é’Ÿ</td>
            <td class="row">
              <button class="btn btn-ghost" data-edit-test="${t.id}">ç¼–è¾‘</button>
              <button class="btn btn-ghost" data-export-test="${t.id}">å¯¼å‡º</button>
              <button class="btn btn-ghost" data-del-test="${t.id}" style="border-color:rgba(176,0,32,.25)">åˆ é™¤</button>
            </td>
          </tr>
        `).join("");
        $("#testsTbody").innerHTML = rows || `<tr><td colspan="6" class="small">æš‚æ— é‡è¡¨</td></tr>`;

        document.querySelectorAll("[data-edit-test]").forEach(btn=>{
          btn.addEventListener("click", ()=> openTestEditor(btn.dataset.editTest));
        });
        document.querySelectorAll("[data-export-test]").forEach(btn=>{
          btn.addEventListener("click", ()=> exportTest(btn.dataset.exportTest));
        });
        document.querySelectorAll("[data-del-test]").forEach(btn=>{
          btn.addEventListener("click", async ()=>{
            if(!confirm(`ç¡®å®šåˆ é™¤é‡è¡¨ ${btn.dataset.delTest}ï¼Ÿ`)) return;
            await call("deleteTest", { id: btn.dataset.delTest });
            toast("å·²åˆ é™¤");
            await loadTests();
          });
        });
      }catch(e){ $("#testsTbody").innerHTML = `<tr><td colspan="6" class="small">åŠ è½½å¤±è´¥</td></tr>`; }
    }

    async function exportTest(testId){
      try{
        const j = await call("exportTest", { id: testId });
        const dataStr = JSON.stringify(j.test, null, 2);
        const dataBlob = new Blob([dataStr], { type: 'application/json' });
        const url = URL.createObjectURL(dataBlob);
        const link = document.createElement('a');
        link.href = url;
        link.download = j.filename || (testId + '_export.json');
        link.click();
        URL.revokeObjectURL(url);
        toast("å·²å¯¼å‡º");
      }catch(e){
        toast(e.error || "å¯¼å‡ºå¤±è´¥");
      }
    }

    async function importTest(){
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = '.json';
      input.onchange = async (e) => {
        const file = e.target.files[0];
        if(!file) return;
        try{
          const text = await file.text();
          const testData = JSON.parse(text);
          const j = await call("importTest", { test: testData });
          toast(j.updated ? "é‡è¡¨å·²æ›´æ–°" : "é‡è¡¨å·²å¯¼å…¥");
          await loadTests();
        }catch(e){
          toast(e.error || "å¯¼å…¥å¤±è´¥");
        }
      };
      input.click();
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // Rule Editor Form Functions
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    let _ruleEditorMode = "form"; // "form" or "json"
    let _currentRule = {};
    
    function toggleRuleEditor(){
      const formDiv = $("#ruleEditorForm");
      const jsonDiv = $("#ruleEditorJson");
      const btn = $("#toggleRuleJsonBtn");
      
      if(_ruleEditorMode === "form"){
        // Switch to JSON mode
        _currentRule = collectRuleFromForm();
        $("#testRule").value = JSON.stringify(_currentRule, null, 2);
        formDiv.style.display = "none";
        jsonDiv.style.display = "block";
        btn.textContent = "åˆ‡æ¢åˆ°è¡¨å•";
        _ruleEditorMode = "json";
      } else {
        // Switch to form mode
        try{
          _currentRule = JSON.parse($("#testRule").value || "{}");
          loadRuleToForm(_currentRule);
          formDiv.style.display = "block";
          jsonDiv.style.display = "none";
          btn.textContent = "åˆ‡æ¢åˆ° JSON";
          _ruleEditorMode = "form";
        }catch(e){
          alert("JSON æ ¼å¼é”™è¯¯ï¼Œæ— æ³•åˆ‡æ¢åˆ°è¡¨å•æ¨¡å¼");
        }
      }
    }
    
    function collectRuleFromForm(){
      const scale = $("#ruleScale").value.split(",").map(v => {
        const n = Number(v.trim());
        return isNaN(n) ? v.trim() : n;
      }).filter(v => v !== "");
      
      const labels = $("#ruleLabels").value.split(",").map(v => v.trim()).filter(v => v);
      
      const bands = [];
      document.querySelectorAll(".rule-band").forEach(bandEl => {
        const min = Number(bandEl.querySelector(".band-min").value || 0);
        const max = Number(bandEl.querySelector(".band-max").value || 0);
        const label = bandEl.querySelector(".band-label").value || "";
        const desc = bandEl.querySelector(".band-desc").value || "";
        bands.push([min, max, label, desc]);
      });
      
      const mode = $("#ruleMode").value || "simple";
      
      return { scale, labels, bands, mode };
    }
    
    function loadRuleToForm(rule){
      _currentRule = rule || {};
      
      $("#ruleMode").value = rule.mode || "simple";
      $("#ruleScale").value = (rule.scale || []).join(", ");
      $("#ruleLabels").value = (rule.labels || []).join(", ");
      
      renderRuleBands(rule.bands || []);
    }
    
    function renderRuleBands(bands){
      const container = $("#ruleBandsContainer");
      container.innerHTML = bands.map((band, idx) => {
        const [min, max, label, desc] = band;
        return `
          <div class="card rule-band" style="margin-bottom:8px;padding:10px">
            <div class="row" style="gap:8px;align-items:start">
              <input class="band-min" type="number" value="${min}" style="width:60px" placeholder="æœ€å°"/>
              <span style="line-height:38px">-</span>
              <input class="band-max" type="number" value="${max}" style="width:60px" placeholder="æœ€å¤§"/>
              <input class="band-label" value="${escapeAttr(label)}" style="width:80px" placeholder="æ ‡ç­¾"/>
              <input class="band-desc" value="${escapeAttr(desc)}" style="flex:1" placeholder="å»ºè®®æè¿°"/>
              <button class="btn btn-ghost del-band" data-idx="${idx}" style="padding:4px 8px;border-color:rgba(176,0,32,.25)">åˆ é™¤</button>
            </div>
          </div>
        `;
      }).join("");
      
      // Bind delete buttons
      container.querySelectorAll(".del-band").forEach(btn => {
        btn.addEventListener("click", () => {
          const idx = Number(btn.dataset.idx);
          const rule = collectRuleFromForm();
          rule.bands.splice(idx, 1);
          loadRuleToForm(rule);
        });
      });
    }
    
    function addRuleBand(){
      const rule = collectRuleFromForm();
      rule.bands.push([0, 10, "ä½", "å»ºè®®æè¿°"]);
      loadRuleToForm(rule);
    }

    async function openTestEditor(testId){
      _editingTestId = testId;
      
      // Populate category dropdown
      const categorySelect = $("#testCategory");
      categorySelect.innerHTML = '<option value="">è¯·é€‰æ‹©åˆ†ç±»</option>';
      if (_categoriesData && _categoriesData.length > 0) {
        _categoriesData.forEach(cat => {
          const categoryName = cat.name || cat.id || '';
          const option = document.createElement('option');
          option.value = categoryName;
          option.textContent = (cat.icon ? cat.icon + ' ' : '') + categoryName;
          categorySelect.appendChild(option);
        });
      }
      
      if(testId){
        const j = await call("getTest", { id: testId });
        const t = j.test;
        $("#testId").value = t.id || "";
        $("#testId").disabled = true;
        $("#testTitle").value = t.title || "";
        $("#testCategory").value = t.category || "";
        $("#testTags").value = (t.tags||[]).join(", ");
        $("#testEstimated").value = t.estimated || 10;
        $("#testIntro").value = t.intro || "";
        
        // Load rule to form
        _currentRule = t.rule || {};
        loadRuleToForm(_currentRule);
        $("#testRule").value = JSON.stringify(_currentRule, null, 2);
        _ruleEditorMode = "form";
        $("#ruleEditorForm").style.display = "block";
        $("#ruleEditorJson").style.display = "none";
        $("#toggleRuleJsonBtn").textContent = "åˆ‡æ¢åˆ° JSON";
        
        renderQuestionsEditor(t.questions || []);
        $("#editorTitle").textContent = "ç¼–è¾‘é‡è¡¨: " + t.id;
      } else {
        $("#testId").value = "";
        $("#testId").disabled = false;
        $("#testTitle").value = "";
        $("#testCategory").value = "";
        $("#testTags").value = "";
        $("#testEstimated").value = 10;
        $("#testIntro").value = "";
        
        // Load default rule
        const defaultRule = {
          scale: [0,1,2,3,4],
          labels: ["æ²¡æœ‰","è½»å¾®","ä¸­ç­‰","æ˜æ˜¾","ä¸¥é‡"],
          bands: [[0,10,"ä½","å»ºè®®æè¿°"],[11,22,"ä¸­","å»ºè®®æè¿°"],[23,40,"é«˜","å»ºè®®æè¿°"]],
          mode: "simple"
        };
        _currentRule = defaultRule;
        loadRuleToForm(defaultRule);
        $("#testRule").value = JSON.stringify(defaultRule, null, 2);
        _ruleEditorMode = "form";
        $("#ruleEditorForm").style.display = "block";
        $("#ruleEditorJson").style.display = "none";
        $("#toggleRuleJsonBtn").textContent = "åˆ‡æ¢åˆ° JSON";
        
        renderQuestionsEditor([]);
        $("#editorTitle").textContent = "æ–°å¢é‡è¡¨";
      }
      $("#testEditorOverlay").style.display = "block";
    }

    function renderQuestionsEditor(questions){
      const container = $("#questionsContainer");
      container.innerHTML = questions.map((q, i) => {
        const opts = (q.opts||[]).map((o,oi)=>`<div class="row" style="gap:4px;margin-top:4px"><input class="q-opt-t" data-qi="${i}" data-oi="${oi}" value="${escapeAttr(o.t||"")}" style="flex:2" placeholder="é€‰é¡¹æ–‡å­—"/><input class="q-opt-v" data-qi="${i}" data-oi="${oi}" type="number" value="${o.v||0}" style="flex:1;max-width:60px" placeholder="åˆ†å€¼"/><button class="btn btn-ghost q-del-opt" data-qi="${i}" data-oi="${oi}" style="padding:4px 8px">Ã—</button></div>`).join("");
        return `<div class="card" style="margin-bottom:8px;padding:10px" data-qi="${i}">
          <div class="row" style="gap:6px">
            <span class="small" style="min-width:30px">#${i+1}</span>
            <input class="q-text" data-qi="${i}" value="${escapeAttr(q.q||"")}" style="flex:1" placeholder="é¢˜ç›®æ–‡æœ¬"/>
            <button class="btn btn-ghost q-del" data-qi="${i}" style="border-color:rgba(176,0,32,.25);padding:4px 8px">åˆ é¢˜</button>
          </div>
          <div class="q-opts-wrap" data-qi="${i}" style="margin-left:36px">${opts}
            <button class="btn btn-ghost q-add-opt" data-qi="${i}" style="margin-top:4px;font-size:11px">+ é€‰é¡¹</button>
          </div>
        </div>`;
      }).join("") || `<div class="small">æš‚æ— é¢˜ç›®ï¼Œç‚¹å‡»"æ·»åŠ é¢˜ç›®"å¼€å§‹</div>`;
      bindQuestionEditorEvents();
    }

    function escapeAttr(s){ return String(s).replace(/"/g, '&quot;').replace(/</g, '&lt;').replace(/>/g, '&gt;'); }

    function collectTestFromEditor(){
      const questions = [];
      document.querySelectorAll("#questionsContainer > .card").forEach(card => {
        const qi = card.dataset.qi;
        const q = card.querySelector(`.q-text[data-qi="${qi}"]`)?.value || "";
        const opts = [];
        card.querySelectorAll(`.q-opt-t[data-qi="${qi}"]`).forEach(optInput => {
          const oi = optInput.dataset.oi;
          const t = optInput.value;
          const v = Number(card.querySelector(`.q-opt-v[data-qi="${qi}"][data-oi="${oi}"]`)?.value || 0);
          opts.push({ t, v });
        });
        questions.push({ q, opts });
      });

      let rule = {};
      if(_ruleEditorMode === "form"){
        rule = collectRuleFromForm();
        // Update JSON textarea in case user wants to switch
        $("#testRule").value = JSON.stringify(rule, null, 2);
      } else {
        try { 
          rule = JSON.parse($("#testRule").value || "{}"); 
        } catch(e) { 
          toast("è¯„åˆ†è§„åˆ™ JSON æ ¼å¼é”™è¯¯"); 
          return null; 
        }
      }

      return {
        id: $("#testId").value.trim(),
        title: $("#testTitle").value.trim(),
        category: $("#testCategory").value.trim(),
        tags: $("#testTags").value.split(",").map(s=>s.trim()).filter(Boolean),
        intro: $("#testIntro").value.trim(),
        estimated: Number($("#testEstimated").value) || 10,
        mode: "score",
        rule,
        questions,
      };
    }

    function bindQuestionEditorEvents(){
      document.querySelectorAll(".q-del").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const data = collectTestFromEditor();
          if(!data) return;
          data.questions.splice(Number(btn.dataset.qi), 1);
          renderQuestionsEditor(data.questions);
        });
      });
      document.querySelectorAll(".q-del-opt").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const data = collectTestFromEditor();
          if(!data) return;
          data.questions[Number(btn.dataset.qi)].opts.splice(Number(btn.dataset.oi), 1);
          renderQuestionsEditor(data.questions);
        });
      });
      document.querySelectorAll(".q-add-opt").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const data = collectTestFromEditor();
          if(!data) return;
          data.questions[Number(btn.dataset.qi)].opts.push({ t: "", v: 0 });
          renderQuestionsEditor(data.questions);
        });
      });
    }

    async function saveTest(){
      const data = collectTestFromEditor();
      if(!data) return;
      if(!data.id || !data.title){ toast("è¯·å¡«å†™ ID å’Œæ ‡é¢˜"); return; }
      try{
        if(_editingTestId){
          await call("updateTest", { id: _editingTestId, test: data });
          toast("é‡è¡¨å·²æ›´æ–°");
        } else {
          await call("addTest", { test: data });
          toast("é‡è¡¨å·²æ·»åŠ ");
        }
        $("#testEditorOverlay").style.display = "none";
        await loadTests();
      }catch(e){ toast(e.error || "ä¿å­˜å¤±è´¥"); }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // åˆ†é”€ç®¡ç†
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    async function loadReferrers(){
      try{
        const j = await call("listReferrers");
        const rows = j.referrers.map(r => `
          <tr>
            <td class="mono">${r.code}</td>
            <td>${r.name}</td>
            <td>${r.commissionPct}%</td>
            <td>${r.totalOrders||0}</td>
            <td>${r.disabled ? '<span class="pill danger">åœç”¨</span>' : '<span class="pill">æ´»è·ƒ</span>'}</td>
            <td class="row">
              <button class="btn btn-ghost" data-toggle-ref="${r.code}" data-disabled="${r.disabled?0:1}">${r.disabled?"å¯ç”¨":"åœç”¨"}</button>
              <button class="btn btn-ghost" data-del-ref="${r.code}" style="border-color:rgba(176,0,32,.25)">åˆ é™¤</button>
            </td>
          </tr>
        `).join("");
        $("#refTbody").innerHTML = rows || `<tr><td colspan="6" class="small">æš‚æ— åˆ†é”€å‘˜</td></tr>`;

        document.querySelectorAll("[data-toggle-ref]").forEach(btn=>{
          btn.addEventListener("click", async ()=>{
            await call("toggleReferrer", { code: btn.dataset.toggleRef, disabled: Number(btn.dataset.disabled)===1 });
            await loadReferrers();
          });
        });
        document.querySelectorAll("[data-del-ref]").forEach(btn=>{
          btn.addEventListener("click", async ()=>{
            if(!confirm(`ç¡®å®šåˆ é™¤åˆ†é”€ç  ${btn.dataset.delRef}ï¼Ÿ`)) return;
            await call("deleteReferrer", { code: btn.dataset.delRef });
            toast("å·²åˆ é™¤");
            await loadReferrers();
          });
        });
      }catch(e){ $("#refTbody").innerHTML = `<tr><td colspan="6" class="small">åŠ è½½å¤±è´¥</td></tr>`; }
    }

    async function createReferrer(){
      const name = $("#refName").value.trim();
      if(!name){ toast("è¯·å¡«å†™åç§°"); return; }
      const j = await call("createReferrer", {
        name,
        commissionPct: Number($("#refCommission").value) || 10,
        note: $("#refNote").value.trim(),
      });
      const refUrl = `${location.origin}/code?ref=${j.referralCode}`;
      $("#refCreatedBox").innerHTML = `<div class="pill">å·²åˆ›å»º: <span class="mono">${j.referralCode}</span></div>
        <div style="margin-top:4px">åˆ†é”€é“¾æ¥: <code class="mono" style="font-size:11px">${refUrl}</code></div>`;
      await loadReferrers();
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // SEO è®¾ç½®
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    async function loadSeoSettings(){
      try{
        const j = await call("getSeoSettings");
        const s = j.seo;
        $("#seoTitle").value = s.globalTitle || "";
        $("#seoDesc").value = s.globalDescription || "";
        $("#seoKeywords").value = s.globalKeywords || "";
        $("#seoOgImage").value = s.ogImage || "";
        $("#seoCanonical").value = s.canonical || "";
        $("#seoFreq").value = s.sitemapFreq || "weekly";
        $("#seoAutoSitemap").checked = s.autoSitemap !== false;
        $("#seoRobotsExtra").value = s.robotsExtra || "";
      }catch(e){}
    }

    async function saveSeoSettings(){
      await call("updateSeoSettings", {
        globalTitle: $("#seoTitle").value,
        globalDescription: $("#seoDesc").value,
        globalKeywords: $("#seoKeywords").value,
        ogImage: $("#seoOgImage").value,
        canonical: $("#seoCanonical").value,
        sitemapFreq: $("#seoFreq").value,
        autoSitemap: $("#seoAutoSitemap").checked,
        robotsExtra: $("#seoRobotsExtra").value,
      });
      toast("SEO è®¾ç½®å·²ä¿å­˜");
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // Carousel Management
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    let _carouselData = [];
    
    async function loadCarousel(){
      try{
        const j = await call("getCarousel");
        _carouselData = j.carousel || [];
        renderCarousel();
      }catch(e){ 
        $("#carouselList").innerHTML = `<div class="small">åŠ è½½å¤±è´¥</div>`;
      }
    }
    
    function renderCarousel(){
      const list = $("#carouselList");
      if(_carouselData.length === 0){
        list.innerHTML = `<div class="small">æš‚æ— è½®æ’­å›¾ï¼Œç‚¹å‡»"æ·»åŠ è½®æ’­"å¼€å§‹</div>`;
        return;
      }
      
      list.innerHTML = _carouselData.map((slide, idx) => {
        const escTitle = escapeHtml(slide.title || "æ— æ ‡é¢˜");
        const escDesc = escapeHtml(slide.description || "");
        const escLink = escapeHtml(slide.link || "-");
        const escImage = escapeHtml(slide.image || "");
        const escAlt = escapeHtml(slide.title || "è½®æ’­å›¾");
        return `
        <div class="card" style="margin-bottom:10px;padding:12px">
          <div class="row" style="gap:10px;align-items:start">
            <img src="${escImage}" alt="${escAlt}" style="width:120px;height:80px;object-fit:cover;border-radius:8px" onerror="this.style.display='none'"/>
            <div style="flex:1">
              <div class="row" style="justify-content:space-between">
                <b>${escTitle}</b>
                <div class="row">
                  <button class="btn btn-ghost" data-edit-carousel="${idx}" style="padding:4px 8px">ç¼–è¾‘</button>
                  <button class="btn btn-ghost" data-del-carousel="${idx}" style="padding:4px 8px;border-color:rgba(176,0,32,.25)">åˆ é™¤</button>
                </div>
              </div>
              <div class="small" style="margin-top:4px">${escDesc}</div>
              <div class="small" style="margin-top:4px">é“¾æ¥: <span class="mono">${escLink}</span></div>
            </div>
          </div>
        </div>
      `;
      }).join("");
      
      document.querySelectorAll("[data-edit-carousel]").forEach(btn=>{
        btn.addEventListener("click", ()=> editCarouselSlide(Number(btn.dataset.editCarousel)));
      });
      document.querySelectorAll("[data-del-carousel]").forEach(btn=>{
        btn.addEventListener("click", async ()=>{
          if(!confirm("ç¡®å®šåˆ é™¤æ­¤è½®æ’­ï¼Ÿ")) return;
          _carouselData.splice(Number(btn.dataset.delCarousel), 1);
          await saveCarousel();
        });
      });
    }
    
    function editCarouselSlide(idx){
      const slide = idx >= 0 ? _carouselData[idx] : { title: "", description: "", image: "", link: "" };
      const title = prompt("è½®æ’­æ ‡é¢˜:", slide.title || "");
      if(title === null) return;
      const image = prompt("å›¾ç‰‡ URL:", slide.image || "");
      if(image === null) return;
      const description = prompt("æè¿°ï¼ˆå¯é€‰ï¼‰:", slide.description || "");
      if(description === null) return;
      const link = prompt("é“¾æ¥ URLï¼ˆå¯é€‰ï¼‰:", slide.link || "");
      if(link === null) return;
      
      const newSlide = { title, description, image, link };
      if(idx >= 0){
        _carouselData[idx] = newSlide;
      } else {
        _carouselData.push(newSlide);
      }
      saveCarousel();
    }
    
    async function saveCarousel(){
      try{
        await call("updateCarousel", { carousel: _carouselData });
        toast("è½®æ’­å·²ä¿å­˜");
        renderCarousel();
      }catch(e){ toast(e.error || "ä¿å­˜å¤±è´¥"); }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // Featured Content Management
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    let _featuredData = {};
    let _allTests = [];
    
    async function loadFeaturedContent(){
      try{
        const [featRes, testRes] = await Promise.all([
          call("getFeaturedContent"),
          call("listTests")
        ]);
        _featuredData = featRes.featured || {
          hot: { enabled: true, title: 'ğŸ”¥ çƒ­é—¨æ¨è', items: [] },
          new: { enabled: true, title: 'ğŸ†• æœ€æ–°ä¸Šçº¿', items: [] },
          recommended: { enabled: true, title: 'â­ ç¼–è¾‘æ¨è', items: [] }
        };
        _allTests = testRes.tests || [];
        renderFeaturedContent();
      }catch(e){ 
        $("#featuredContentList").innerHTML = `<div class="small">åŠ è½½å¤±è´¥</div>`;
      }
    }
    
    function renderFeaturedContent(){
      const list = $("#featuredContentList");
      const sections = [
        { key: 'hot', title: 'ğŸ”¥ çƒ­é—¨æ¨è' },
        { key: 'new', title: 'ğŸ†• æœ€æ–°ä¸Šçº¿' },
        { key: 'recommended', title: 'â­ ç¼–è¾‘æ¨è' }
      ];
      
      list.innerHTML = sections.map(sec => {
        const section = _featuredData[sec.key] || { enabled: true, title: sec.title, items: [] };
        const itemsHtml = (section.items || []).map((item, idx) => {
          const itemData = typeof item === 'string' ? { testId: item } : item;
          const testInfo = _allTests.find(t => t.id === itemData.testId);
          return `
            <div class="card" style="margin-bottom:8px;padding:10px">
              <div class="row" style="justify-content:space-between">
                <div style="flex:1">
                  <b>${escapeHtml(itemData.customTitle || (testInfo ? testInfo.title : itemData.testId))}</b>
                  ${itemData.briefIntro ? `<div class="small">${escapeHtml(itemData.briefIntro)}</div>` : ''}
                  ${itemData.leadQuestion ? `<div class="small" style="color:var(--accent)">${escapeHtml(itemData.leadQuestion)}</div>` : ''}
                  ${itemData.testedCount ? `<div class="small">${itemData.testedCount} äººæµ‹è¿‡</div>` : ''}
                </div>
                <div class="row">
                  <button class="btn btn-ghost" data-edit-featured="${sec.key}-${idx}" style="padding:4px 8px">ç¼–è¾‘</button>
                  <button class="btn btn-ghost" data-del-featured="${sec.key}-${idx}" style="padding:4px 8px;border-color:rgba(176,0,32,.25)">åˆ é™¤</button>
                </div>
              </div>
            </div>
          `;
        }).join("");
        
        return `
          <div class="card" style="margin-bottom:14px">
            <div class="row" style="justify-content:space-between">
              <h4 style="margin:0">${sec.title}</h4>
              <button class="btn btn-ghost" data-add-featured="${sec.key}" style="padding:4px 8px">æ·»åŠ é¡¹ç›®</button>
            </div>
            <div style="margin-top:10px">
              ${itemsHtml || '<div class="small">æš‚æ— é¡¹ç›®</div>'}
            </div>
          </div>
        `;
      }).join("");
      
      // Bind events
      document.querySelectorAll("[data-add-featured]").forEach(btn => {
        btn.addEventListener("click", () => editFeaturedItem(btn.dataset.addFeatured, -1));
      });
      document.querySelectorAll("[data-edit-featured]").forEach(btn => {
        const [key, idx] = btn.dataset.editFeatured.split("-");
        btn.addEventListener("click", () => editFeaturedItem(key, Number(idx)));
      });
      document.querySelectorAll("[data-del-featured]").forEach(btn => {
        const [key, idx] = btn.dataset.delFeatured.split("-");
        btn.addEventListener("click", async () => {
          if(!confirm("ç¡®å®šåˆ é™¤æ­¤é¡¹ç›®ï¼Ÿ")) return;
          _featuredData[key].items.splice(Number(idx), 1);
          await saveFeaturedContent();
        });
      });
    }
    
    function editFeaturedItem(sectionKey, idx){
      const section = _featuredData[sectionKey];
      const item = idx >= 0 ? section.items[idx] : {};
      const itemData = typeof item === 'string' ? { testId: item } : item;
      
      const testId = prompt("æµ‹è¯•é¡¹ç›® ID:", itemData.testId || "");
      if(testId === null) return;
      
      const customTitle = prompt("è‡ªå®šä¹‰æ ‡é¢˜ï¼ˆç•™ç©ºä½¿ç”¨é»˜è®¤ï¼‰:", itemData.customTitle || "");
      if(customTitle === null) return;
      
      const briefIntro = prompt("ç®€æ˜“ä»‹ç»:", itemData.briefIntro || "");
      if(briefIntro === null) return;
      
      const leadQuestion = prompt("å¼•æµé—®é¢˜:", itemData.leadQuestion || "");
      if(leadQuestion === null) return;
      
      const testedCount = prompt("æµ‹è¯•äººæ•°ï¼ˆæ•°å­—ï¼‰:", itemData.testedCount || "");
      if(testedCount === null) return;
      
      const image = prompt("å›¾ç‰‡ URLï¼ˆç•™ç©ºä½¿ç”¨é»˜è®¤ï¼‰:", itemData.image || "");
      if(image === null) return;
      
      const rawItem = {
        testId,
        customTitle: customTitle || undefined,
        briefIntro: briefIntro || undefined,
        leadQuestion: leadQuestion || undefined,
        testedCount: testedCount ? Number(testedCount) : undefined,
        image: image || undefined
      };
      
      // Remove undefined fields using a cleaner functional approach
      const newItem = Object.fromEntries(
        Object.entries(rawItem).filter(([_, v]) => v !== undefined)
      );
      
      if(idx >= 0){
        section.items[idx] = newItem;
      } else {
        section.items.push(newItem);
      }
      saveFeaturedContent();
    }
    
    async function saveFeaturedContent(){
      try{
        await call("updateFeaturedContent", { featured: _featuredData });
        toast("ç²¾é€‰å†…å®¹å·²ä¿å­˜");
        renderFeaturedContent();
      }catch(e){ toast(e.error || "ä¿å­˜å¤±è´¥"); }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // Category Management
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    let _categoriesData = [];
    
    async function loadCategories(){
      try{
        const j = await call("getCategories");
        _categoriesData = j.categories || [];
        renderCategories();
      }catch(e){ 
        $("#categoriesList").innerHTML = `<div class="small">åŠ è½½å¤±è´¥</div>`;
      }
    }
    
    function renderCategories(){
      const list = $("#categoriesList");
      if(_categoriesData.length === 0){
        list.innerHTML = `<div class="small">æš‚æ— åˆ†ç±»ï¼Œç‚¹å‡»"æ–°å¢åˆ†ç±»"å¼€å§‹</div>`;
        return;
      }
      
      list.innerHTML = _categoriesData.map((cat, idx) => {
        const escId = escapeHtml(cat.id || "");
        const escName = escapeHtml(cat.name || "");
        const escIcon = escapeHtml(cat.icon || "");
        const escImage = escapeHtml(cat.image || "");
        return `
        <div class="card" style="margin-bottom:10px;padding:12px">
          <div class="row" style="justify-content:space-between;align-items:center">
            <div class="row" style="align-items:center;gap:12px">
              ${escImage ? `<img src="${escImage}" alt="${escName}" style="width:60px;height:60px;object-fit:cover;border-radius:8px" onerror="this.style.display='none'"/>` : ''}
              <div>
                <div><b>${escIcon} ${escName}</b></div>
                <div class="small mono">ID: ${escId}</div>
              </div>
            </div>
            <div class="row">
              <button class="btn btn-ghost" data-edit-category="${idx}" style="padding:4px 8px">ç¼–è¾‘</button>
              <button class="btn btn-ghost" data-del-category="${idx}" style="padding:4px 8px;border-color:rgba(176,0,32,.25)">åˆ é™¤</button>
            </div>
          </div>
        </div>
      `;
      }).join("");
      
      document.querySelectorAll("[data-edit-category]").forEach(btn=>{
        btn.addEventListener("click", ()=> editCategory(Number(btn.dataset.editCategory)));
      });
      document.querySelectorAll("[data-del-category]").forEach(btn=>{
        btn.addEventListener("click", async ()=>{
          if(!confirm("ç¡®å®šåˆ é™¤æ­¤åˆ†ç±»ï¼Ÿ")) return;
          _categoriesData.splice(Number(btn.dataset.delCategory), 1);
          await saveCategories();
        });
      });
    }
    
    function editCategory(idx){
      const cat = idx >= 0 ? _categoriesData[idx] : { id: "", name: "", icon: "", image: "" };
      
      let id = cat.id;
      if(idx < 0){
        id = prompt("åˆ†ç±» IDï¼ˆè‹±æ–‡ï¼Œå¦‚ï¼šemotionï¼‰:", id || "");
        if(id === null) return;
        // Enhanced validation: check format, length, and dangerous patterns
        if(!id || 
           id.length > 50 ||
           !/^[a-z0-9_-]+$/.test(id) ||
           id.indexOf('..') !== -1 ||
           id[0] === '.'){
          alert("ID æ ¼å¼ä¸æ­£ç¡®ï¼Œåªèƒ½ä½¿ç”¨å°å†™å­—æ¯ã€æ•°å­—ã€ä¸‹åˆ’çº¿å’Œè¿å­—ç¬¦ï¼Œä¸èƒ½ä»¥ç‚¹å¼€å¤´æˆ–åŒ…å«ä¸¤ä¸ªè¿ç»­çš„ç‚¹");
          return;
        }
        // Check if ID already exists
        if(_categoriesData.some(c => c.id === id)){
          alert("æ­¤ ID å·²å­˜åœ¨");
          return;
        }
      }
      
      const name = prompt("åˆ†ç±»åç§°:", cat.name || "");
      if(name === null) return;
      
      const icon = prompt("åˆ†ç±»å›¾æ ‡ï¼ˆemojiï¼‰:", cat.icon || "");
      if(icon === null) return;
      
      const image = prompt("åˆ†ç±»å›¾ç‰‡ URLï¼ˆå¯é€‰ï¼‰:", cat.image || "");
      if(image === null) return;
      
      const newCat = { id, name, icon, image };
      
      if(idx >= 0){
        _categoriesData[idx] = newCat;
      } else {
        _categoriesData.push(newCat);
      }
      saveCategories();
    }
    
    async function saveCategories(){
      try{
        await call("updateCategories", { categories: _categoriesData });
        toast("åˆ†ç±»å·²ä¿å­˜");
        renderCategories();
      }catch(e){ toast(e.error || "ä¿å­˜å¤±è´¥"); }
    }

    function toast(msg){
      const el = document.createElement("div");
      el.textContent = msg;
      el.style.cssText = "position:fixed;left:50%;top:18px;transform:translateX(-50%);z-index:9999;background:rgba(10,10,10,.85);color:#fff;padding:10px 12px;border-radius:12px;font-size:13px;max-width:92vw";
      document.body.appendChild(el);
      setTimeout(()=>{ el.remove(); }, 1800);
    }

    $("#createBtn")?.addEventListener("click", ()=>createCodes().catch(e=>toast(e.message||e.error||"ç”Ÿæˆå¤±è´¥")));
    $("#refreshBtn")?.addEventListener("click", ()=>refreshAll().catch(e=>toast(e.message||e.error||"åˆ·æ–°å¤±è´¥")));
    $("#destroyExpiredBtn")?.addEventListener("click", ()=>destroyExpired().catch(e=>toast(e.message||e.error||"æ“ä½œå¤±è´¥")));
    $("#saveSiteBtn")?.addEventListener("click", ()=>saveSiteSettings().catch(e=>toast(e.message||e.error||"ä¿å­˜å¤±è´¥")));
    $("#logoutBtn")?.addEventListener("click", ()=>{
      setToken(""); location.href="/XyJoe7/"; });

    // é‡è¡¨ç®¡ç†
    $("#addTestBtn")?.addEventListener("click", ()=>openTestEditor(null));
    $("#importTestBtn")?.addEventListener("click", ()=>importTest());
    $("#refreshTestsBtn")?.addEventListener("click", ()=>loadTests().catch(e=>toast(e.message||e.error||"åˆ·æ–°å¤±è´¥")));
    $("#closeEditorBtn")?.addEventListener("click", ()=>{ $("#testEditorOverlay").style.display = "none"; });
    $("#saveTestBtn")?.addEventListener("click", ()=>saveTest().catch(e=>toast(e.message||e.error||"ä¿å­˜å¤±è´¥")));
    $("#toggleRuleJsonBtn")?.addEventListener("click", ()=>toggleRuleEditor());
    $("#addBandBtn")?.addEventListener("click", ()=>addRuleBand());
    $("#addQuestionBtn")?.addEventListener("click", ()=>{
      const data = collectTestFromEditor();
      if(!data) return;
      data.questions.push({ q: "", opts: [{ t: "é€‰é¡¹A", v: 0 },{ t: "é€‰é¡¹B", v: 1 }] });
      renderQuestionsEditor(data.questions);
    });

    // åˆ†é”€ç®¡ç†
    $("#createRefBtn")?.addEventListener("click", ()=>createReferrer().catch(e=>toast(e.message||e.error||"åˆ›å»ºå¤±è´¥")));
    $("#refreshRefBtn")?.addEventListener("click", ()=>loadReferrers().catch(e=>toast(e.message||e.error||"åˆ·æ–°å¤±è´¥")));

    // SEO è®¾ç½®
    $("#saveSeoBtn")?.addEventListener("click", ()=>saveSeoSettings().catch(e=>toast(e.message||e.error||"ä¿å­˜å¤±è´¥")));

    // è½®æ’­å›¾ç®¡ç†
    $("#addCarouselBtn")?.addEventListener("click", ()=>editCarouselSlide(-1));
    $("#refreshCarouselBtn")?.addEventListener("click", ()=>loadCarousel().catch(e=>toast(e.message||e.error||"åˆ·æ–°å¤±è´¥")));

    // ç²¾é€‰å†…å®¹ç®¡ç†
    $("#refreshFeaturedBtn")?.addEventListener("click", ()=>loadFeaturedContent().catch(e=>toast(e.message||e.error||"åˆ·æ–°å¤±è´¥")));

    // åˆ†ç±»ç®¡ç†
    $("#addCategoryBtn")?.addEventListener("click", ()=>editCategory(-1));
    $("#refreshCategoriesBtn")?.addEventListener("click", ()=>loadCategories().catch(e=>toast(e.message||e.error||"åˆ·æ–°å¤±è´¥")));

    // Load ICP info for footer
    async function loadFooterInfo(){
      try{
        const r = await fetch('/api/site_public.php');
        const d = await r.json();
        if(d.ok && d.icp) document.getElementById('icpText').textContent = d.icp;
      }catch(e){}
    }

    // Initialize
    initSidebarNavigation();
    setAuthedUI(true);
    refreshAll().catch(()=>{ location.href="/XyJoe7/"; });
    loadFooterInfo();
  </script>
</body>
</html>
