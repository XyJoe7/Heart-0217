<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>XyJoe7 æ§åˆ¶å°</title>
  <link rel="stylesheet" href="/assets/style.css" />
  <link rel="stylesheet" href="/assets/pages.css" />
  <style>
    .wrap{max-width:1180px;margin:0 auto;padding:24px 16px}
    .login-center{display:flex;justify-content:center;margin:8px 0 14px}
    .login-card{width:min(560px,100%);text-align:center}
    .grid{display:grid;grid-template-columns:1fr;gap:14px;max-width:1080px;margin:0 auto}
    @media (max-width:900px){.grid{grid-template-columns:1fr}}
    .card{border-radius:18px;border:1px solid rgba(0,0,0,.08);background:rgba(255,255,255,.88);padding:14px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    input,select{border-radius:12px;border:1px solid rgba(0,0,0,.12);padding:10px 12px;font-size:14px;outline:none;background:#fff}
    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid rgba(0,0,0,.08);padding:10px 8px;text-align:left;font-size:13px}
    th{font-size:12px;color:var(--muted);font-weight:800}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:999px;border:1px solid rgba(0,0,0,.10);font-size:12px;background:rgba(255,255,255,.8)}
    .danger{color:#b00020}
    .small{color:var(--muted)}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
    .disabled-area{opacity:.58;position:relative;pointer-events:none}
    .disabled-area::after{content:"ç™»å½•åå¯æ“ä½œ";position:absolute;right:12px;top:10px;font-size:12px;color:#7a2f56;background:#fff;border:1px solid rgba(0,0,0,.08);padding:3px 8px;border-radius:999px}
  </style>
</head>
<body>
  <header class="topbar">
    <div class="topbar-inner">
      <a class="brand" href="/"><span class="logo">ğŸ—ï¸</span><span>XyJoe7 æ§åˆ¶å°</span></a>
      <div class="topbar-actions">
        <button class="btn btn-ghost" id="logoutBtn">é€€å‡º</button>
      </div>
    </div>
  </header>

  <main class="wrap">
    <div id="authTip" class="card" style="margin-bottom:12px">
      <b>å®‰å…¨æç¤ºï¼š</b>ä½ å·²ç™»å½•ï¼Œå¯åœ¨ä¸‹æ–¹ç®¡ç†æ¿€æ´»ç ã€ç«™ç‚¹å±•ç¤ºå­—æ®µä¸ç»Ÿè®¡ä»£ç ã€‚
    </div>
    <div class="grid" id="adminGrid" style="display:none">
      <section class="card" id="dashboardCard">
        <div class="row" style="justify-content:space-between">
          <div>
            <h3 style="margin:0 0 6px">æ¿€æ´»ç åˆ—è¡¨</h3>
            <div class="small" id="stats"></div>
          </div>
          <div class="row">
            <input id="q" placeholder="æœç´¢ code..." />
            <button class="btn btn-ghost" id="refreshBtn">åˆ·æ–°</button>
          </div>
        </div>

        <div style="overflow:auto;margin-top:10px">
          <table>
            <thead>
              <tr>
                <th>Code</th>
                <th>çŠ¶æ€</th>
                <th>ä½¿ç”¨</th>
                <th>è¿‡æœŸ</th>
                <th>æ¿€æ´»æœ‰æ•ˆæœŸ</th>
                <th>å¤‡æ³¨</th>
                <th>æ“ä½œ</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>
      </section>
      <section class="card" id="manageBox">
        <h3 style="margin:0 0 10px">æ‰¹é‡ç”Ÿæˆæ¿€æ´»ç </h3>
        <div class="row" style="gap:14px 10px">
          <label class="small" style="flex:1 1 120px">æ•°é‡<br/><input id="count" type="number" min="1" max="500" value="20" style="width:100%"/></label>
          <label class="small" style="flex:1 1 120px">å‰ç¼€<br/><input id="prefix" value="H" style="width:100%"/></label>
          <label class="small" style="flex:1 1 140px">æ¯ç å¯ç”¨æ¬¡æ•°<br/><input id="maxUses" type="number" min="1" value="1" style="width:100%"/></label>
          <label class="small" style="flex:1 1 140px">æ¿€æ´»åæœ‰æ•ˆå¤©æ•°<br/><input id="grantDays" type="number" min="1" value="3" style="width:100%"/></label>
        </div>
        <div class="row" style="gap:14px 10px;margin-top:10px">
          <label class="small" style="flex:1 1 220px">å¤‡æ³¨ï¼ˆå¯é€‰ï¼‰<br/><input id="note" style="width:100%" placeholder="å¦‚ï¼š2æœˆæ´»åŠ¨æ‰¹æ¬¡"/></label>
          <label class="small" style="flex:1 1 220px">ç æœ¬èº«è¿‡æœŸæ—¶é—´ï¼ˆå¯é€‰ï¼‰<br/><input id="expiresAt" type="datetime-local" style="width:100%"/></label>
        </div>
        <div class="row" style="margin-top:10px">
          <button class="btn btn-primary" id="createBtn">ç”Ÿæˆæ¿€æ´»ç </button>
          <button class="btn btn-ghost" id="destroyExpiredBtn">æ¸…ç†å·²è¿‡æœŸæ¿€æ´»ç </button>
        </div>
        <div id="createdBox" class="small" style="margin-top:10px"></div>
      </section>
      <section class="card" id="siteCard" style="display:none;margin-top:14px">
      <h3 style="margin:0 0 10px">ç«™ç‚¹ä¿¡æ¯è®¾ç½®</h3>
      <div class="row" style="gap:14px 10px">
        <label class="small" style="flex:1 1 220px">ç«™ç‚¹åç§°<br/><input id="siteName" style="width:100%"/></label>
        <label class="small" style="flex:1 1 220px">å‰¯æ ‡é¢˜<br/><input id="siteSub" style="width:100%"/></label>
      </div>
      <div class="row" style="gap:14px 10px;margin-top:10px">
        <label class="small" style="flex:1 1 220px">ICPå¤‡æ¡ˆå·<br/><input id="siteIcp" style="width:100%"/></label>
        <label class="small" style="flex:1 1 220px">ç»Ÿè®¡ä»£ç ï¼ˆå¯é€‰ï¼Œæ”¯æŒ script æˆ–çº¯æ–‡æœ¬ï¼‰<br/><textarea id="siteAnalytics" style="width:100%;min-height:88px;border-radius:12px;border:1px solid rgba(0,0,0,.12);padding:10px"></textarea></label>
      </div>
      <div class="row" style="margin-top:10px">
        <button class="btn btn-primary" id="saveSiteBtn">ä¿å­˜ç«™ç‚¹ä¿¡æ¯</button>
      </div>
    </section>

  </main>

  <script>
    const API = "/api/admin.php";
    const stKey = "adminToken";
    const $ = (s) => document.querySelector(s);
    const fmt = (ts) => {
      if(!ts) return "-";
      const d = new Date(ts*1000);
      const p = (n)=> String(n).padStart(2,"0");
      return `${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())} ${p(d.getHours())}:${p(d.getMinutes())}`;
    };

    function getToken(){ return localStorage.getItem(stKey) || ""; }
    function setAuthedUI(ok){
      const wrap=document.getElementById("adminGrid");
      const site=document.getElementById("siteCard");
      const box=document.getElementById("dashboardCard");
      const tip=document.getElementById("authTip");
      const manage=document.getElementById("manageBox");
      if(wrap) wrap.style.display = ok ? "grid" : "none";
      if(site) site.style.display = ok ? "block" : "none";
      if(box) box.classList.toggle("disabled-area", !ok);
      if(manage) manage.classList.toggle("disabled-area", !ok);
      if(tip) tip.style.display = "none";
      const logout=document.getElementById("logoutBtn");
      if(logout) logout.style.display = ok ? "" : "none";
    }
    function setToken(t){ if(t) localStorage.setItem(stKey,t); else localStorage.removeItem(stKey); }

    async function call(action, payload={}){
      const body = { action, ...payload };
      if(action !== "login") body.adminToken = getToken();
      const r = await fetch(API, { method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(body) });
      const j = await r.json().catch(()=>({ok:false,error:"bad_json"}));
      if(!j.ok) throw j;
      return j;
    }
    async function createCodes(){
      const count = Number($("#count").value||20);
      const prefix = $("#prefix").value.trim() || "H";
      const maxUses = Number($("#maxUses").value||1);
      const grantDays = Number($("#grantDays").value||3);
      const note = $("#note").value.trim();
      let expiresAt = 0;
      const dt = $("#expiresAt").value;
      if(dt){
        expiresAt = Math.floor(new Date(dt).getTime()/1000);
      }
      const j = await call("createCodes", { count, prefix, maxUses, grantDays, note, expiresAt });
      $("#createdBox").innerHTML = `<div class="pill">å·²ç”Ÿæˆ ${j.created.length} ä¸ª</div>
        <div style="margin-top:8px" class="mono">${j.created.join("<br/>")}</div>`;
      await refreshAll();
    }

    async function refreshAll(){
      if(!getToken()){ location.href="/XyJoe7/"; return; }
      try{
        const s = await call("stats");
        $("#stats").textContent = `æ€»æ•° ${s.stats.total} Â· å·²åœç”¨ ${s.stats.disabled} Â· å·²è¿‡æœŸ ${s.stats.expired} Â· ç”¨å°½ ${s.stats.usedUp} Â· æ´»è·ƒä¼šè¯ ${s.stats.activeSessions}`;
      }catch(e){
        $("#stats").textContent = "æœªç™»å½•æˆ–é…ç½®æœªå®Œæˆ";
      }
      await listCodes();
      await loadSiteSettings();
    }

    function statusBadge(c){
      const t = Math.floor(Date.now()/1000);
      const exp = Number(c.expiresAt||0);
      const uses = Number(c.uses||0);
      const max = Number(c.maxUses||1);
      if(c.disabled) return `<span class="pill danger">åœç”¨</span>`;
      if(exp && exp < t) return `<span class="pill danger">è¿‡æœŸ</span>`;
      if(uses >= max) return `<span class="pill">ç”¨å°½</span>`;
      return `<span class="pill">å¯ç”¨</span>`;
    }

    async function listCodes(){
      const q = $("#q").value.trim();
      const j = await call("listCodes", { q });
      const rows = j.codes.map(c => {
        const exp = c.expiresAt ? fmt(c.expiresAt) : "æ°¸ä¸è¿‡æœŸ";
        const note = (c.meta && c.meta.note) ? c.meta.note : "-";
        return `
          <tr>
            <td class="mono">${c.code}</td>
            <td>${statusBadge(c)}</td>
            <td>${c.uses||0}/${c.maxUses||1}</td>
            <td>${exp}</td>
            <td>${c.grantDays||3} å¤©</td>
            <td>${note}</td>
            <td class="row">
              <button class="btn btn-ghost" data-toggle="${c.code}" data-disabled="${c.disabled?0:1}">${c.disabled?"å¯ç”¨":"åœç”¨"}</button>
              <button class="btn btn-ghost" data-del="${c.code}" style="border-color:rgba(176,0,32,.25)">åˆ é™¤</button>
            </td>
          </tr>
        `;
      }).join("");
      $("#tbody").innerHTML = rows || `<tr><td colspan="7" class="small">æš‚æ— æ•°æ®</td></tr>`;

      document.querySelectorAll("[data-toggle]").forEach(btn=>{
        btn.addEventListener("click", async ()=>{
          const code = btn.getAttribute("data-toggle");
          const disabled = Number(btn.getAttribute("data-disabled")) === 1;
          await call("toggleCode", { code, disabled });
          await refreshAll();
        });
      });
      document.querySelectorAll("[data-del]").forEach(btn=>{
        btn.addEventListener("click", async ()=>{
          const code = btn.getAttribute("data-del");
          if(!confirm(`ç¡®å®šåˆ é™¤å¹¶é”€æ¯ä¼šè¯ï¼Ÿ\n${code}`)) return;
          await call("deleteCode", { code });
          await refreshAll();
        });
      });
    }

    async function loadSiteSettings(){
      const j = await call("getSiteSettings");
      $("#siteName").value = j.settings.siteName || "";
      $("#siteSub").value = j.settings.siteSub || "";
      $("#siteIcp").value = j.settings.icp || "";
      $("#siteAnalytics").value = j.settings.analyticsCode || "";
    }

    async function saveSiteSettings(){
      await call("updateSiteSettings", {
        siteName: $("#siteName").value,
        siteSub: $("#siteSub").value,
        icp: $("#siteIcp").value,
        analyticsCode: $("#siteAnalytics").value
      });
      toast("ç«™ç‚¹ä¿¡æ¯å·²ä¿å­˜");
    }

async function destroyExpired(){
      const j = await call("destroyExpired");
      toast(`å·²é”€æ¯ ${j.removed} ä¸ªè¿‡æœŸç `);
      await refreshAll();
    }

    function toast(msg){
      const el = document.createElement("div");
      el.textContent = msg;
      el.style.cssText = "position:fixed;left:50%;top:18px;transform:translateX(-50%);z-index:9999;background:rgba(10,10,10,.85);color:#fff;padding:10px 12px;border-radius:12px;font-size:13px;max-width:92vw";
      document.body.appendChild(el);
      setTimeout(()=>{ el.remove(); }, 1800);
    }

    $("#createBtn")?.addEventListener("click", ()=>createCodes().catch(e=>toast(e.message||e.error||"ç”Ÿæˆå¤±è´¥")));
    $("#refreshBtn")?.addEventListener("click", ()=>refreshAll().catch(e=>toast(e.message||e.error||"åˆ·æ–°å¤±è´¥")));
    $("#destroyExpiredBtn")?.addEventListener("click", ()=>destroyExpired().catch(e=>toast(e.message||e.error||"æ“ä½œå¤±è´¥")));
    $("#saveSiteBtn")?.addEventListener("click", ()=>saveSiteSettings().catch(e=>toast(e.message||e.error||"ä¿å­˜å¤±è´¥")));
    $("#logoutBtn")?.addEventListener("click", ()=>{
      setToken(""); location.href="/XyJoe7/"; });

    // auto refresh
    setAuthedUI(true);
    refreshAll().catch(()=>{ location.href="/XyJoe7/"; });
  </script>
</body>
</html>
