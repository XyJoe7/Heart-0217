<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>XyJoe7 æ§åˆ¶å°</title>
  <link rel="stylesheet" href="/assets/style.css" />
  <link rel="stylesheet" href="/assets/pages.css" />
  <style>
    body{margin:0;display:flex;flex-direction:column;min-height:100vh}
    
    /* Topbar Styles */
    .topbar{position:sticky;top:0;z-index:100;background:rgba(255,255,255,.95);backdrop-filter:saturate(160%) blur(10px);border-bottom:1px solid rgba(0,0,0,.08);box-shadow:0 2px 8px rgba(0,0,0,.04)}
    .topbar-inner{display:flex;align-items:center;justify-content:space-between;padding:12px 20px;max-width:1400px;margin:0 auto}
    .topbar-actions{display:flex;align-items:center;gap:10px;margin-left:auto}
    
    .admin-layout{display:flex;flex:1;overflow:hidden}
    .admin-sidebar{width:220px;background:rgba(255,255,255,.92);border-right:1px solid rgba(0,0,0,.08);overflow-y:auto;flex-shrink:0}
    .admin-main{flex:1;overflow-y:auto;background:linear-gradient(135deg,var(--bg1),var(--bg2))}
    .wrap{max-width:1180px;margin:0 auto;padding:24px 16px}
    .login-center{display:flex;justify-content:center;margin:8px 0 14px}
    .login-card{width:min(560px,100%);text-align:center}
    .grid{display:grid;grid-template-columns:1fr;gap:14px;max-width:1080px;margin:0 auto}
    @media (max-width:900px){.grid{grid-template-columns:1fr}}
    .card{border-radius:18px;border:1px solid rgba(0,0,0,.08);background:rgba(255,255,255,.88);padding:14px;margin-bottom:14px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    input,select{border-radius:12px;border:1px solid rgba(0,0,0,.12);padding:10px 12px;font-size:14px;outline:none;background:#fff}
    .form-select{width:100%}
    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid rgba(0,0,0,.08);padding:10px 8px;text-align:left;font-size:13px}
    th{font-size:12px;color:var(--muted);font-weight:800}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:999px;border:1px solid rgba(0,0,0,.10);font-size:12px;background:rgba(255,255,255,.8)}
    .danger{color:#b00020}
    .small{color:var(--muted)}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
    .disabled-area{opacity:.58;position:relative;pointer-events:none}
    .disabled-area::after{content:"ç™»å½•åå¯æ“ä½œ";position:absolute;right:12px;top:10px;font-size:12px;color:#7a2f56;background:#fff;border:1px solid rgba(0,0,0,.08);padding:3px 8px;border-radius:999px}
    
    /* Sidebar Menu Styles */
    .menu-category{padding:20px 16px 8px;font-size:11px;font-weight:800;color:var(--muted);text-transform:uppercase;letter-spacing:.5px}
    .menu-item{display:flex;align-items:center;gap:10px;padding:10px 16px;cursor:pointer;transition:.18s ease;text-decoration:none;color:var(--text);border-left:3px solid transparent}
    .menu-item:hover{background:rgba(124,131,253,.08)}
    .menu-item.active{background:linear-gradient(to right,rgba(124,131,253,.12),transparent);border-left-color:var(--primary);font-weight:700}
    .menu-item svg{width:18px;height:18px;flex-shrink:0}
    .menu-separator{height:1px;background:rgba(0,0,0,.06);margin:8px 16px}
    
    /* Content Sections */
    .content-section{display:none}
    .content-section.active{display:block}
    
    @media (max-width:768px){
      .admin-layout{flex-direction:column}
      .admin-sidebar{width:100%;border-right:0;border-bottom:1px solid rgba(0,0,0,.08);max-height:200px}
      .menu-category{padding:12px 16px 6px}
      .menu-item{padding:8px 16px}
    }
  </style>
</head>
<body>
  <header class="topbar">
    <div class="topbar-inner">
      <a class="brand" href="/"><span class="logo">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
          <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
        </svg>
      </span><span>ç®¡ç†æ§åˆ¶å°</span></a>
      <div class="topbar-actions">
        <button class="btn btn-ghost" id="logoutBtn" style="display:none">é€€å‡º</button>
      </div>
    </div>
  </header>

  <div id="authTip" class="card" style="margin:12px auto;max-width:1180px">
    <b>å®‰å…¨æç¤ºï¼š</b>ä½ å·²ç™»å½•ï¼Œå¯åœ¨ä¸‹æ–¹ç®¡ç†æ¿€æ´»ç ã€ç«™ç‚¹å±•ç¤ºå­—æ®µä¸ç»Ÿè®¡ä»£ç ã€‚
  </div>

  <div class="admin-layout" id="adminLayout" style="display:none">
    <!-- Left Sidebar Menu -->
    <aside class="admin-sidebar">
      <div class="menu-category">ä»ªè¡¨ç›˜</div>
      <a class="menu-item active" data-section="dashboard">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="3" y="3" width="7" height="7"></rect>
          <rect x="14" y="3" width="7" height="7"></rect>
          <rect x="14" y="14" width="7" height="7"></rect>
          <rect x="3" y="14" width="7" height="7"></rect>
        </svg>
        <span>æ•°æ®æ¦‚è§ˆ</span>
      </a>
      
      <div class="menu-separator"></div>
      <div class="menu-category">æ¿€æ´»ç ç®¡ç†</div>
      <a class="menu-item" data-section="codes">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
          <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
        </svg>
        <span>æ¿€æ´»ç åˆ—è¡¨</span>
      </a>
      
      <div class="menu-separator"></div>
      <div class="menu-category">å†…å®¹ç®¡ç†</div>
      <a class="menu-item" data-section="carousel">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="2" y="7" width="20" height="14" rx="2" ry="2"></rect>
          <path d="M16 3h2a2 2 0 0 1 2 2v2M8 3H6a2 2 0 0 0-2 2v2"></path>
        </svg>
        <span>è½®æ’­å›¾ç®¡ç†</span>
      </a>
      <a class="menu-item" data-section="featured">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon>
        </svg>
        <span>ç²¾é€‰å†…å®¹</span>
      </a>
      <a class="menu-item" data-section="tests">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
          <polyline points="14 2 14 8 20 8"></polyline>
          <line x1="16" y1="13" x2="8" y2="13"></line>
          <line x1="16" y1="17" x2="8" y2="17"></line>
          <polyline points="10 9 9 9 8 9"></polyline>
        </svg>
        <span>é‡è¡¨ç®¡ç†</span>
      </a>
      <a class="menu-item" data-section="categories">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="3" y="3" width="7" height="7"></rect>
          <rect x="14" y="3" width="7" height="7"></rect>
          <rect x="14" y="14" width="7" height="7"></rect>
          <rect x="3" y="14" width="7" height="7"></rect>
        </svg>
        <span>åˆ†ç±»ç®¡ç†</span>
      </a>
      
      <div class="menu-separator"></div>
      <div class="menu-category">ç³»ç»Ÿè®¾ç½®</div>
      <a class="menu-item" data-section="site">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="10"></circle>
          <line x1="2" y1="12" x2="22" y2="12"></line>
          <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path>
        </svg>
        <span>ç«™ç‚¹ä¿¡æ¯</span>
      </a>
      <a class="menu-item" data-section="seo">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="11" cy="11" r="8"></circle>
          <path d="m21 21-4.35-4.35"></path>
        </svg>
        <span>SEOè®¾ç½®</span>
      </a>
      
      <div class="menu-separator"></div>
      <div class="menu-category">è¿è¥åˆ†æ</div>
      <a class="menu-item" data-section="analytics">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="12" y1="20" x2="12" y2="10"></line>
          <line x1="18" y1="20" x2="18" y2="4"></line>
          <line x1="6" y1="20" x2="6" y2="16"></line>
        </svg>
        <span>æ•°æ®åˆ†æ</span>
      </a>
      <a class="menu-item" data-section="source">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
          <circle cx="12" cy="10" r="3"></circle>
        </svg>
        <span>æ¥æºè¿½è¸ª</span>
      </a>
      <a class="menu-item" data-section="referral">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
          <circle cx="9" cy="7" r="4"></circle>
          <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
          <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
        </svg>
        <span>åˆ†é”€ç®¡ç†</span>
      </a>
    </aside>

    <!-- Main Content Area -->
    <main class="admin-main">
      <div class="wrap">
        
        <!-- Dashboard Overview Section -->
        <div class="content-section active" id="section-dashboard">
          <section class="card">
            <h3 style="margin:0 0 10px">ğŸ“Š æ•°æ®æ¦‚è§ˆ</h3>
            <div class="small" id="stats"></div>
          </section>
        </div>

        <!-- Activation Codes Section -->
        <div class="content-section" id="section-codes">
          <section class="card" id="dashboardCard">
            <div class="row" style="justify-content:space-between">
              <div>
                <h3 style="margin:0 0 6px">æ¿€æ´»ç åˆ—è¡¨</h3>
              </div>
              <div class="row">
                <input id="q" placeholder="æœç´¢ code..." />
                <button class="btn btn-ghost" id="refreshBtn">åˆ·æ–°</button>
              </div>
            </div>

            <div style="overflow:auto;margin-top:10px">
              <table>
                <thead>
                  <tr>
                    <th>Code</th>
                    <th>çŠ¶æ€</th>
                    <th>ä½¿ç”¨</th>
                    <th>è¿‡æœŸ</th>
                    <th>æ¿€æ´»æœ‰æ•ˆæœŸ</th>
                    <th>å¤‡æ³¨</th>
                    <th>æ“ä½œ</th>
                  </tr>
                </thead>
                <tbody id="tbody"></tbody>
              </table>
            </div>
          </section>
          
          <section class="card" id="manageBox" style="margin-top:14px">
            <h3 style="margin:0 0 10px">æ‰¹é‡ç”Ÿæˆæ¿€æ´»ç </h3>
            <div class="row" style="gap:14px 10px">
              <label class="small" style="flex:1 1 120px">æ•°é‡<br/><input id="count" type="number" min="1" max="500" value="20" style="width:100%"/></label>
              <label class="small" style="flex:1 1 120px">å‰ç¼€<br/><input id="prefix" value="H" style="width:100%"/></label>
              <label class="small" style="flex:1 1 140px">æ¯ç å¯ç”¨æ¬¡æ•°<br/><input id="maxUses" type="number" min="1" value="1" style="width:100%"/></label>
              <label class="small" style="flex:1 1 140px">æ¿€æ´»åæœ‰æ•ˆå¤©æ•°<br/><input id="grantDays" type="number" min="1" value="3" style="width:100%"/></label>
            </div>
            <div class="row" style="gap:14px 10px;margin-top:10px">
              <label class="small" style="flex:1 1 220px">å¤‡æ³¨ï¼ˆå¯é€‰ï¼‰<br/><input id="note" style="width:100%" placeholder="å¦‚ï¼š2æœˆæ´»åŠ¨æ‰¹æ¬¡"/></label>
              <label class="small" style="flex:1 1 220px">ç æœ¬èº«è¿‡æœŸæ—¶é—´ï¼ˆå¯é€‰ï¼‰<br/><input id="expiresAt" type="datetime-local" style="width:100%"/></label>
            </div>
            <div class="row" style="margin-top:10px">
              <button class="btn btn-primary" id="createBtn">ç”Ÿæˆæ¿€æ´»ç </button>
              <button class="btn btn-ghost" id="destroyExpiredBtn">æ¸…ç†å·²è¿‡æœŸæ¿€æ´»ç </button>
            </div>
            <div id="createdBox" class="small" style="margin-top:10px"></div>
          </section>
        </div>

        <!-- Carousel Management Section -->
        <div class="content-section" id="section-carousel">
          <section class="card">
            <div class="row" style="justify-content:space-between">
              <h3 style="margin:0">ğŸï¸ è½®æ’­å›¾ç®¡ç†</h3>
              <div class="row">
                <button class="btn btn-primary" id="addCarouselBtn">æ·»åŠ è½®æ’­</button>
                <button class="btn btn-ghost" id="refreshCarouselBtn">åˆ·æ–°</button>
              </div>
            </div>
            <div id="carouselList" style="margin-top:14px"></div>
          </section>
        </div>

        <!-- Featured Content Section -->
        <div class="content-section" id="section-featured">
          <section class="card">
            <div class="row" style="justify-content:space-between">
              <h3 style="margin:0">â­ ç²¾é€‰å†…å®¹ç®¡ç†</h3>
              <button class="btn btn-ghost" id="refreshFeaturedBtn">åˆ·æ–°</button>
            </div>
            <div id="featuredContentList" style="margin-top:14px"></div>
          </section>
        </div>

        <!-- Tests Management Section -->
        <div class="content-section" id="section-tests">
          <section class="card">
            <div class="row" style="justify-content:space-between;margin-bottom:14px">
              <h3 style="margin:0">ğŸ“ é‡è¡¨ç®¡ç†</h3>
              <div class="row">
                <button class="btn btn-primary" id="addTestBtn">æ–°å¢é‡è¡¨</button>
                <button class="btn btn-ghost" id="downloadTemplateBtn">ä¸‹è½½æ¨¡æ¿</button>
                <button class="btn btn-ghost" id="refreshTestsBtn">åˆ·æ–°</button>
              </div>
            </div>
            
            <div class="row" style="gap:10px;margin-bottom:10px">
              <label class="small" style="flex:1 1 200px">
                æŒ‰åˆ†ç±»ç­›é€‰
                <select id="testCategoryFilter" class="form-select" style="margin-top:4px">
                  <option value="">å…¨éƒ¨åˆ†ç±»</option>
                </select>
              </label>
              <label class="small" style="flex:1 1 200px">
                æœç´¢æµ‹è¯•
                <input id="testSearchInput" placeholder="æœç´¢ ID æˆ–æ ‡é¢˜..." style="width:100%;margin-top:4px" />
              </label>
            </div>
            
            <div style="overflow:auto;margin-top:10px">
              <table>
                <thead><tr><th>ID</th><th>æ ‡é¢˜</th><th>åˆ†ç±»</th><th>é¢˜æ•°</th><th>é¢„è®¡æ—¶é—´</th><th>æ“ä½œ</th></tr></thead>
                <tbody id="testsTbody"></tbody>
              </table>
            </div>
          </section>
        </div>

        <!-- Categories Management Section -->
        <div class="content-section" id="section-categories">
          <section class="card">
            <div class="row" style="justify-content:space-between">
              <h3 style="margin:0">ğŸ“ åˆ†ç±»ç®¡ç†</h3>
              <div class="row">
                <button class="btn btn-primary" id="addCategoryBtn">æ–°å¢åˆ†ç±»</button>
                <button class="btn btn-ghost" id="refreshCategoriesBtn">åˆ·æ–°</button>
              </div>
            </div>
            <div id="categoriesList" style="margin-top:14px"></div>
          </section>
        </div>

        <!-- Site Settings Section -->
        <div class="content-section" id="section-site">
          <section class="card">
            <h3 style="margin:0 0 10px">ğŸŒ ç«™ç‚¹ä¿¡æ¯è®¾ç½®</h3>
            <div class="row" style="gap:14px 10px">
              <label class="small" style="flex:1 1 220px">ç«™ç‚¹åç§°<br/><input id="siteName" style="width:100%"/></label>
              <label class="small" style="flex:1 1 220px">å‰¯æ ‡é¢˜<br/><input id="siteSub" style="width:100%"/></label>
            </div>
            <div class="row" style="gap:14px 10px;margin-top:10px">
              <label class="small" style="flex:1 1 220px">ICPå¤‡æ¡ˆå·<br/><input id="siteIcp" style="width:100%"/></label>
              <label class="small" style="flex:1 1 220px">ç»Ÿè®¡ä»£ç ï¼ˆå¯é€‰ï¼Œæ”¯æŒ script æˆ–çº¯æ–‡æœ¬ï¼‰<br/><textarea id="siteAnalytics" style="width:100%;min-height:88px;border-radius:12px;border:1px solid rgba(0,0,0,.12);padding:10px"></textarea></label>
            </div>
            <div class="row" style="margin-top:10px">
              <button class="btn btn-primary" id="saveSiteBtn">ä¿å­˜ç«™ç‚¹ä¿¡æ¯</button>
            </div>
          </section>
        </div>

        <!-- SEO Settings Section -->
        <div class="content-section" id="section-seo">
          <section class="card">
            <h3 style="margin:0 0 10px">ğŸ” SEO ä¼˜åŒ–è®¾ç½®</h3>
            <div class="row" style="gap:14px 10px">
              <label class="small" style="flex:1 1 220px">å…¨å±€æ ‡é¢˜ï¼ˆtitleï¼‰<br/><input id="seoTitle" style="width:100%"/></label>
              <label class="small" style="flex:1 1 220px">å…¨å±€æè¿°ï¼ˆdescriptionï¼‰<br/><textarea id="seoDesc" style="width:100%;min-height:60px;border-radius:12px;border:1px solid rgba(0,0,0,.12);padding:10px"></textarea></label>
            </div>
            <div class="row" style="gap:14px 10px;margin-top:10px">
              <label class="small" style="flex:1 1 220px">å…¨å±€å…³é”®è¯ï¼ˆkeywordsï¼‰<br/><input id="seoKeywords" style="width:100%"/></label>
              <label class="small" style="flex:1 1 220px">OG å›¾ç‰‡ URL<br/><input id="seoOgImage" style="width:100%"/></label>
            </div>
            <div class="row" style="gap:14px 10px;margin-top:10px">
              <label class="small" style="flex:1 1 220px">ç½‘ç«™åŸŸåï¼ˆå« https://ï¼‰<br/><input id="seoCanonical" style="width:100%" placeholder="https://example.com"/></label>
              <label class="small" style="flex:1 1 140px">Sitemap æ›´æ–°é¢‘ç‡<br/>
                <select id="seoFreq" style="width:100%;border-radius:12px;border:1px solid rgba(0,0,0,.12);padding:10px">
                  <option value="daily">æ¯å¤©</option>
                  <option value="weekly" selected>æ¯å‘¨</option>
                  <option value="monthly">æ¯æœˆ</option>
                </select>
              </label>
              <label class="small" style="flex:1 1 160px;display:flex;align-items:center;gap:8px;margin-top:18px">
                <input type="checkbox" id="seoAutoSitemap" checked/> è‡ªåŠ¨ç”Ÿæˆ sitemap.xml
              </label>
            </div>
            <div class="row" style="gap:14px 10px;margin-top:10px">
              <label class="small" style="flex:1">robots.txt é¢å¤–è§„åˆ™ï¼ˆå¯é€‰ï¼‰<br/><textarea id="seoRobotsExtra" style="width:100%;min-height:80px;border-radius:12px;border:1px solid rgba(0,0,0,.12);padding:10px;font-family:monospace" placeholder="ä¾‹ï¼š&#10;Disallow: /private/"></textarea></label>
            </div>
            <div class="row" style="margin-top:10px">
              <button class="btn btn-primary" id="saveSeoBtn">ä¿å­˜ SEO è®¾ç½®</button>
            </div>
          </section>
        </div>

        <!-- Analytics Section -->
        <div class="content-section" id="section-analytics">
          <section class="card">
            <h3 style="margin:0 0 10px">ğŸ“Š å®æ—¶è¿è¥æ•°æ®</h3>
            <div id="analyticsBody" class="small">åŠ è½½ä¸­â€¦</div>
          </section>
        </div>

        <!-- Source Tracking Section -->
        <div class="content-section" id="section-source">
          <section class="card">
            <h3 style="margin:0 0 10px">ğŸ“ ç”¨æˆ·æ¥æºè¿½è¸ª</h3>
            <div id="sourceBody" class="small">åŠ è½½ä¸­â€¦</div>
          </section>
        </div>

        <!-- Referral Management Section -->
        <div class="content-section" id="section-referral">
          <section class="card">
            <div class="row" style="justify-content:space-between">
              <h3 style="margin:0">ğŸ”— åˆ†é”€ç®¡ç†</h3>
              <button class="btn btn-ghost" id="refreshRefBtn">åˆ·æ–°</button>
            </div>
            <div class="row" style="gap:10px;margin-top:10px">
              <label class="small" style="flex:1">åˆ†é”€å‘˜åç§°<br/><input id="refName" style="width:100%" placeholder="ä¾‹: å¼ ä¸‰"/></label>
              <label class="small" style="flex:1">ä½£é‡‘æ¯”ä¾‹ (%)<br/><input id="refCommission" type="number" min="0" max="100" value="10" style="width:100%"/></label>
              <label class="small" style="flex:1">å¤‡æ³¨<br/><input id="refNote" style="width:100%"/></label>
              <div style="align-self:flex-end"><button class="btn btn-primary" id="createRefBtn">åˆ›å»ºåˆ†é”€ç </button></div>
            </div>
            <div id="refCreatedBox" class="small" style="margin-top:8px"></div>
            <div style="overflow:auto;margin-top:10px">
              <table>
                <thead><tr><th>åˆ†é”€ç </th><th>åç§°</th><th>ä½£é‡‘</th><th>è®¢å•æ•°</th><th>çŠ¶æ€</th><th>æ“ä½œ</th></tr></thead>
                <tbody id="refTbody"></tbody>
              </table>
            </div>
          </section>
        </div>

      </div>
    </main>
  </div>

  <!-- Test Editor Overlay (JSON-based) -->
  <div id="testEditorOverlay" style="display:none;position:fixed;inset:0;z-index:9000;background:rgba(0,0,0,.45);overflow-y:auto">
    <div style="max-width:900px;margin:40px auto;padding:20px;background:#fff;border-radius:18px;box-shadow:0 20px 60px rgba(0,0,0,.2)">
      <div class="row" style="justify-content:space-between">
        <h3 style="margin:0" id="editorTitle">ç¼–è¾‘é‡è¡¨</h3>
        <button class="btn btn-ghost" id="closeEditorBtn">å…³é—­</button>
      </div>
      
      <!-- Tabs for switching between metadata form and JSON editor -->
      <div style="margin-top:14px;border-bottom:1px solid rgba(0,0,0,.1);display:flex;gap:4px">
        <button class="btn btn-ghost" id="metadataTabBtn" style="border-radius:8px 8px 0 0;border-bottom:2px solid var(--primary)">å…ƒæ•°æ®ç¼–è¾‘</button>
        <button class="btn btn-ghost" id="jsonTabBtn" style="border-radius:8px 8px 0 0">JSON ç¼–è¾‘</button>
      </div>
      
      <!-- Metadata Form Editor -->
      <div id="metadataFormSection" style="margin-top:14px">
        <p class="small" style="margin:0 0 10px;line-height:1.6">
          ç¼–è¾‘é‡è¡¨çš„å…ƒæ•°æ®å­—æ®µï¼ˆæ ‡é¢˜ã€ç®€ä»‹ã€ä½œç­”æ–¹å¼ã€è¯´æ˜ä¸æé†’ç­‰ï¼‰ã€‚ä¿®æ”¹åç‚¹å‡»"åº”ç”¨åˆ° JSON"å°†æ›´æ–° JSON ç¼–è¾‘å™¨å†…å®¹ã€‚
        </p>
        
        <div style="display:flex;flex-direction:column;gap:12px">
          <label class="small">
            ID *
            <input id="metaId" style="width:100%;margin-top:4px" placeholder="test-id"/>
          </label>
          
          <label class="small">
            æ ‡é¢˜ *
            <input id="metaTitle" style="width:100%;margin-top:4px" placeholder="æµ‹è¯•æ ‡é¢˜"/>
          </label>
          
          <label class="small">
            åˆ†ç±» *
            <input id="metaCategory" style="width:100%;margin-top:4px" placeholder="å¿ƒç†æµ‹è¯„"/>
          </label>
          
          <label class="small">
            ç®€ä»‹
            <textarea id="metaIntro" style="width:100%;min-height:60px;border-radius:12px;border:1px solid rgba(0,0,0,.12);padding:10px;margin-top:4px" placeholder="æµ‹è¯•ç®€ä»‹"></textarea>
          </label>
          
          <label class="small">
            æ ‡ç­¾ï¼ˆé€—å·åˆ†éš”ï¼‰
            <input id="metaTags" style="width:100%;margin-top:4px" placeholder="æ ‡ç­¾1, æ ‡ç­¾2, æ ‡ç­¾3"/>
          </label>
          
          <label class="small">
            é¢„è®¡æ—¶é—´ï¼ˆåˆ†é’Ÿï¼‰
            <input id="metaEstimated" type="number" min="1" style="width:100%;margin-top:4px" placeholder="10"/>
          </label>
          
          <hr style="border:none;border-top:1px solid rgba(0,0,0,.08);margin:6px 0"/>
          <h4 style="margin:6px 0">ä½œç­”æ–¹å¼ï¼ˆcontent.howtoï¼‰</h4>
          <p class="small" style="margin:0">æ¯è¡Œä¸€æ¡å»ºè®®ï¼Œè‡ªåŠ¨è½¬æ¢ä¸ºåˆ—è¡¨é¡¹ã€‚ç•™ç©ºåˆ™ä½¿ç”¨ç³»ç»Ÿé»˜è®¤ã€‚</p>
          <textarea id="metaHowto" style="width:100%;min-height:100px;border-radius:12px;border:1px solid rgba(0,0,0,.12);padding:10px" placeholder="ä¾‹å¦‚ï¼š&#10;æŒ‰æœ€è¿‘ä¸¤å‘¨çŠ¶æ€ä½œç­”ï¼Œæ›´èƒ½åæ˜ å½“å‰å‹åŠ›ä¸æƒ…ç»ªå˜åŒ–ã€‚&#10;ä¸å¿…è¿½æ±‚"å¥½ç­”æ¡ˆ"ï¼ŒçœŸå®ä½œç­”æ›´æœ‰æ„ä¹‰ã€‚"></textarea>
          
          <h4 style="margin:6px 0">è¯´æ˜ä¸æé†’ï¼ˆcontent.aboutï¼‰</h4>
          <p class="small" style="margin:0">æ¯è¡Œä¸€æ¡è¯´æ˜ï¼Œè‡ªåŠ¨è½¬æ¢ä¸ºåˆ—è¡¨é¡¹ã€‚ç•™ç©ºåˆ™ä½¿ç”¨ç³»ç»Ÿé»˜è®¤ã€‚</p>
          <textarea id="metaAbout" style="width:100%;min-height:100px;border-radius:12px;border:1px solid rgba(0,0,0,.12);padding:10px" placeholder="ä¾‹å¦‚ï¼š&#10;æœ¬ç»“æœä¸æ›¿ä»£ä¸´åºŠè¯Šæ–­æˆ–æ²»ç–—å»ºè®®ã€‚&#10;è‹¥ä½ æŒç»­æ„Ÿåˆ°ç—›è‹¦ï¼Œè¯·åŠæ—¶è”ç³»ä¸“ä¸šæœºæ„ã€‚"></textarea>
        </div>
        
        <div class="row" style="margin-top:14px;gap:10px">
          <button class="btn btn-primary" id="applyMetadataBtn">åº”ç”¨åˆ° JSON</button>
          <button class="btn btn-ghost" id="loadFromJsonBtn">ä» JSON åŠ è½½</button>
        </div>
      </div>
      
      <!-- JSON Editor Section -->
      <div id="jsonEditorSection" style="margin-top:14px;display:none">
        <p class="small" style="margin:0 0 10px;line-height:1.6">
          ç¼–è¾‘è¯¥é‡è¡¨çš„å®Œæ•´ JSON æ•°æ®ã€‚ä¿®æ”¹åç‚¹å‡»"ä¿å­˜"å³å¯æ›´æ–°ã€‚<br/>
          åŒ…å«å­—æ®µï¼šid, title, category, tags, intro, estimated, mode, rule, questions, content
        </p>
        
        <div style="margin-top:10px">
          <label class="small">é‡è¡¨ JSON æ•°æ®<br/>
            <textarea id="testJsonEditor" 
              style="width:100%;min-height:500px;border-radius:12px;border:1px solid rgba(0,0,0,.12);padding:12px;font-family:ui-monospace,monospace;font-size:13px;line-height:1.5"
              placeholder='{"id": "test-id", "title": "æµ‹è¯•æ ‡é¢˜", ...}'></textarea>
          </label>
        </div>
        
        <div class="row" style="margin-top:14px;gap:10px">
          <button class="btn btn-primary" id="saveTestBtn">ä¿å­˜é‡è¡¨</button>
          <button class="btn btn-ghost" id="formatJsonBtn">æ ¼å¼åŒ– JSON</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    const API = "/api/admin.php";
    const stKey = "adminToken";
    const $ = (s) => document.querySelector(s);
    const fmt = (ts) => {
      if(!ts) return "-";
      const d = new Date(ts*1000);
      const p = (n)=> String(n).padStart(2,"0");
      return `${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())} ${p(d.getHours())}:${p(d.getMinutes())}`;
    };

    // Global HTML escaping utility
    function escapeHtml(str){
      const div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }

    function getToken(){ return localStorage.getItem(stKey) || ""; }
    function setAuthedUI(ok){
      const layout = document.getElementById("adminLayout");
      const tip = document.getElementById("authTip");
      if(layout) layout.style.display = ok ? "flex" : "none";
      if(tip) tip.style.display = "none";
      const logout = document.getElementById("logoutBtn");
      if(logout) logout.style.display = ok ? "" : "none";
    }
    function setToken(t){ if(t) localStorage.setItem(stKey,t); else localStorage.removeItem(stKey); }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // Sidebar Navigation
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function initSidebarNavigation(){
      document.querySelectorAll(".menu-item").forEach(item => {
        item.addEventListener("click", (e) => {
          e.preventDefault();
          const section = item.dataset.section;
          if(!section) return;
          
          // Hide all sections
          document.querySelectorAll(".content-section").forEach(s => s.classList.remove("active"));
          
          // Show selected section
          const targetSection = document.getElementById(`section-${section}`);
          if(targetSection) targetSection.classList.add("active");
          
          // Update menu active state
          document.querySelectorAll(".menu-item").forEach(m => m.classList.remove("active"));
          item.classList.add("active");
          
          // Load section data if needed
          if(section === "carousel") loadCarousel();
          if(section === "featured") loadFeaturedContent();
        });
      });
    }

    async function call(action, payload={}){
      const body = { action, ...payload };
      if(action !== "login") body.adminToken = getToken();
      const r = await fetch(API, { method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(body) });
      const j = await r.json().catch(()=>({ok:false,error:"bad_json"}));
      if(!j.ok) throw j;
      return j;
    }
    async function createCodes(){
      const count = Number($("#count").value||20);
      const prefix = $("#prefix").value.trim() || "H";
      const maxUses = Number($("#maxUses").value||1);
      const grantDays = Number($("#grantDays").value||3);
      const note = $("#note").value.trim();
      let expiresAt = 0;
      const dt = $("#expiresAt").value;
      if(dt){
        expiresAt = Math.floor(new Date(dt).getTime()/1000);
      }
      const j = await call("createCodes", { count, prefix, maxUses, grantDays, note, expiresAt });
      $("#createdBox").innerHTML = `<div class="pill">å·²ç”Ÿæˆ ${j.created.length} ä¸ª</div>
        <div style="margin-top:8px" class="mono">${j.created.join("<br/>")}</div>`;
      await refreshAll();
    }

    async function refreshAll(){
      if(!getToken()){ location.href="/XyJoe7/"; return; }
      try{
        const s = await call("stats");
        $("#stats").textContent = `æ€»æ•° ${s.stats.total} Â· å·²åœç”¨ ${s.stats.disabled} Â· å·²è¿‡æœŸ ${s.stats.expired} Â· ç”¨å°½ ${s.stats.usedUp} Â· æ´»è·ƒä¼šè¯ ${s.stats.activeSessions}`;
      }catch(e){
        $("#stats").textContent = "æœªç™»å½•æˆ–é…ç½®æœªå®Œæˆ";
      }
      await listCodes();
      await loadSiteSettings();
      await loadAnalytics();
      await loadSourceReport();
      await loadTests();
      await loadReferrers();
      await loadSeoSettings();
      await loadCarousel();
      await loadFeaturedContent();
      await loadCategories();
    }

    function statusBadge(c){
      const t = Math.floor(Date.now()/1000);
      const exp = Number(c.expiresAt||0);
      const uses = Number(c.uses||0);
      const max = Number(c.maxUses||1);
      if(c.disabled) return `<span class="pill danger">åœç”¨</span>`;
      if(exp && exp < t) return `<span class="pill danger">è¿‡æœŸ</span>`;
      if(uses >= max) return `<span class="pill">ç”¨å°½</span>`;
      return `<span class="pill">å¯ç”¨</span>`;
    }

    async function listCodes(){
      const q = $("#q").value.trim();
      const j = await call("listCodes", { q });
      const rows = j.codes.map(c => {
        const exp = c.expiresAt ? fmt(c.expiresAt) : "æ°¸ä¸è¿‡æœŸ";
        const note = (c.meta && c.meta.note) ? c.meta.note : "-";
        return `
          <tr>
            <td class="mono">${c.code}</td>
            <td>${statusBadge(c)}</td>
            <td>${c.uses||0}/${c.maxUses||1}</td>
            <td>${exp}</td>
            <td>${c.grantDays||3} å¤©</td>
            <td>${note}</td>
            <td class="row">
              <button class="btn btn-ghost" data-toggle="${c.code}" data-disabled="${c.disabled?0:1}">${c.disabled?"å¯ç”¨":"åœç”¨"}</button>
              <button class="btn btn-ghost" data-del="${c.code}" style="border-color:rgba(176,0,32,.25)">åˆ é™¤</button>
            </td>
          </tr>
        `;
      }).join("");
      $("#tbody").innerHTML = rows || `<tr><td colspan="7" class="small">æš‚æ— æ•°æ®</td></tr>`;

      document.querySelectorAll("[data-toggle]").forEach(btn=>{
        btn.addEventListener("click", async ()=>{
          const code = btn.getAttribute("data-toggle");
          const disabled = Number(btn.getAttribute("data-disabled")) === 1;
          await call("toggleCode", { code, disabled });
          await refreshAll();
        });
      });
      document.querySelectorAll("[data-del]").forEach(btn=>{
        btn.addEventListener("click", async ()=>{
          const code = btn.getAttribute("data-del");
          if(!confirm(`ç¡®å®šåˆ é™¤å¹¶é”€æ¯ä¼šè¯ï¼Ÿ\n${code}`)) return;
          await call("deleteCode", { code });
          await refreshAll();
        });
      });
    }

    async function loadSiteSettings(){
      const j = await call("getSiteSettings");
      $("#siteName").value = j.settings.siteName || "";
      $("#siteSub").value = j.settings.siteSub || "";
      $("#siteIcp").value = j.settings.icp || "";
      $("#siteAnalytics").value = j.settings.analyticsCode || "";
    }

    async function saveSiteSettings(){
      await call("updateSiteSettings", {
        siteName: $("#siteName").value,
        siteSub: $("#siteSub").value,
        icp: $("#siteIcp").value,
        analyticsCode: $("#siteAnalytics").value
      });
      toast("ç«™ç‚¹ä¿¡æ¯å·²ä¿å­˜");
    }

async function destroyExpired(){
      const j = await call("destroyExpired");
      toast(`å·²é”€æ¯ ${j.removed} ä¸ªè¿‡æœŸç `);
      await refreshAll();
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // è¿è¥æ•°æ®æ±‡æ€»
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    async function loadAnalytics(){
      try{
        const j = await call("getAnalytics");
        const a = j.analytics;
        const c = a.codes;
        const s = a.sessions;
        const r = a.referrals;
        const tc = a.testCompletions;
        const popular = Object.entries(a.popularTests||{}).map(([k,v])=>`<span class="pill">${k}: ${v}æ¬¡</span>`).join(" ");
        $("#analyticsBody").innerHTML = `
          <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:10px;margin-bottom:12px">
            <div class="pill" style="padding:10px;text-align:center"><b>${c.total}</b><br/>æ¿€æ´»ç æ€»æ•°</div>
            <div class="pill" style="padding:10px;text-align:center"><b>${c.active}</b><br/>å¯ç”¨ç </div>
            <div class="pill" style="padding:10px;text-align:center"><b>${c.totalUses}</b><br/>æ€»ä½¿ç”¨æ¬¡æ•°</div>
            <div class="pill" style="padding:10px;text-align:center"><b>${s.today}</b><br/>ä»Šæ—¥æ–°ä¼šè¯</div>
            <div class="pill" style="padding:10px;text-align:center"><b>${s.week}</b><br/>è¿‘7å¤©ä¼šè¯</div>
            <div class="pill" style="padding:10px;text-align:center"><b>${s.month}</b><br/>è¿‘30å¤©ä¼šè¯</div>
            <div class="pill" style="padding:10px;text-align:center"><b>${s.active}</b><br/>æ´»è·ƒä¼šè¯</div>
            <div class="pill" style="padding:10px;text-align:center"><b>${r.total}</b><br/>åˆ†é”€è®¢å•</div>
            <div class="pill" style="padding:10px;text-align:center"><b>${tc.total}</b><br/>æµ‹è¯„å®Œæˆæ•°</div>
            <div class="pill" style="padding:10px;text-align:center"><b>${tc.today}</b><br/>ä»Šæ—¥å®Œæˆ</div>
          </div>
          ${popular ? `<div><b>çƒ­é—¨æµ‹è¯„ï¼š</b>${popular}</div>` : ""}
        `;
      }catch(e){ $("#analyticsBody").textContent = "åŠ è½½å¤±è´¥"; }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // æ¥æºè¿½è¸ª
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    async function loadSourceReport(){
      try{
        const j = await call("getSourceReport");
        const r = j.sourceReport;
        const srcRows = Object.entries(r.bySource||{}).map(([k,v])=>`<tr><td>${k}</td><td>${v}</td></tr>`).join("");
        const refRows = Object.entries(r.byReferral||{}).map(([k,v])=>`<tr><td class="mono">${k}</td><td>${v}</td></tr>`).join("");
        const utmRows = Object.entries(r.byCampaign||{}).map(([k,v])=>`<tr><td>${k}</td><td>${v}</td></tr>`).join("");
        $("#sourceBody").innerHTML = `
          <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:14px">
            <div>
              <b>æŒ‰æ¥æºæ¸ é“</b>
              <table><thead><tr><th>æ¸ é“</th><th>ä¼šè¯æ•°</th></tr></thead><tbody>${srcRows || '<tr><td colspan="2">æš‚æ— æ•°æ®</td></tr>'}</tbody></table>
            </div>
            <div>
              <b>æŒ‰åˆ†é”€ç </b>
              <table><thead><tr><th>åˆ†é”€ç </th><th>ä¼šè¯æ•°</th></tr></thead><tbody>${refRows || '<tr><td colspan="2">æš‚æ— æ•°æ®</td></tr>'}</tbody></table>
            </div>
            <div>
              <b>æŒ‰ UTM Campaign</b>
              <table><thead><tr><th>Campaign</th><th>ä¼šè¯æ•°</th></tr></thead><tbody>${utmRows || '<tr><td colspan="2">æš‚æ— æ•°æ®</td></tr>'}</tbody></table>
            </div>
          </div>
          <div class="small" style="margin-top:8px">æ€»ä¼šè¯æ•°ï¼š${r.totalSessions}</div>
        `;
      }catch(e){ $("#sourceBody").textContent = "åŠ è½½å¤±è´¥"; }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // é‡è¡¨ç®¡ç†
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    let _editingTestId = null;

    let testsData = []; // Store all tests for filtering
    
    async function loadTests(){
      try{
        const j = await call("listTests");
        testsData = j.tests || [];
        
        // Populate category filter dropdown
        const categories = [...new Set(testsData.map(t => t.category))].sort();
        const categoryFilter = $("#testCategoryFilter");
        if(categoryFilter){
          const currentValue = categoryFilter.value;
          categoryFilter.innerHTML = '<option value="">å…¨éƒ¨åˆ†ç±»</option>' + 
            categories.map(cat => `<option value="${cat}">${cat}</option>`).join("");
          categoryFilter.value = currentValue; // Restore selection
        }
        
        renderTests();
      }catch(e){ 
        $("#testsTbody").innerHTML = `<tr><td colspan="6" class="small">åŠ è½½å¤±è´¥</td></tr>`; 
      }
    }
    
    function renderTests(){
      const searchTerm = ($("#testSearchInput")?.value || "").toLowerCase().trim();
      const categoryFilter = $("#testCategoryFilter")?.value || "";
      
      let filtered = testsData;
      
      // Apply category filter
      if(categoryFilter){
        filtered = filtered.filter(t => t.category === categoryFilter);
      }
      
      // Apply search filter
      if(searchTerm){
        filtered = filtered.filter(t => 
          t.id.toLowerCase().includes(searchTerm) || 
          t.title.toLowerCase().includes(searchTerm)
        );
      }
      
      const rows = filtered.map(t => `
        <tr>
          <td class="mono">${t.id}</td>
          <td>${t.title}</td>
          <td>${t.category}</td>
          <td>${t.questionCount}</td>
          <td>${t.estimated||"-"} åˆ†é’Ÿ</td>
          <td class="row">
            <button class="btn btn-ghost" data-edit-test="${t.id}">ç¼–è¾‘</button>
            <button class="btn btn-ghost" data-export-test="${t.id}">å¯¼å‡º</button>
            <button class="btn btn-ghost" data-del-test="${t.id}" style="border-color:rgba(176,0,32,.25)">åˆ é™¤</button>
          </td>
        </tr>
      `).join("");
      
      $("#testsTbody").innerHTML = rows || `<tr><td colspan="6" class="small">æš‚æ— åŒ¹é…çš„é‡è¡¨</td></tr>`;

      document.querySelectorAll("[data-edit-test]").forEach(btn=>{
        btn.addEventListener("click", ()=> openTestEditor(btn.dataset.editTest));
      });
      document.querySelectorAll("[data-export-test]").forEach(btn=>{
        btn.addEventListener("click", ()=> exportTest(btn.dataset.exportTest));
      });
      document.querySelectorAll("[data-del-test]").forEach(btn=>{
        btn.addEventListener("click", async ()=>{
          if(!confirm(`ç¡®å®šåˆ é™¤é‡è¡¨ ${btn.dataset.delTest}ï¼Ÿ`)) return;
          await call("deleteTest", { id: btn.dataset.delTest });
          toast("å·²åˆ é™¤");
          await loadTests();
        });
      });
    }
    
    // Add event listeners for filtering
    $("#testCategoryFilter")?.addEventListener("change", renderTests);
    $("#testSearchInput")?.addEventListener("input", renderTests);

    async function exportTest(testId){
      try{
        const j = await call("exportTest", { id: testId });
        const dataStr = JSON.stringify(j.test, null, 2);
        const dataBlob = new Blob([dataStr], { type: 'application/json' });
        const url = URL.createObjectURL(dataBlob);
        const link = document.createElement('a');
        link.href = url;
        link.download = j.filename || (testId + '_export.json');
        link.click();
        URL.revokeObjectURL(url);
        toast("å·²å¯¼å‡º");
      }catch(e){
        toast(e.error || "å¯¼å‡ºå¤±è´¥");
      }
    }

    async function downloadTemplate(){
      try{
        const j = await call("getTestTemplate", {});
        if(!j.ok) throw new Error(j.error || "è·å–æ¨¡æ¿å¤±è´¥");
        const blob = new Blob([JSON.stringify(j.template, null, 2)], {type: 'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'test_import_template.json';
        a.click();
        URL.revokeObjectURL(url);
        toast("æ¨¡æ¿å·²ä¸‹è½½");
      }catch(e){
        toast(e.message || e.error || "ä¸‹è½½å¤±è´¥");
      }
    }

    async function openTestEditor(testId){
      _editingTestId = testId;
      
      if(testId){
        // Load existing test and show JSON
        const j = await call("getTest", { id: testId });
        const t = j.test;
        $("#testJsonEditor").value = JSON.stringify(t, null, 2);
        $("#editorTitle").textContent = "ç¼–è¾‘é‡è¡¨: " + t.id;
        
        // Populate metadata form
        $("#metaId").value = t.id || "";
        $("#metaTitle").value = t.title || "";
        $("#metaCategory").value = t.category || "";
        $("#metaIntro").value = t.intro || "";
        $("#metaTags").value = (t.tags || []).join(", ");
        $("#metaEstimated").value = t.estimated || 10;
        const content = t.content || {};
        $("#metaHowto").value = (content.howto || []).join('\n');
        $("#metaAbout").value = (content.about || []).join('\n');
      } else {
        // Create new test with template
        const template = {
          id: "your-test-id",
          title: "è¯·è¾“å…¥æµ‹è¯•æ ‡é¢˜",
          category: "å¿ƒç†æµ‹è¯„",
          tags: ["æµ‹è¯•"],
          intro: "è¯·è¾“å…¥æµ‹è¯•ç®€ä»‹",
          estimated: 10,
          mode: "score",
          rule: {
            scale: [0, 1, 2, 3, 4],
            labels: ["æ²¡æœ‰", "è½»å¾®", "ä¸­ç­‰", "æ˜æ˜¾", "ä¸¥é‡"],
            bands: [
              [0, 10, "ä½", "åˆ†æ•°è¾ƒä½"],
              [11, 22, "ä¸­", "åˆ†æ•°ä¸­ç­‰"],
              [23, 40, "é«˜", "åˆ†æ•°è¾ƒé«˜"]
            ],
            mode: "simple"
          },
          questions: [
            {
              q: "ç¤ºä¾‹é¢˜ç›®ï¼Ÿ",
              opts: [
                { t: "é€‰é¡¹1", v: 0 },
                { t: "é€‰é¡¹2", v: 1 },
                { t: "é€‰é¡¹3", v: 2 }
              ]
            }
          ]
        };
        $("#testJsonEditor").value = JSON.stringify(template, null, 2);
        $("#editorTitle").textContent = "æ–°å¢é‡è¡¨";
        
        // Populate metadata form with template
        $("#metaId").value = template.id;
        $("#metaTitle").value = template.title;
        $("#metaCategory").value = template.category;
        $("#metaIntro").value = template.intro;
        $("#metaTags").value = template.tags.join(", ");
        $("#metaEstimated").value = template.estimated;
        $("#metaHowto").value = "";
        $("#metaAbout").value = "";
      }
      
      // Show metadata tab by default
      $("#metadataFormSection").style.display = "block";
      $("#jsonEditorSection").style.display = "none";
      $("#metadataTabBtn").style.borderBottom = "2px solid var(--primary)";
      $("#jsonTabBtn").style.borderBottom = "none";
      
      $("#testEditorOverlay").style.display = "block";
    }

    async function saveTest(){
      try {
        const jsonText = $("#testJsonEditor").value.trim();
        if (!jsonText) {
          toast("è¯·è¾“å…¥é‡è¡¨ JSON æ•°æ®");
          return;
        }
        
        let data;
        try {
          data = JSON.parse(jsonText);
        } catch (e) {
          toast("JSON æ ¼å¼é”™è¯¯ï¼š" + e.message);
          return;
        }
        
        if (!data.id || !data.title) {
          toast("è¯·ç¡®ä¿ JSON åŒ…å« id å’Œ title å­—æ®µ");
          return;
        }
        
        if (_editingTestId) {
          await call("updateTest", { id: _editingTestId, test: data });
          toast("é‡è¡¨å·²æ›´æ–°");
        } else {
          await call("addTest", { test: data });
          toast("é‡è¡¨å·²æ·»åŠ ");
        }
        $("#testEditorOverlay").style.display = "none";
        await loadTests();
      } catch (e) {
        toast(e.error || "ä¿å­˜å¤±è´¥");
      }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // åˆ†é”€ç®¡ç†
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    async function loadReferrers(){
      try{
        const j = await call("listReferrers");
        const rows = j.referrers.map(r => `
          <tr>
            <td class="mono">${r.code}</td>
            <td>${r.name}</td>
            <td>${r.commissionPct}%</td>
            <td>${r.totalOrders||0}</td>
            <td>${r.disabled ? '<span class="pill danger">åœç”¨</span>' : '<span class="pill">æ´»è·ƒ</span>'}</td>
            <td class="row">
              <button class="btn btn-ghost" data-toggle-ref="${r.code}" data-disabled="${r.disabled?0:1}">${r.disabled?"å¯ç”¨":"åœç”¨"}</button>
              <button class="btn btn-ghost" data-del-ref="${r.code}" style="border-color:rgba(176,0,32,.25)">åˆ é™¤</button>
            </td>
          </tr>
        `).join("");
        $("#refTbody").innerHTML = rows || `<tr><td colspan="6" class="small">æš‚æ— åˆ†é”€å‘˜</td></tr>`;

        document.querySelectorAll("[data-toggle-ref]").forEach(btn=>{
          btn.addEventListener("click", async ()=>{
            await call("toggleReferrer", { code: btn.dataset.toggleRef, disabled: Number(btn.dataset.disabled)===1 });
            await loadReferrers();
          });
        });
        document.querySelectorAll("[data-del-ref]").forEach(btn=>{
          btn.addEventListener("click", async ()=>{
            if(!confirm(`ç¡®å®šåˆ é™¤åˆ†é”€ç  ${btn.dataset.delRef}ï¼Ÿ`)) return;
            await call("deleteReferrer", { code: btn.dataset.delRef });
            toast("å·²åˆ é™¤");
            await loadReferrers();
          });
        });
      }catch(e){ $("#refTbody").innerHTML = `<tr><td colspan="6" class="small">åŠ è½½å¤±è´¥</td></tr>`; }
    }

    async function createReferrer(){
      const name = $("#refName").value.trim();
      if(!name){ toast("è¯·å¡«å†™åç§°"); return; }
      const j = await call("createReferrer", {
        name,
        commissionPct: Number($("#refCommission").value) || 10,
        note: $("#refNote").value.trim(),
      });
      const refUrl = `${location.origin}/code?ref=${j.referralCode}`;
      $("#refCreatedBox").innerHTML = `<div class="pill">å·²åˆ›å»º: <span class="mono">${j.referralCode}</span></div>
        <div style="margin-top:4px">åˆ†é”€é“¾æ¥: <code class="mono" style="font-size:11px">${refUrl}</code></div>`;
      await loadReferrers();
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // SEO è®¾ç½®
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    async function loadSeoSettings(){
      try{
        const j = await call("getSeoSettings");
        const s = j.seo;
        $("#seoTitle").value = s.globalTitle || "";
        $("#seoDesc").value = s.globalDescription || "";
        $("#seoKeywords").value = s.globalKeywords || "";
        $("#seoOgImage").value = s.ogImage || "";
        $("#seoCanonical").value = s.canonical || "";
        $("#seoFreq").value = s.sitemapFreq || "weekly";
        $("#seoAutoSitemap").checked = s.autoSitemap !== false;
        $("#seoRobotsExtra").value = s.robotsExtra || "";
      }catch(e){}
    }

    async function saveSeoSettings(){
      await call("updateSeoSettings", {
        globalTitle: $("#seoTitle").value,
        globalDescription: $("#seoDesc").value,
        globalKeywords: $("#seoKeywords").value,
        ogImage: $("#seoOgImage").value,
        canonical: $("#seoCanonical").value,
        sitemapFreq: $("#seoFreq").value,
        autoSitemap: $("#seoAutoSitemap").checked,
        robotsExtra: $("#seoRobotsExtra").value,
      });
      toast("SEO è®¾ç½®å·²ä¿å­˜");
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // Carousel Management
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    let _carouselData = [];
    
    async function loadCarousel(){
      try{
        const j = await call("getCarousel");
        _carouselData = j.carousel || [];
        renderCarousel();
      }catch(e){ 
        $("#carouselList").innerHTML = `<div class="small">åŠ è½½å¤±è´¥</div>`;
      }
    }
    
    function renderCarousel(){
      const list = $("#carouselList");
      if(_carouselData.length === 0){
        list.innerHTML = `<div class="small">æš‚æ— è½®æ’­å›¾ï¼Œç‚¹å‡»"æ·»åŠ è½®æ’­"å¼€å§‹</div>`;
        return;
      }
      
      list.innerHTML = _carouselData.map((slide, idx) => {
        const escTitle = escapeHtml(slide.title || "æ— æ ‡é¢˜");
        const escDesc = escapeHtml(slide.description || "");
        const escLink = escapeHtml(slide.link || "-");
        const escImage = escapeHtml(slide.image || "");
        const escAlt = escapeHtml(slide.title || "è½®æ’­å›¾");
        return `
        <div class="card" style="margin-bottom:10px;padding:12px">
          <div class="row" style="gap:10px;align-items:start">
            <img src="${escImage}" alt="${escAlt}" style="width:120px;height:80px;object-fit:cover;border-radius:8px" onerror="this.style.display='none'"/>
            <div style="flex:1">
              <div class="row" style="justify-content:space-between">
                <b>${escTitle}</b>
                <div class="row">
                  <button class="btn btn-ghost" data-edit-carousel="${idx}" style="padding:4px 8px">ç¼–è¾‘</button>
                  <button class="btn btn-ghost" data-del-carousel="${idx}" style="padding:4px 8px;border-color:rgba(176,0,32,.25)">åˆ é™¤</button>
                </div>
              </div>
              <div class="small" style="margin-top:4px">${escDesc}</div>
              <div class="small" style="margin-top:4px">é“¾æ¥: <span class="mono">${escLink}</span></div>
            </div>
          </div>
        </div>
      `;
      }).join("");
      
      document.querySelectorAll("[data-edit-carousel]").forEach(btn=>{
        btn.addEventListener("click", ()=> editCarouselSlide(Number(btn.dataset.editCarousel)));
      });
      document.querySelectorAll("[data-del-carousel]").forEach(btn=>{
        btn.addEventListener("click", async ()=>{
          if(!confirm("ç¡®å®šåˆ é™¤æ­¤è½®æ’­ï¼Ÿ")) return;
          _carouselData.splice(Number(btn.dataset.delCarousel), 1);
          await saveCarousel();
        });
      });
    }
    
    function editCarouselSlide(idx){
      const rawSlide = idx >= 0 ? _carouselData[idx] : { title: "", description: "", image: "", link: "", bg: "linear-gradient(135deg,#7c83fd,#ff6b9d)" };
      // Normalize: prefer 'description' field, fall back to legacy 'sub' field
      const slide = {
        ...rawSlide,
        description: rawSlide.description || rawSlide.sub || ""
      };
      const isEdit = idx >= 0;
      
      // Create inline form in the carousel list
      const formHtml = `
        <div class="card" style="margin-bottom:10px;padding:14px;border:2px solid var(--primary)">
          <h4 style="margin:0 0 10px">${isEdit ? 'ç¼–è¾‘è½®æ’­å›¾' : 'æ–°å¢è½®æ’­å›¾'}</h4>
          <div style="display:flex;flex-direction:column;gap:10px">
            <label class="small">
              æ ‡é¢˜ *
              <input id="carouselTitle" value="${escapeHtml(slide.title||'')}" style="width:100%;margin-top:4px" required/>
            </label>
            <label class="small">
              æè¿°ï¼ˆå‰¯æ ‡é¢˜ï¼‰
              <input id="carouselDescription" value="${escapeHtml(slide.description||'')}" style="width:100%;margin-top:4px"/>
            </label>
            <label class="small">
              å›¾ç‰‡ URLï¼ˆå¯é€‰ï¼Œç•™ç©ºåˆ™ä½¿ç”¨æ¸å˜èƒŒæ™¯ï¼‰
              <input id="carouselImage" value="${escapeHtml(slide.image||'')}" style="width:100%;margin-top:4px" placeholder="https://example.com/image.jpg"/>
            </label>
            <label class="small">
              èƒŒæ™¯æ¸å˜ï¼ˆå›¾ç‰‡ä¸ºç©ºæ—¶ä½¿ç”¨ï¼‰
              <input id="carouselBg" value="${escapeHtml(slide.bg||'linear-gradient(135deg,#7c83fd,#ff6b9d)')}" style="width:100%;margin-top:4px"/>
            </label>
            <label class="small">
              é“¾æ¥ URLï¼ˆå¯é€‰ï¼‰
              <input id="carouselLink" value="${escapeHtml(slide.link||'')}" style="width:100%;margin-top:4px" placeholder="/view/mbti/"/>
            </label>
            <div style="margin-top:4px">
              <div class="small" style="margin-bottom:6px">é¢„è§ˆï¼ˆ2.4:1 æ¯”ä¾‹ï¼‰</div>
              <div id="carouselPreview" style="aspect-ratio:2.4/1;border-radius:12px;background:${escapeHtml(slide.bg||'linear-gradient(135deg,#7c83fd,#ff6b9d)')};display:flex;align-items:center;justify-content:center;padding:20px;color:#fff;position:relative;overflow:hidden">
                ${slide.image ? `<img src="${escapeHtml(slide.image)}" style="position:absolute;inset:0;width:100%;height:100%;object-fit:cover" onerror="this.style.display='none'"/>` : ''}
                <div style="position:relative;z-index:2;text-align:center">
                  <h3 style="margin:0 0 4px;text-shadow:0 2px 8px rgba(0,0,0,.2)">${escapeHtml(slide.title||'æ ‡é¢˜é¢„è§ˆ')}</h3>
                  <p style="margin:0;opacity:0.9;font-size:14px">${escapeHtml(slide.description||slide.sub||'æè¿°é¢„è§ˆ')}</p>
                </div>
              </div>
            </div>
          </div>
          <div class="row" style="margin-top:12px;gap:10px">
            <button class="btn btn-primary" id="saveCarouselForm">ä¿å­˜</button>
            <button class="btn btn-ghost" id="cancelCarouselForm">å–æ¶ˆ</button>
          </div>
        </div>
      `;
      
      // Insert form before the carousel list or at the top
      const list = $("#carouselList");
      const tempDiv = document.createElement('div');
      tempDiv.innerHTML = formHtml;
      list.insertBefore(tempDiv.firstElementChild, list.firstElementChild);
      
      // Setup preview updates
      const updatePreview = () => {
        const title = $("#carouselTitle").value || 'æ ‡é¢˜é¢„è§ˆ';
        const desc = $("#carouselDescription").value || 'æè¿°é¢„è§ˆ';
        const image = $("#carouselImage").value;
        const bg = $("#carouselBg").value || 'linear-gradient(135deg,#7c83fd,#ff6b9d)';
        
        $("#carouselPreview").style.background = bg;
        $("#carouselPreview").innerHTML = `
          ${image ? `<img src="${escapeHtml(image)}" style="position:absolute;inset:0;width:100%;height:100%;object-fit:cover" onerror="this.style.display='none'"/>` : ''}
          <div style="position:relative;z-index:2;text-align:center">
            <h3 style="margin:0 0 4px;text-shadow:0 2px 8px rgba(0,0,0,.2)">${escapeHtml(title)}</h3>
            <p style="margin:0;opacity:0.9;font-size:14px">${escapeHtml(desc)}</p>
          </div>
        `;
      };
      
      ["#carouselTitle", "#carouselDescription", "#carouselImage", "#carouselBg"].forEach(id => {
        $(id)?.addEventListener("input", updatePreview);
      });
      
      $("#saveCarouselForm").addEventListener("click", async () => {
        const descValue = $("#carouselDescription").value || "";
        const newSlide = {
          title: $("#carouselTitle").value || "",
          description: descValue,
          sub: descValue, // Legacy field for backward compatibility - TODO: migrate frontend to use 'description'
          image: $("#carouselImage").value || "",
          bg: $("#carouselBg").value || "linear-gradient(135deg,#7c83fd,#ff6b9d)",
          link: $("#carouselLink").value || ""
        };
        
        if(!newSlide.title){
          toast("è¯·è¾“å…¥æ ‡é¢˜");
          return;
        }
        
        if(isEdit){
          _carouselData[idx] = newSlide;
        } else {
          _carouselData.push(newSlide);
        }
        
        await saveCarousel();
      });
      
      $("#cancelCarouselForm").addEventListener("click", () => {
        renderCarousel();
      });
    }
    
    async function saveCarousel(){
      try{
        await call("updateCarousel", { carousel: _carouselData });
        toast("è½®æ’­å·²ä¿å­˜");
        renderCarousel();
      }catch(e){ toast(e.error || "ä¿å­˜å¤±è´¥"); }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // Featured Content Management
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    let _featuredData = {};
    let _allTests = [];
    
    async function loadFeaturedContent(){
      try{
        const [featRes, testRes] = await Promise.all([
          call("getFeaturedContent"),
          call("listTests")
        ]);
        _featuredData = featRes.featured || {
          hot: { enabled: true, title: 'ğŸ”¥ çƒ­é—¨æ¨è', items: [] },
          new: { enabled: true, title: 'ğŸ†• æœ€æ–°ä¸Šçº¿', items: [] },
          recommended: { enabled: true, title: 'â­ ç¼–è¾‘æ¨è', items: [] }
        };
        _allTests = testRes.tests || [];
        renderFeaturedContent();
      }catch(e){ 
        $("#featuredContentList").innerHTML = `<div class="small">åŠ è½½å¤±è´¥</div>`;
      }
    }
    
    function renderFeaturedContent(){
      const list = $("#featuredContentList");
      const sections = [
        { key: 'hot', title: 'ğŸ”¥ çƒ­é—¨æ¨è' },
        { key: 'new', title: 'ğŸ†• æœ€æ–°ä¸Šçº¿' },
        { key: 'recommended', title: 'â­ ç¼–è¾‘æ¨è' }
      ];
      
      list.innerHTML = sections.map(sec => {
        const section = _featuredData[sec.key] || { enabled: true, title: sec.title, items: [] };
        const itemsHtml = (section.items || []).map((item, idx) => {
          const itemData = typeof item === 'string' ? { testId: item } : item;
          const testInfo = _allTests.find(t => t.id === itemData.testId);
          return `
            <div class="card" style="margin-bottom:8px;padding:10px">
              <div class="row" style="justify-content:space-between">
                <div style="flex:1">
                  <b>${escapeHtml(itemData.customTitle || (testInfo ? testInfo.title : itemData.testId))}</b>
                  ${itemData.briefIntro ? `<div class="small">${escapeHtml(itemData.briefIntro)}</div>` : ''}
                  ${itemData.leadQuestion ? `<div class="small" style="color:var(--accent)">${escapeHtml(itemData.leadQuestion)}</div>` : ''}
                  ${itemData.testedCount ? `<div class="small">${itemData.testedCount} äººæµ‹è¿‡</div>` : ''}
                </div>
                <div class="row">
                  <button class="btn btn-ghost" data-edit-featured="${sec.key}-${idx}" style="padding:4px 8px">ç¼–è¾‘</button>
                  <button class="btn btn-ghost" data-del-featured="${sec.key}-${idx}" style="padding:4px 8px;border-color:rgba(176,0,32,.25)">åˆ é™¤</button>
                </div>
              </div>
            </div>
          `;
        }).join("");
        
        return `
          <div class="card" style="margin-bottom:14px">
            <div class="row" style="justify-content:space-between">
              <h4 style="margin:0">${sec.title}</h4>
              <button class="btn btn-ghost" data-add-featured="${sec.key}" style="padding:4px 8px">æ·»åŠ é¡¹ç›®</button>
            </div>
            <div style="margin-top:10px">
              ${itemsHtml || '<div class="small">æš‚æ— é¡¹ç›®</div>'}
            </div>
          </div>
        `;
      }).join("");
      
      // Bind events
      document.querySelectorAll("[data-add-featured]").forEach(btn => {
        btn.addEventListener("click", () => editFeaturedItem(btn.dataset.addFeatured, -1));
      });
      document.querySelectorAll("[data-edit-featured]").forEach(btn => {
        const [key, idx] = btn.dataset.editFeatured.split("-");
        btn.addEventListener("click", () => editFeaturedItem(key, Number(idx)));
      });
      document.querySelectorAll("[data-del-featured]").forEach(btn => {
        const [key, idx] = btn.dataset.delFeatured.split("-");
        btn.addEventListener("click", async () => {
          if(!confirm("ç¡®å®šåˆ é™¤æ­¤é¡¹ç›®ï¼Ÿ")) return;
          _featuredData[key].items.splice(Number(idx), 1);
          await saveFeaturedContent();
        });
      });
    }
    
    function editFeaturedItem(sectionKey, idx){
      const section = _featuredData[sectionKey];
      const item = idx >= 0 ? section.items[idx] : {};
      const itemData = typeof item === 'string' ? { testId: item } : item;
      
      const testId = prompt("æµ‹è¯•é¡¹ç›® ID:", itemData.testId || "");
      if(testId === null) return;
      
      const customTitle = prompt("è‡ªå®šä¹‰æ ‡é¢˜ï¼ˆç•™ç©ºä½¿ç”¨é»˜è®¤ï¼‰:", itemData.customTitle || "");
      if(customTitle === null) return;
      
      const briefIntro = prompt("ç®€æ˜“ä»‹ç»:", itemData.briefIntro || "");
      if(briefIntro === null) return;
      
      const leadQuestion = prompt("å¼•æµé—®é¢˜:", itemData.leadQuestion || "");
      if(leadQuestion === null) return;
      
      const testedCount = prompt("æµ‹è¯•äººæ•°ï¼ˆæ•°å­—ï¼‰:", itemData.testedCount || "");
      if(testedCount === null) return;
      
      const image = prompt("å›¾ç‰‡ URLï¼ˆç•™ç©ºä½¿ç”¨é»˜è®¤ï¼‰:", itemData.image || "");
      if(image === null) return;
      
      const rawItem = {
        testId,
        customTitle: customTitle || undefined,
        briefIntro: briefIntro || undefined,
        leadQuestion: leadQuestion || undefined,
        testedCount: testedCount ? Number(testedCount) : undefined,
        image: image || undefined
      };
      
      // Remove undefined fields using a cleaner functional approach
      const newItem = Object.fromEntries(
        Object.entries(rawItem).filter(([_, v]) => v !== undefined)
      );
      
      if(idx >= 0){
        section.items[idx] = newItem;
      } else {
        section.items.push(newItem);
      }
      saveFeaturedContent();
    }
    
    async function saveFeaturedContent(){
      try{
        await call("updateFeaturedContent", { featured: _featuredData });
        toast("ç²¾é€‰å†…å®¹å·²ä¿å­˜");
        renderFeaturedContent();
      }catch(e){ toast(e.error || "ä¿å­˜å¤±è´¥"); }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // Category Management
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    let _categoriesData = [];
    
    async function loadCategories(){
      try{
        const j = await call("getCategories");
        _categoriesData = j.categories || [];
        renderCategories();
      }catch(e){ 
        $("#categoriesList").innerHTML = `<div class="small">åŠ è½½å¤±è´¥</div>`;
      }
    }
    
    function renderCategories(){
      const list = $("#categoriesList");
      if(_categoriesData.length === 0){
        list.innerHTML = `<div class="small">æš‚æ— åˆ†ç±»ï¼Œç‚¹å‡»"æ–°å¢åˆ†ç±»"å¼€å§‹</div>`;
        return;
      }
      
      list.innerHTML = _categoriesData.map((cat, idx) => {
        const escId = escapeHtml(cat.id || "");
        const escName = escapeHtml(cat.name || "");
        const escIcon = escapeHtml(cat.icon || "");
        const escImage = escapeHtml(cat.image || "");
        return `
        <div class="card" style="margin-bottom:10px;padding:12px">
          <div class="row" style="justify-content:space-between;align-items:center">
            <div class="row" style="align-items:center;gap:12px">
              ${escImage ? `<img src="${escImage}" alt="${escName}" style="width:60px;height:60px;object-fit:cover;border-radius:8px" onerror="this.style.display='none'"/>` : ''}
              <div>
                <div><b>${escIcon} ${escName}</b></div>
                <div class="small mono">ID: ${escId}</div>
              </div>
            </div>
            <div class="row">
              <button class="btn btn-ghost" data-edit-category="${idx}" style="padding:4px 8px">ç¼–è¾‘</button>
              <button class="btn btn-ghost" data-del-category="${idx}" style="padding:4px 8px;border-color:rgba(176,0,32,.25)">åˆ é™¤</button>
            </div>
          </div>
        </div>
      `;
      }).join("");
      
      document.querySelectorAll("[data-edit-category]").forEach(btn=>{
        btn.addEventListener("click", ()=> editCategory(Number(btn.dataset.editCategory)));
      });
      document.querySelectorAll("[data-del-category]").forEach(btn=>{
        btn.addEventListener("click", async ()=>{
          if(!confirm("ç¡®å®šåˆ é™¤æ­¤åˆ†ç±»ï¼Ÿ")) return;
          _categoriesData.splice(Number(btn.dataset.delCategory), 1);
          await saveCategories();
        });
      });
    }
    
    function editCategory(idx){
      const cat = idx >= 0 ? _categoriesData[idx] : { id: "", name: "", icon: "", image: "" };
      
      let id = cat.id;
      if(idx < 0){
        id = prompt("åˆ†ç±» IDï¼ˆè‹±æ–‡ï¼Œå¦‚ï¼šemotionï¼‰:", id || "");
        if(id === null) return;
        // Enhanced validation: check format, length, and dangerous patterns
        if(!id || 
           id.length > 50 ||
           !/^[a-z0-9_-]+$/.test(id) ||
           id.indexOf('..') !== -1 ||
           id[0] === '.'){
          alert("ID æ ¼å¼ä¸æ­£ç¡®ï¼Œåªèƒ½ä½¿ç”¨å°å†™å­—æ¯ã€æ•°å­—ã€ä¸‹åˆ’çº¿å’Œè¿å­—ç¬¦ï¼Œä¸èƒ½ä»¥ç‚¹å¼€å¤´æˆ–åŒ…å«ä¸¤ä¸ªè¿ç»­çš„ç‚¹");
          return;
        }
        // Check if ID already exists
        if(_categoriesData.some(c => c.id === id)){
          alert("æ­¤ ID å·²å­˜åœ¨");
          return;
        }
      }
      
      const name = prompt("åˆ†ç±»åç§°:", cat.name || "");
      if(name === null) return;
      
      const icon = prompt("åˆ†ç±»å›¾æ ‡ï¼ˆemojiï¼‰:", cat.icon || "");
      if(icon === null) return;
      
      const image = prompt("åˆ†ç±»å›¾ç‰‡ URLï¼ˆå¯é€‰ï¼‰:", cat.image || "");
      if(image === null) return;
      
      const newCat = { id, name, icon, image };
      
      if(idx >= 0){
        _categoriesData[idx] = newCat;
      } else {
        _categoriesData.push(newCat);
      }
      saveCategories();
    }
    
    async function saveCategories(){
      try{
        await call("updateCategories", { categories: _categoriesData });
        toast("åˆ†ç±»å·²ä¿å­˜");
        renderCategories();
      }catch(e){ toast(e.error || "ä¿å­˜å¤±è´¥"); }
    }

    function toast(msg){
      const el = document.createElement("div");
      el.textContent = msg;
      el.style.cssText = "position:fixed;left:50%;top:18px;transform:translateX(-50%);z-index:9999;background:rgba(10,10,10,.85);color:#fff;padding:10px 12px;border-radius:12px;font-size:13px;max-width:92vw";
      document.body.appendChild(el);
      setTimeout(()=>{ el.remove(); }, 1800);
    }

    $("#createBtn")?.addEventListener("click", ()=>createCodes().catch(e=>toast(e.message||e.error||"ç”Ÿæˆå¤±è´¥")));
    $("#refreshBtn")?.addEventListener("click", ()=>refreshAll().catch(e=>toast(e.message||e.error||"åˆ·æ–°å¤±è´¥")));
    $("#destroyExpiredBtn")?.addEventListener("click", ()=>destroyExpired().catch(e=>toast(e.message||e.error||"æ“ä½œå¤±è´¥")));
    $("#saveSiteBtn")?.addEventListener("click", ()=>saveSiteSettings().catch(e=>toast(e.message||e.error||"ä¿å­˜å¤±è´¥")));
    $("#logoutBtn")?.addEventListener("click", ()=>{
      setToken(""); location.href="/XyJoe7/"; });

    // é‡è¡¨ç®¡ç†
    $("#addTestBtn")?.addEventListener("click", ()=>openTestEditor(null));
    $("#downloadTemplateBtn")?.addEventListener("click", ()=>downloadTemplate());
    $("#refreshTestsBtn")?.addEventListener("click", ()=>loadTests().catch(e=>toast(e.message||e.error||"åˆ·æ–°å¤±è´¥")));
    
    // Test editor tabs
    $("#metadataTabBtn")?.addEventListener("click", ()=>{
      $("#metadataFormSection").style.display = "block";
      $("#jsonEditorSection").style.display = "none";
      $("#metadataTabBtn").style.borderBottom = "2px solid var(--primary)";
      $("#jsonTabBtn").style.borderBottom = "none";
    });
    $("#jsonTabBtn")?.addEventListener("click", ()=>{
      $("#metadataFormSection").style.display = "none";
      $("#jsonEditorSection").style.display = "block";
      $("#metadataTabBtn").style.borderBottom = "none";
      $("#jsonTabBtn").style.borderBottom = "2px solid var(--primary)";
    });
    
    // Metadata form handlers
    $("#applyMetadataBtn")?.addEventListener("click", ()=>{
      try {
        // Get current JSON or start with empty object
        let data = {};
        const currentJson = $("#testJsonEditor").value.trim();
        if(currentJson){
          try {
            data = JSON.parse(currentJson);
          } catch(e) {
            // If JSON is invalid, start fresh
            data = {};
          }
        }
        
        // Update from form fields
        data.id = $("#metaId").value.trim();
        data.title = $("#metaTitle").value.trim();
        data.category = $("#metaCategory").value.trim();
        data.intro = $("#metaIntro").value.trim();
        data.estimated = parseInt($("#metaEstimated").value) || 10;
        
        // Tags
        const tagsStr = $("#metaTags").value.trim();
        data.tags = tagsStr ? tagsStr.split(',').map(t => t.trim()).filter(t => t) : [];
        
        // Content object
        if(!data.content) data.content = {};
        
        // Howto - split by newlines and filter empty
        const howtoText = $("#metaHowto").value.trim();
        data.content.howto = howtoText ? howtoText.split('\n').map(l => l.trim()).filter(l => l) : undefined;
        
        // About - split by newlines and filter empty
        const aboutText = $("#metaAbout").value.trim();
        data.content.about = aboutText ? aboutText.split('\n').map(l => l.trim()).filter(l => l) : undefined;
        
        // Remove empty content
        if(data.content && Object.keys(data.content).length === 0){
          delete data.content;
        }
        
        // Update JSON editor
        $("#testJsonEditor").value = JSON.stringify(data, null, 2);
        toast("å…ƒæ•°æ®å·²åº”ç”¨åˆ° JSON");
      } catch(e) {
        toast("åº”ç”¨å¤±è´¥ï¼š" + e.message);
      }
    });
    
    $("#loadFromJsonBtn")?.addEventListener("click", ()=>{
      try {
        const jsonText = $("#testJsonEditor").value.trim();
        if(!jsonText){
          toast("JSON ç¼–è¾‘å™¨ä¸ºç©º");
          return;
        }
        
        const data = JSON.parse(jsonText);
        
        // Populate form fields
        $("#metaId").value = data.id || "";
        $("#metaTitle").value = data.title || "";
        $("#metaCategory").value = data.category || "";
        $("#metaIntro").value = data.intro || "";
        $("#metaTags").value = (data.tags || []).join(", ");
        $("#metaEstimated").value = data.estimated || 10;
        
        // Content fields
        const content = data.content || {};
        $("#metaHowto").value = (content.howto || []).join('\n');
        $("#metaAbout").value = (content.about || []).join('\n');
        
        toast("å·²ä» JSON åŠ è½½åˆ°è¡¨å•");
      } catch(e) {
        toast("åŠ è½½å¤±è´¥ï¼š" + e.message);
      }
    });
    
    $("#closeEditorBtn")?.addEventListener("click", ()=>{ $("#testEditorOverlay").style.display = "none"; });
    $("#saveTestBtn")?.addEventListener("click", ()=>saveTest().catch(e=>toast(e.message||e.error||"ä¿å­˜å¤±è´¥")));
    $("#formatJsonBtn")?.addEventListener("click", ()=>{
      try {
        const jsonText = $("#testJsonEditor").value.trim();
        if (!jsonText) {
          toast("è¯·è¾“å…¥ JSON æ•°æ®");
          return;
        }
        const data = JSON.parse(jsonText);
        $("#testJsonEditor").value = JSON.stringify(data, null, 2);
        toast("JSON å·²æ ¼å¼åŒ–");
      } catch (e) {
        toast("JSON æ ¼å¼é”™è¯¯ï¼š" + e.message);
      }
    });

    // åˆ†é”€ç®¡ç†
    $("#createRefBtn")?.addEventListener("click", ()=>createReferrer().catch(e=>toast(e.message||e.error||"åˆ›å»ºå¤±è´¥")));
    $("#refreshRefBtn")?.addEventListener("click", ()=>loadReferrers().catch(e=>toast(e.message||e.error||"åˆ·æ–°å¤±è´¥")));

    // SEO è®¾ç½®
    $("#saveSeoBtn")?.addEventListener("click", ()=>saveSeoSettings().catch(e=>toast(e.message||e.error||"ä¿å­˜å¤±è´¥")));

    // è½®æ’­å›¾ç®¡ç†
    $("#addCarouselBtn")?.addEventListener("click", ()=>editCarouselSlide(-1));
    $("#refreshCarouselBtn")?.addEventListener("click", ()=>loadCarousel().catch(e=>toast(e.message||e.error||"åˆ·æ–°å¤±è´¥")));

    // ç²¾é€‰å†…å®¹ç®¡ç†
    $("#refreshFeaturedBtn")?.addEventListener("click", ()=>loadFeaturedContent().catch(e=>toast(e.message||e.error||"åˆ·æ–°å¤±è´¥")));

    // åˆ†ç±»ç®¡ç†
    $("#addCategoryBtn")?.addEventListener("click", ()=>editCategory(-1));
    $("#refreshCategoriesBtn")?.addEventListener("click", ()=>loadCategories().catch(e=>toast(e.message||e.error||"åˆ·æ–°å¤±è´¥")));

    // Load ICP info for footer
    async function loadFooterInfo(){
      try{
        const r = await fetch('/api/site_public.php');
        const d = await r.json();
        if(d.ok && d.icp) document.getElementById('icpText').textContent = d.icp;
      }catch(e){}
    }

    // Initialize
    initSidebarNavigation();
    setAuthedUI(true);
    refreshAll().catch(()=>{ location.href="/XyJoe7/"; });
    loadFooterInfo();
  </script>
</body>
</html>
