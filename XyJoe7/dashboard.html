<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>XyJoe7 æ§åˆ¶å°</title>
  <link rel="stylesheet" href="/assets/style.css" />
  <link rel="stylesheet" href="/assets/pages.css" />
  <style>
    .wrap{max-width:1180px;margin:0 auto;padding:24px 16px}
    .login-center{display:flex;justify-content:center;margin:8px 0 14px}
    .login-card{width:min(560px,100%);text-align:center}
    .grid{display:grid;grid-template-columns:1fr;gap:14px;max-width:1080px;margin:0 auto}
    @media (max-width:900px){.grid{grid-template-columns:1fr}}
    .card{border-radius:18px;border:1px solid rgba(0,0,0,.08);background:rgba(255,255,255,.88);padding:14px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    input,select{border-radius:12px;border:1px solid rgba(0,0,0,.12);padding:10px 12px;font-size:14px;outline:none;background:#fff}
    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid rgba(0,0,0,.08);padding:10px 8px;text-align:left;font-size:13px}
    th{font-size:12px;color:var(--muted);font-weight:800}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:999px;border:1px solid rgba(0,0,0,.10);font-size:12px;background:rgba(255,255,255,.8)}
    .danger{color:#b00020}
    .small{color:var(--muted)}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
    .disabled-area{opacity:.58;position:relative;pointer-events:none}
    .disabled-area::after{content:"ç™»å½•åå¯æ“ä½œ";position:absolute;right:12px;top:10px;font-size:12px;color:#7a2f56;background:#fff;border:1px solid rgba(0,0,0,.08);padding:3px 8px;border-radius:999px}
  </style>
</head>
<body>
  <header class="topbar">
    <div class="topbar-inner">
      <a class="brand" href="/"><span class="logo">ğŸ—ï¸</span><span>XyJoe7 æ§åˆ¶å°</span></a>
      <div class="topbar-actions">
        <button class="btn btn-ghost" id="logoutBtn">é€€å‡º</button>
      </div>
    </div>
  </header>

  <main class="wrap">
    <div id="authTip" class="card" style="margin-bottom:12px">
      <b>å®‰å…¨æç¤ºï¼š</b>ä½ å·²ç™»å½•ï¼Œå¯åœ¨ä¸‹æ–¹ç®¡ç†æ¿€æ´»ç ã€ç«™ç‚¹å±•ç¤ºå­—æ®µä¸ç»Ÿè®¡ä»£ç ã€‚
    </div>
    <div class="grid" id="adminGrid" style="display:none">
      <section class="card" id="dashboardCard">
        <div class="row" style="justify-content:space-between">
          <div>
            <h3 style="margin:0 0 6px">æ¿€æ´»ç åˆ—è¡¨</h3>
            <div class="small" id="stats"></div>
          </div>
          <div class="row">
            <input id="q" placeholder="æœç´¢ code..." />
            <button class="btn btn-ghost" id="refreshBtn">åˆ·æ–°</button>
          </div>
        </div>

        <div style="overflow:auto;margin-top:10px">
          <table>
            <thead>
              <tr>
                <th>Code</th>
                <th>çŠ¶æ€</th>
                <th>ä½¿ç”¨</th>
                <th>è¿‡æœŸ</th>
                <th>æ¿€æ´»æœ‰æ•ˆæœŸ</th>
                <th>å¤‡æ³¨</th>
                <th>æ“ä½œ</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>
      </section>
      <section class="card" id="manageBox">
        <h3 style="margin:0 0 10px">æ‰¹é‡ç”Ÿæˆæ¿€æ´»ç </h3>
        <div class="row" style="gap:14px 10px">
          <label class="small" style="flex:1 1 120px">æ•°é‡<br/><input id="count" type="number" min="1" max="500" value="20" style="width:100%"/></label>
          <label class="small" style="flex:1 1 120px">å‰ç¼€<br/><input id="prefix" value="H" style="width:100%"/></label>
          <label class="small" style="flex:1 1 140px">æ¯ç å¯ç”¨æ¬¡æ•°<br/><input id="maxUses" type="number" min="1" value="1" style="width:100%"/></label>
          <label class="small" style="flex:1 1 140px">æ¿€æ´»åæœ‰æ•ˆå¤©æ•°<br/><input id="grantDays" type="number" min="1" value="3" style="width:100%"/></label>
        </div>
        <div class="row" style="gap:14px 10px;margin-top:10px">
          <label class="small" style="flex:1 1 220px">å¤‡æ³¨ï¼ˆå¯é€‰ï¼‰<br/><input id="note" style="width:100%" placeholder="å¦‚ï¼š2æœˆæ´»åŠ¨æ‰¹æ¬¡"/></label>
          <label class="small" style="flex:1 1 220px">ç æœ¬èº«è¿‡æœŸæ—¶é—´ï¼ˆå¯é€‰ï¼‰<br/><input id="expiresAt" type="datetime-local" style="width:100%"/></label>
        </div>
        <div class="row" style="margin-top:10px">
          <button class="btn btn-primary" id="createBtn">ç”Ÿæˆæ¿€æ´»ç </button>
          <button class="btn btn-ghost" id="destroyExpiredBtn">æ¸…ç†å·²è¿‡æœŸæ¿€æ´»ç </button>
        </div>
        <div id="createdBox" class="small" style="margin-top:10px"></div>
      </section>
      <section class="card" id="siteCard" style="display:none;margin-top:14px">
      <h3 style="margin:0 0 10px">ç«™ç‚¹ä¿¡æ¯è®¾ç½®</h3>
      <div class="row" style="gap:14px 10px">
        <label class="small" style="flex:1 1 220px">ç«™ç‚¹åç§°<br/><input id="siteName" style="width:100%"/></label>
        <label class="small" style="flex:1 1 220px">å‰¯æ ‡é¢˜<br/><input id="siteSub" style="width:100%"/></label>
      </div>
      <div class="row" style="gap:14px 10px;margin-top:10px">
        <label class="small" style="flex:1 1 220px">ICPå¤‡æ¡ˆå·<br/><input id="siteIcp" style="width:100%"/></label>
        <label class="small" style="flex:1 1 220px">ç»Ÿè®¡ä»£ç ï¼ˆå¯é€‰ï¼Œæ”¯æŒ script æˆ–çº¯æ–‡æœ¬ï¼‰<br/><textarea id="siteAnalytics" style="width:100%;min-height:88px;border-radius:12px;border:1px solid rgba(0,0,0,.12);padding:10px"></textarea></label>
      </div>
      <div class="row" style="margin-top:10px">
        <button class="btn btn-primary" id="saveSiteBtn">ä¿å­˜ç«™ç‚¹ä¿¡æ¯</button>
      </div>
    </section>

      <!-- â•â•â• è¿è¥æ•°æ®æ±‡æ€» â•â•â• -->
      <section class="card" id="analyticsCard" style="display:none;margin-top:14px">
        <h3 style="margin:0 0 10px">ğŸ“Š å®æ—¶è¿è¥æ•°æ®</h3>
        <div id="analyticsBody" class="small">åŠ è½½ä¸­â€¦</div>
      </section>

      <!-- â•â•â• æ¥æºè¿½è¸ª â•â•â• -->
      <section class="card" id="sourceCard" style="display:none;margin-top:14px">
        <h3 style="margin:0 0 10px">ğŸ“ ç”¨æˆ·æ¥æºè¿½è¸ª</h3>
        <div id="sourceBody" class="small">åŠ è½½ä¸­â€¦</div>
      </section>

      <!-- â•â•â• é‡è¡¨ç®¡ç† â•â•â• -->
      <section class="card" id="testsCard" style="display:none;margin-top:14px">
        <div class="row" style="justify-content:space-between">
          <h3 style="margin:0">ğŸ“ é‡è¡¨ç®¡ç†</h3>
          <div class="row">
            <button class="btn btn-primary" id="addTestBtn">æ–°å¢é‡è¡¨</button>
            <button class="btn btn-ghost" id="refreshTestsBtn">åˆ·æ–°</button>
          </div>
        </div>
        <div style="overflow:auto;margin-top:10px">
          <table>
            <thead><tr><th>ID</th><th>æ ‡é¢˜</th><th>åˆ†ç±»</th><th>é¢˜æ•°</th><th>é¢„è®¡æ—¶é—´</th><th>æ“ä½œ</th></tr></thead>
            <tbody id="testsTbody"></tbody>
          </table>
        </div>
      </section>

      <!-- â•â•â• é‡è¡¨ç¼–è¾‘å¼¹çª— â•â•â• -->
      <div id="testEditorOverlay" style="display:none;position:fixed;inset:0;z-index:9000;background:rgba(0,0,0,.45);overflow-y:auto">
        <div style="max-width:900px;margin:40px auto;padding:20px;background:#fff;border-radius:18px;box-shadow:0 20px 60px rgba(0,0,0,.2)">
          <div class="row" style="justify-content:space-between">
            <h3 style="margin:0" id="editorTitle">ç¼–è¾‘é‡è¡¨</h3>
            <button class="btn btn-ghost" id="closeEditorBtn">å…³é—­</button>
          </div>
          <div style="margin-top:14px">
            <div class="row" style="gap:10px">
              <label class="small" style="flex:1">IDï¼ˆå°å†™å­—æ¯/æ•°å­—/æ¨ªçº¿ï¼‰<br/><input id="testId" style="width:100%" placeholder="ä¾‹: gad7"/></label>
              <label class="small" style="flex:2">æ ‡é¢˜<br/><input id="testTitle" style="width:100%" placeholder="ä¾‹: GAD-7 å¹¿æ³›æ€§ç„¦è™‘è¯„ä¼°"/></label>
            </div>
            <div class="row" style="gap:10px;margin-top:10px">
              <label class="small" style="flex:1">åˆ†ç±»<br/><input id="testCategory" style="width:100%" placeholder="ä¾‹: æƒ…ç»ªé‡è¡¨"/></label>
              <label class="small" style="flex:1">æ ‡ç­¾ï¼ˆé€—å·åˆ†éš”ï¼‰<br/><input id="testTags" style="width:100%" placeholder="ä¾‹: ç„¦è™‘,æƒ…ç»ª"/></label>
              <label class="small" style="flex:1">é¢„è®¡æ—¶é—´ï¼ˆåˆ†é’Ÿï¼‰<br/><input id="testEstimated" type="number" style="width:100%" value="10"/></label>
            </div>
            <label class="small" style="display:block;margin-top:10px">ç®€ä»‹<br/><textarea id="testIntro" style="width:100%;min-height:60px;border-radius:12px;border:1px solid rgba(0,0,0,.12);padding:10px"></textarea></label>
            <label class="small" style="display:block;margin-top:10px">è¯„åˆ†è§„åˆ™ JSON<br/><textarea id="testRule" style="width:100%;min-height:80px;border-radius:12px;border:1px solid rgba(0,0,0,.12);padding:10px;font-family:monospace;font-size:12px"></textarea></label>
            <div style="margin-top:14px">
              <div class="row" style="justify-content:space-between">
                <h4 style="margin:0">é¢˜ç›®åˆ—è¡¨</h4>
                <button class="btn btn-ghost" id="addQuestionBtn">+ æ·»åŠ é¢˜ç›®</button>
              </div>
              <div id="questionsContainer" style="margin-top:10px;max-height:400px;overflow-y:auto"></div>
            </div>
            <div class="row" style="margin-top:14px">
              <button class="btn btn-primary" id="saveTestBtn">ä¿å­˜é‡è¡¨</button>
            </div>
          </div>
        </div>
      </div>

      <!-- â•â•â• åˆ†é”€ç®¡ç† â•â•â• -->
      <section class="card" id="referralCard" style="display:none;margin-top:14px">
        <div class="row" style="justify-content:space-between">
          <h3 style="margin:0">ğŸ”— åˆ†é”€ç®¡ç†</h3>
          <button class="btn btn-ghost" id="refreshRefBtn">åˆ·æ–°</button>
        </div>
        <div class="row" style="gap:10px;margin-top:10px">
          <label class="small" style="flex:1">åˆ†é”€å‘˜åç§°<br/><input id="refName" style="width:100%" placeholder="ä¾‹: å¼ ä¸‰"/></label>
          <label class="small" style="flex:1">ä½£é‡‘æ¯”ä¾‹ (%)<br/><input id="refCommission" type="number" min="0" max="100" value="10" style="width:100%"/></label>
          <label class="small" style="flex:1">å¤‡æ³¨<br/><input id="refNote" style="width:100%"/></label>
          <div style="align-self:flex-end"><button class="btn btn-primary" id="createRefBtn">åˆ›å»ºåˆ†é”€ç </button></div>
        </div>
        <div id="refCreatedBox" class="small" style="margin-top:8px"></div>
        <div style="overflow:auto;margin-top:10px">
          <table>
            <thead><tr><th>åˆ†é”€ç </th><th>åç§°</th><th>ä½£é‡‘</th><th>è®¢å•æ•°</th><th>çŠ¶æ€</th><th>æ“ä½œ</th></tr></thead>
            <tbody id="refTbody"></tbody>
          </table>
        </div>
      </section>

      <!-- â•â•â• SEO è®¾ç½® â•â•â• -->
      <section class="card" id="seoCard" style="display:none;margin-top:14px">
        <h3 style="margin:0 0 10px">ğŸ” SEO ä¼˜åŒ–è®¾ç½®</h3>
        <div class="row" style="gap:14px 10px">
          <label class="small" style="flex:1 1 220px">å…¨å±€æ ‡é¢˜ï¼ˆtitleï¼‰<br/><input id="seoTitle" style="width:100%"/></label>
          <label class="small" style="flex:1 1 220px">å…¨å±€æè¿°ï¼ˆdescriptionï¼‰<br/><textarea id="seoDesc" style="width:100%;min-height:60px;border-radius:12px;border:1px solid rgba(0,0,0,.12);padding:10px"></textarea></label>
        </div>
        <div class="row" style="gap:14px 10px;margin-top:10px">
          <label class="small" style="flex:1 1 220px">å…¨å±€å…³é”®è¯ï¼ˆkeywordsï¼‰<br/><input id="seoKeywords" style="width:100%"/></label>
          <label class="small" style="flex:1 1 220px">OG å›¾ç‰‡ URL<br/><input id="seoOgImage" style="width:100%"/></label>
        </div>
        <div class="row" style="gap:14px 10px;margin-top:10px">
          <label class="small" style="flex:1 1 220px">ç½‘ç«™åŸŸåï¼ˆå« https://ï¼‰<br/><input id="seoCanonical" style="width:100%" placeholder="https://example.com"/></label>
          <label class="small" style="flex:1 1 140px">Sitemap æ›´æ–°é¢‘ç‡<br/>
            <select id="seoFreq" style="width:100%;border-radius:12px;border:1px solid rgba(0,0,0,.12);padding:10px">
              <option value="daily">æ¯å¤©</option>
              <option value="weekly" selected>æ¯å‘¨</option>
              <option value="monthly">æ¯æœˆ</option>
            </select>
          </label>
          <label class="small" style="flex:1 1 160px;display:flex;align-items:center;gap:8px;margin-top:18px">
            <input type="checkbox" id="seoAutoSitemap" checked/> è‡ªåŠ¨ç”Ÿæˆ sitemap.xml
          </label>
        </div>
        <div class="row" style="margin-top:10px">
          <button class="btn btn-primary" id="saveSeoBtn">ä¿å­˜ SEO è®¾ç½®</button>
        </div>
      </section>

  </main>

  <script>
    const API = "/api/admin.php";
    const stKey = "adminToken";
    const $ = (s) => document.querySelector(s);
    const fmt = (ts) => {
      if(!ts) return "-";
      const d = new Date(ts*1000);
      const p = (n)=> String(n).padStart(2,"0");
      return `${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())} ${p(d.getHours())}:${p(d.getMinutes())}`;
    };

    function getToken(){ return localStorage.getItem(stKey) || ""; }
    function setAuthedUI(ok){
      const wrap=document.getElementById("adminGrid");
      const site=document.getElementById("siteCard");
      const box=document.getElementById("dashboardCard");
      const tip=document.getElementById("authTip");
      const manage=document.getElementById("manageBox");
      if(wrap) wrap.style.display = ok ? "grid" : "none";
      if(site) site.style.display = ok ? "block" : "none";
      if(box) box.classList.toggle("disabled-area", !ok);
      if(manage) manage.classList.toggle("disabled-area", !ok);
      if(tip) tip.style.display = "none";
      const logout=document.getElementById("logoutBtn");
      if(logout) logout.style.display = ok ? "" : "none";
      // New sections
      ["analyticsCard","sourceCard","testsCard","referralCard","seoCard"].forEach(id=>{
        const el = document.getElementById(id);
        if(el) el.style.display = ok ? "block" : "none";
      });
    }
    function setToken(t){ if(t) localStorage.setItem(stKey,t); else localStorage.removeItem(stKey); }

    async function call(action, payload={}){
      const body = { action, ...payload };
      if(action !== "login") body.adminToken = getToken();
      const r = await fetch(API, { method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(body) });
      const j = await r.json().catch(()=>({ok:false,error:"bad_json"}));
      if(!j.ok) throw j;
      return j;
    }
    async function createCodes(){
      const count = Number($("#count").value||20);
      const prefix = $("#prefix").value.trim() || "H";
      const maxUses = Number($("#maxUses").value||1);
      const grantDays = Number($("#grantDays").value||3);
      const note = $("#note").value.trim();
      let expiresAt = 0;
      const dt = $("#expiresAt").value;
      if(dt){
        expiresAt = Math.floor(new Date(dt).getTime()/1000);
      }
      const j = await call("createCodes", { count, prefix, maxUses, grantDays, note, expiresAt });
      $("#createdBox").innerHTML = `<div class="pill">å·²ç”Ÿæˆ ${j.created.length} ä¸ª</div>
        <div style="margin-top:8px" class="mono">${j.created.join("<br/>")}</div>`;
      await refreshAll();
    }

    async function refreshAll(){
      if(!getToken()){ location.href="/XyJoe7/"; return; }
      try{
        const s = await call("stats");
        $("#stats").textContent = `æ€»æ•° ${s.stats.total} Â· å·²åœç”¨ ${s.stats.disabled} Â· å·²è¿‡æœŸ ${s.stats.expired} Â· ç”¨å°½ ${s.stats.usedUp} Â· æ´»è·ƒä¼šè¯ ${s.stats.activeSessions}`;
      }catch(e){
        $("#stats").textContent = "æœªç™»å½•æˆ–é…ç½®æœªå®Œæˆ";
      }
      await listCodes();
      await loadSiteSettings();
      await loadAnalytics();
      await loadSourceReport();
      await loadTests();
      await loadReferrers();
      await loadSeoSettings();
    }

    function statusBadge(c){
      const t = Math.floor(Date.now()/1000);
      const exp = Number(c.expiresAt||0);
      const uses = Number(c.uses||0);
      const max = Number(c.maxUses||1);
      if(c.disabled) return `<span class="pill danger">åœç”¨</span>`;
      if(exp && exp < t) return `<span class="pill danger">è¿‡æœŸ</span>`;
      if(uses >= max) return `<span class="pill">ç”¨å°½</span>`;
      return `<span class="pill">å¯ç”¨</span>`;
    }

    async function listCodes(){
      const q = $("#q").value.trim();
      const j = await call("listCodes", { q });
      const rows = j.codes.map(c => {
        const exp = c.expiresAt ? fmt(c.expiresAt) : "æ°¸ä¸è¿‡æœŸ";
        const note = (c.meta && c.meta.note) ? c.meta.note : "-";
        return `
          <tr>
            <td class="mono">${c.code}</td>
            <td>${statusBadge(c)}</td>
            <td>${c.uses||0}/${c.maxUses||1}</td>
            <td>${exp}</td>
            <td>${c.grantDays||3} å¤©</td>
            <td>${note}</td>
            <td class="row">
              <button class="btn btn-ghost" data-toggle="${c.code}" data-disabled="${c.disabled?0:1}">${c.disabled?"å¯ç”¨":"åœç”¨"}</button>
              <button class="btn btn-ghost" data-del="${c.code}" style="border-color:rgba(176,0,32,.25)">åˆ é™¤</button>
            </td>
          </tr>
        `;
      }).join("");
      $("#tbody").innerHTML = rows || `<tr><td colspan="7" class="small">æš‚æ— æ•°æ®</td></tr>`;

      document.querySelectorAll("[data-toggle]").forEach(btn=>{
        btn.addEventListener("click", async ()=>{
          const code = btn.getAttribute("data-toggle");
          const disabled = Number(btn.getAttribute("data-disabled")) === 1;
          await call("toggleCode", { code, disabled });
          await refreshAll();
        });
      });
      document.querySelectorAll("[data-del]").forEach(btn=>{
        btn.addEventListener("click", async ()=>{
          const code = btn.getAttribute("data-del");
          if(!confirm(`ç¡®å®šåˆ é™¤å¹¶é”€æ¯ä¼šè¯ï¼Ÿ\n${code}`)) return;
          await call("deleteCode", { code });
          await refreshAll();
        });
      });
    }

    async function loadSiteSettings(){
      const j = await call("getSiteSettings");
      $("#siteName").value = j.settings.siteName || "";
      $("#siteSub").value = j.settings.siteSub || "";
      $("#siteIcp").value = j.settings.icp || "";
      $("#siteAnalytics").value = j.settings.analyticsCode || "";
    }

    async function saveSiteSettings(){
      await call("updateSiteSettings", {
        siteName: $("#siteName").value,
        siteSub: $("#siteSub").value,
        icp: $("#siteIcp").value,
        analyticsCode: $("#siteAnalytics").value
      });
      toast("ç«™ç‚¹ä¿¡æ¯å·²ä¿å­˜");
    }

async function destroyExpired(){
      const j = await call("destroyExpired");
      toast(`å·²é”€æ¯ ${j.removed} ä¸ªè¿‡æœŸç `);
      await refreshAll();
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // è¿è¥æ•°æ®æ±‡æ€»
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    async function loadAnalytics(){
      try{
        const j = await call("getAnalytics");
        const a = j.analytics;
        const c = a.codes;
        const s = a.sessions;
        const r = a.referrals;
        const tc = a.testCompletions;
        const popular = Object.entries(a.popularTests||{}).map(([k,v])=>`<span class="pill">${k}: ${v}æ¬¡</span>`).join(" ");
        $("#analyticsBody").innerHTML = `
          <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:10px;margin-bottom:12px">
            <div class="pill" style="padding:10px;text-align:center"><b>${c.total}</b><br/>æ¿€æ´»ç æ€»æ•°</div>
            <div class="pill" style="padding:10px;text-align:center"><b>${c.active}</b><br/>å¯ç”¨ç </div>
            <div class="pill" style="padding:10px;text-align:center"><b>${c.totalUses}</b><br/>æ€»ä½¿ç”¨æ¬¡æ•°</div>
            <div class="pill" style="padding:10px;text-align:center"><b>${s.today}</b><br/>ä»Šæ—¥æ–°ä¼šè¯</div>
            <div class="pill" style="padding:10px;text-align:center"><b>${s.week}</b><br/>è¿‘7å¤©ä¼šè¯</div>
            <div class="pill" style="padding:10px;text-align:center"><b>${s.month}</b><br/>è¿‘30å¤©ä¼šè¯</div>
            <div class="pill" style="padding:10px;text-align:center"><b>${s.active}</b><br/>æ´»è·ƒä¼šè¯</div>
            <div class="pill" style="padding:10px;text-align:center"><b>${r.total}</b><br/>åˆ†é”€è®¢å•</div>
            <div class="pill" style="padding:10px;text-align:center"><b>${tc.total}</b><br/>æµ‹è¯„å®Œæˆæ•°</div>
            <div class="pill" style="padding:10px;text-align:center"><b>${tc.today}</b><br/>ä»Šæ—¥å®Œæˆ</div>
          </div>
          ${popular ? `<div><b>çƒ­é—¨æµ‹è¯„ï¼š</b>${popular}</div>` : ""}
        `;
      }catch(e){ $("#analyticsBody").textContent = "åŠ è½½å¤±è´¥"; }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // æ¥æºè¿½è¸ª
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    async function loadSourceReport(){
      try{
        const j = await call("getSourceReport");
        const r = j.sourceReport;
        const srcRows = Object.entries(r.bySource||{}).map(([k,v])=>`<tr><td>${k}</td><td>${v}</td></tr>`).join("");
        const refRows = Object.entries(r.byReferral||{}).map(([k,v])=>`<tr><td class="mono">${k}</td><td>${v}</td></tr>`).join("");
        const utmRows = Object.entries(r.byCampaign||{}).map(([k,v])=>`<tr><td>${k}</td><td>${v}</td></tr>`).join("");
        $("#sourceBody").innerHTML = `
          <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:14px">
            <div>
              <b>æŒ‰æ¥æºæ¸ é“</b>
              <table><thead><tr><th>æ¸ é“</th><th>ä¼šè¯æ•°</th></tr></thead><tbody>${srcRows || '<tr><td colspan="2">æš‚æ— æ•°æ®</td></tr>'}</tbody></table>
            </div>
            <div>
              <b>æŒ‰åˆ†é”€ç </b>
              <table><thead><tr><th>åˆ†é”€ç </th><th>ä¼šè¯æ•°</th></tr></thead><tbody>${refRows || '<tr><td colspan="2">æš‚æ— æ•°æ®</td></tr>'}</tbody></table>
            </div>
            <div>
              <b>æŒ‰ UTM Campaign</b>
              <table><thead><tr><th>Campaign</th><th>ä¼šè¯æ•°</th></tr></thead><tbody>${utmRows || '<tr><td colspan="2">æš‚æ— æ•°æ®</td></tr>'}</tbody></table>
            </div>
          </div>
          <div class="small" style="margin-top:8px">æ€»ä¼šè¯æ•°ï¼š${r.totalSessions}</div>
        `;
      }catch(e){ $("#sourceBody").textContent = "åŠ è½½å¤±è´¥"; }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // é‡è¡¨ç®¡ç†
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    let _editingTestId = null;

    async function loadTests(){
      try{
        const j = await call("listTests");
        const rows = j.tests.map(t => `
          <tr>
            <td class="mono">${t.id}</td>
            <td>${t.title}</td>
            <td>${t.category}</td>
            <td>${t.questionCount}</td>
            <td>${t.estimated||"-"} åˆ†é’Ÿ</td>
            <td class="row">
              <button class="btn btn-ghost" data-edit-test="${t.id}">ç¼–è¾‘</button>
              <button class="btn btn-ghost" data-del-test="${t.id}" style="border-color:rgba(176,0,32,.25)">åˆ é™¤</button>
            </td>
          </tr>
        `).join("");
        $("#testsTbody").innerHTML = rows || `<tr><td colspan="6" class="small">æš‚æ— é‡è¡¨</td></tr>`;

        document.querySelectorAll("[data-edit-test]").forEach(btn=>{
          btn.addEventListener("click", ()=> openTestEditor(btn.dataset.editTest));
        });
        document.querySelectorAll("[data-del-test]").forEach(btn=>{
          btn.addEventListener("click", async ()=>{
            if(!confirm(`ç¡®å®šåˆ é™¤é‡è¡¨ ${btn.dataset.delTest}ï¼Ÿ`)) return;
            await call("deleteTest", { id: btn.dataset.delTest });
            toast("å·²åˆ é™¤");
            await loadTests();
          });
        });
      }catch(e){ $("#testsTbody").innerHTML = `<tr><td colspan="6" class="small">åŠ è½½å¤±è´¥</td></tr>`; }
    }

    async function openTestEditor(testId){
      _editingTestId = testId;
      if(testId){
        const j = await call("getTest", { id: testId });
        const t = j.test;
        $("#testId").value = t.id || "";
        $("#testId").disabled = true;
        $("#testTitle").value = t.title || "";
        $("#testCategory").value = t.category || "";
        $("#testTags").value = (t.tags||[]).join(", ");
        $("#testEstimated").value = t.estimated || 10;
        $("#testIntro").value = t.intro || "";
        $("#testRule").value = JSON.stringify(t.rule||{}, null, 2);
        renderQuestionsEditor(t.questions || []);
        $("#editorTitle").textContent = "ç¼–è¾‘é‡è¡¨: " + t.id;
      } else {
        $("#testId").value = "";
        $("#testId").disabled = false;
        $("#testTitle").value = "";
        $("#testCategory").value = "";
        $("#testTags").value = "";
        $("#testEstimated").value = 10;
        $("#testIntro").value = "";
        $("#testRule").value = '{"scale":[0,1,2,3,4],"labels":["æ²¡æœ‰","è½»å¾®","ä¸­ç­‰","æ˜æ˜¾","ä¸¥é‡"],"bands":[[0,10,"ä½","å»ºè®®æè¿°"],[11,22,"ä¸­","å»ºè®®æè¿°"],[23,40,"é«˜","å»ºè®®æè¿°"]]}';
        renderQuestionsEditor([]);
        $("#editorTitle").textContent = "æ–°å¢é‡è¡¨";
      }
      $("#testEditorOverlay").style.display = "block";
    }

    function renderQuestionsEditor(questions){
      const container = $("#questionsContainer");
      container.innerHTML = questions.map((q, i) => {
        const opts = (q.opts||[]).map((o,oi)=>`<div class="row" style="gap:4px;margin-top:4px"><input class="q-opt-t" data-qi="${i}" data-oi="${oi}" value="${escapeAttr(o.t||"")}" style="flex:2" placeholder="é€‰é¡¹æ–‡å­—"/><input class="q-opt-v" data-qi="${i}" data-oi="${oi}" type="number" value="${o.v||0}" style="flex:1;max-width:60px" placeholder="åˆ†å€¼"/><button class="btn btn-ghost q-del-opt" data-qi="${i}" data-oi="${oi}" style="padding:4px 8px">Ã—</button></div>`).join("");
        return `<div class="card" style="margin-bottom:8px;padding:10px" data-qi="${i}">
          <div class="row" style="gap:6px">
            <span class="small" style="min-width:30px">#${i+1}</span>
            <input class="q-text" data-qi="${i}" value="${escapeAttr(q.q||"")}" style="flex:1" placeholder="é¢˜ç›®æ–‡æœ¬"/>
            <button class="btn btn-ghost q-del" data-qi="${i}" style="border-color:rgba(176,0,32,.25);padding:4px 8px">åˆ é¢˜</button>
          </div>
          <div class="q-opts-wrap" data-qi="${i}" style="margin-left:36px">${opts}
            <button class="btn btn-ghost q-add-opt" data-qi="${i}" style="margin-top:4px;font-size:11px">+ é€‰é¡¹</button>
          </div>
        </div>`;
      }).join("") || `<div class="small">æš‚æ— é¢˜ç›®ï¼Œç‚¹å‡»"æ·»åŠ é¢˜ç›®"å¼€å§‹</div>`;
      bindQuestionEditorEvents();
    }

    function escapeAttr(s){ return String(s).replace(/"/g, '&quot;').replace(/</g, '&lt;').replace(/>/g, '&gt;'); }

    function collectTestFromEditor(){
      const questions = [];
      document.querySelectorAll("#questionsContainer > .card").forEach(card => {
        const qi = card.dataset.qi;
        const q = card.querySelector(`.q-text[data-qi="${qi}"]`)?.value || "";
        const opts = [];
        card.querySelectorAll(`.q-opt-t[data-qi="${qi}"]`).forEach(optInput => {
          const oi = optInput.dataset.oi;
          const t = optInput.value;
          const v = Number(card.querySelector(`.q-opt-v[data-qi="${qi}"][data-oi="${oi}"]`)?.value || 0);
          opts.push({ t, v });
        });
        questions.push({ q, opts });
      });

      let rule = {};
      try { rule = JSON.parse($("#testRule").value || "{}"); } catch(e) { toast("è¯„åˆ†è§„åˆ™ JSON æ ¼å¼é”™è¯¯"); return null; }

      return {
        id: $("#testId").value.trim(),
        title: $("#testTitle").value.trim(),
        category: $("#testCategory").value.trim(),
        tags: $("#testTags").value.split(",").map(s=>s.trim()).filter(Boolean),
        intro: $("#testIntro").value.trim(),
        estimated: Number($("#testEstimated").value) || 10,
        mode: "score",
        rule,
        questions,
      };
    }

    function bindQuestionEditorEvents(){
      document.querySelectorAll(".q-del").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const data = collectTestFromEditor();
          if(!data) return;
          data.questions.splice(Number(btn.dataset.qi), 1);
          renderQuestionsEditor(data.questions);
        });
      });
      document.querySelectorAll(".q-del-opt").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const data = collectTestFromEditor();
          if(!data) return;
          data.questions[Number(btn.dataset.qi)].opts.splice(Number(btn.dataset.oi), 1);
          renderQuestionsEditor(data.questions);
        });
      });
      document.querySelectorAll(".q-add-opt").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const data = collectTestFromEditor();
          if(!data) return;
          data.questions[Number(btn.dataset.qi)].opts.push({ t: "", v: 0 });
          renderQuestionsEditor(data.questions);
        });
      });
    }

    async function saveTest(){
      const data = collectTestFromEditor();
      if(!data) return;
      if(!data.id || !data.title){ toast("è¯·å¡«å†™ ID å’Œæ ‡é¢˜"); return; }
      try{
        if(_editingTestId){
          await call("updateTest", { id: _editingTestId, test: data });
          toast("é‡è¡¨å·²æ›´æ–°");
        } else {
          await call("addTest", { test: data });
          toast("é‡è¡¨å·²æ·»åŠ ");
        }
        $("#testEditorOverlay").style.display = "none";
        await loadTests();
      }catch(e){ toast(e.error || "ä¿å­˜å¤±è´¥"); }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // åˆ†é”€ç®¡ç†
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    async function loadReferrers(){
      try{
        const j = await call("listReferrers");
        const rows = j.referrers.map(r => `
          <tr>
            <td class="mono">${r.code}</td>
            <td>${r.name}</td>
            <td>${r.commissionPct}%</td>
            <td>${r.totalOrders||0}</td>
            <td>${r.disabled ? '<span class="pill danger">åœç”¨</span>' : '<span class="pill">æ´»è·ƒ</span>'}</td>
            <td class="row">
              <button class="btn btn-ghost" data-toggle-ref="${r.code}" data-disabled="${r.disabled?0:1}">${r.disabled?"å¯ç”¨":"åœç”¨"}</button>
              <button class="btn btn-ghost" data-del-ref="${r.code}" style="border-color:rgba(176,0,32,.25)">åˆ é™¤</button>
            </td>
          </tr>
        `).join("");
        $("#refTbody").innerHTML = rows || `<tr><td colspan="6" class="small">æš‚æ— åˆ†é”€å‘˜</td></tr>`;

        document.querySelectorAll("[data-toggle-ref]").forEach(btn=>{
          btn.addEventListener("click", async ()=>{
            await call("toggleReferrer", { code: btn.dataset.toggleRef, disabled: Number(btn.dataset.disabled)===1 });
            await loadReferrers();
          });
        });
        document.querySelectorAll("[data-del-ref]").forEach(btn=>{
          btn.addEventListener("click", async ()=>{
            if(!confirm(`ç¡®å®šåˆ é™¤åˆ†é”€ç  ${btn.dataset.delRef}ï¼Ÿ`)) return;
            await call("deleteReferrer", { code: btn.dataset.delRef });
            toast("å·²åˆ é™¤");
            await loadReferrers();
          });
        });
      }catch(e){ $("#refTbody").innerHTML = `<tr><td colspan="6" class="small">åŠ è½½å¤±è´¥</td></tr>`; }
    }

    async function createReferrer(){
      const name = $("#refName").value.trim();
      if(!name){ toast("è¯·å¡«å†™åç§°"); return; }
      const j = await call("createReferrer", {
        name,
        commissionPct: Number($("#refCommission").value) || 10,
        note: $("#refNote").value.trim(),
      });
      const refUrl = `${location.origin}/code?ref=${j.referralCode}`;
      $("#refCreatedBox").innerHTML = `<div class="pill">å·²åˆ›å»º: <span class="mono">${j.referralCode}</span></div>
        <div style="margin-top:4px">åˆ†é”€é“¾æ¥: <code class="mono" style="font-size:11px">${refUrl}</code></div>`;
      await loadReferrers();
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // SEO è®¾ç½®
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    async function loadSeoSettings(){
      try{
        const j = await call("getSeoSettings");
        const s = j.seo;
        $("#seoTitle").value = s.globalTitle || "";
        $("#seoDesc").value = s.globalDescription || "";
        $("#seoKeywords").value = s.globalKeywords || "";
        $("#seoOgImage").value = s.ogImage || "";
        $("#seoCanonical").value = s.canonical || "";
        $("#seoFreq").value = s.sitemapFreq || "weekly";
        $("#seoAutoSitemap").checked = s.autoSitemap !== false;
      }catch(e){}
    }

    async function saveSeoSettings(){
      await call("updateSeoSettings", {
        globalTitle: $("#seoTitle").value,
        globalDescription: $("#seoDesc").value,
        globalKeywords: $("#seoKeywords").value,
        ogImage: $("#seoOgImage").value,
        canonical: $("#seoCanonical").value,
        sitemapFreq: $("#seoFreq").value,
        autoSitemap: $("#seoAutoSitemap").checked,
      });
      toast("SEO è®¾ç½®å·²ä¿å­˜");
    }

    function toast(msg){
      const el = document.createElement("div");
      el.textContent = msg;
      el.style.cssText = "position:fixed;left:50%;top:18px;transform:translateX(-50%);z-index:9999;background:rgba(10,10,10,.85);color:#fff;padding:10px 12px;border-radius:12px;font-size:13px;max-width:92vw";
      document.body.appendChild(el);
      setTimeout(()=>{ el.remove(); }, 1800);
    }

    $("#createBtn")?.addEventListener("click", ()=>createCodes().catch(e=>toast(e.message||e.error||"ç”Ÿæˆå¤±è´¥")));
    $("#refreshBtn")?.addEventListener("click", ()=>refreshAll().catch(e=>toast(e.message||e.error||"åˆ·æ–°å¤±è´¥")));
    $("#destroyExpiredBtn")?.addEventListener("click", ()=>destroyExpired().catch(e=>toast(e.message||e.error||"æ“ä½œå¤±è´¥")));
    $("#saveSiteBtn")?.addEventListener("click", ()=>saveSiteSettings().catch(e=>toast(e.message||e.error||"ä¿å­˜å¤±è´¥")));
    $("#logoutBtn")?.addEventListener("click", ()=>{
      setToken(""); location.href="/XyJoe7/"; });

    // é‡è¡¨ç®¡ç†
    $("#addTestBtn")?.addEventListener("click", ()=>openTestEditor(null));
    $("#refreshTestsBtn")?.addEventListener("click", ()=>loadTests().catch(e=>toast(e.message||e.error||"åˆ·æ–°å¤±è´¥")));
    $("#closeEditorBtn")?.addEventListener("click", ()=>{ $("#testEditorOverlay").style.display = "none"; });
    $("#saveTestBtn")?.addEventListener("click", ()=>saveTest().catch(e=>toast(e.message||e.error||"ä¿å­˜å¤±è´¥")));
    $("#addQuestionBtn")?.addEventListener("click", ()=>{
      const data = collectTestFromEditor();
      if(!data) return;
      data.questions.push({ q: "", opts: [{ t: "é€‰é¡¹A", v: 0 },{ t: "é€‰é¡¹B", v: 1 }] });
      renderQuestionsEditor(data.questions);
    });

    // åˆ†é”€ç®¡ç†
    $("#createRefBtn")?.addEventListener("click", ()=>createReferrer().catch(e=>toast(e.message||e.error||"åˆ›å»ºå¤±è´¥")));
    $("#refreshRefBtn")?.addEventListener("click", ()=>loadReferrers().catch(e=>toast(e.message||e.error||"åˆ·æ–°å¤±è´¥")));

    // SEO è®¾ç½®
    $("#saveSeoBtn")?.addEventListener("click", ()=>saveSeoSettings().catch(e=>toast(e.message||e.error||"ä¿å­˜å¤±è´¥")));

    // auto refresh
    setAuthedUI(true);
    refreshAll().catch(()=>{ location.href="/XyJoe7/"; });
  </script>
</body>
</html>
